"use strict";(self.webpackChunkfirefox_ecosystem_platform=self.webpackChunkfirefox_ecosystem_platform||[]).push([[5979],{68959:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>o,contentTitle:()=>i,default:()=>d,frontMatter:()=>s,metadata:()=>l,toc:()=>p});var n=a(87462),r=(a(67294),a(3905));a(8209);const s={title:"Node Style Guide"},i=void 0,l={unversionedId:"reference/style-guides/node-style-guide",id:"reference/style-guides/node-style-guide",title:"Node Style Guide",description:"Current as of January 18, 2023",source:"@site/docs/reference/style-guides/node-style-guide.md",sourceDirName:"reference/style-guides",slug:"/reference/style-guides/node-style-guide",permalink:"/ecosystem-platform/reference/style-guides/node-style-guide",draft:!1,editUrl:"https://github.com/mozilla/ecosystem-platform/edit/master/docs/reference/style-guides/node-style-guide.md",tags:[],version:"current",frontMatter:{title:"Node Style Guide"},sidebar:"docs",previous:{title:"Pull Request review guidelines",permalink:"/ecosystem-platform/reference/team-processes/pull-request-review-guidelines"},next:{title:"React Style Guide",permalink:"/ecosystem-platform/reference/style-guides/react-style-guide"}},o={},p=[{value:"Code Standards",id:"code-standards",level:2},{value:"Style",id:"style",level:3},{value:"Structure",id:"structure",level:3},{value:"Software Architecture",id:"software-architecture",level:4},{value:"Organize by Feature",id:"organize-by-feature",level:4},{value:"NestJS File Naming Conventions",id:"nestjs-file-naming-conventions",level:4},{value:"File Naming for Class",id:"file-naming-for-class",level:5},{value:"Interface and Abstract Naming",id:"interface-and-abstract-naming",level:4},{value:"Index Exporting",id:"index-exporting",level:4},{value:"TypeScript",id:"typescript",level:3},{value:"Tests",id:"tests",level:4},{value:"Never use Type Asserts",id:"never-use-type-asserts",level:4},{value:"Use <code>satisfies</code>",id:"use-satisfies",level:4},{value:"Legacy Code Packages",id:"legacy-code-packages",level:2},{value:"Style",id:"style-1",level:3},{value:"Structure",id:"structure-1",level:3},{value:"Async/Await",id:"asyncawait",level:3},{value:"TypeScript",id:"typescript-1",level:3}],c={toc:p};function d(e){let{components:t,...a}=e;return(0,r.kt)("wrapper",(0,n.Z)({},c,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"Current as of ",(0,r.kt)("inlineCode",{parentName:"p"},"January 18, 2023")),(0,r.kt)("h2",{id:"code-standards"},"Code Standards"),(0,r.kt)("p",null,"These code standards apply to new packages in the FxA monorepo, such as:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"packages/fxa-graphql-api")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"packages/fxa-event-broker"))),(0,r.kt)("p",null,"Most of the standards in the code is enforced with ",(0,r.kt)("a",{parentName:"p",href:"https://prettier.io/"},"Prettier")," and ",(0,r.kt)("a",{parentName:"p",href:"https://eslint.org/"},"ESLint"),"."),(0,r.kt)("h3",{id:"style"},"Style"),(0,r.kt)("p",null,"We use the ",(0,r.kt)("a",{parentName:"p",href:"https://google.github.io/styleguide/tsguide.html#source-organization"},"Google TypeScript Style Guide")," for our base code style."),(0,r.kt)("p",null,"Code should also follow the ",(0,r.kt)("a",{parentName:"p",href:"https://www.typescriptlang.org/docs/handbook/declaration-files/do-s-and-don-ts.html"},"Do's and Don'ts of TypeScript"),"."),(0,r.kt)("h3",{id:"structure"},"Structure"),(0,r.kt)("h4",{id:"software-architecture"},"Software Architecture"),(0,r.kt)("p",null,"The FxA repository uses ",(0,r.kt)("a",{parentName:"p",href:"https://nx.dev/"},"Nx")," to manage its monorepo, with a hybrid structure of legacy ",(0,r.kt)("a",{parentName:"p",href:"https://nx.dev/concepts/integrated-vs-package-based#package-based-repos"},"package-based repos")," while new applications and libraries are handled as if part of an ",(0,r.kt)("a",{parentName:"p",href:"https://nx.dev/concepts/integrated-vs-package-based#integrated-repos"},"integrated repo"),". New libraries and applications should use a layered architecture separating domain logic from data access, keeping these libraries separate from application specific presentation logic (see ",(0,r.kt)("a",{parentName:"p",href:"https://martinfowler.com/bliki/PresentationDomainDataLayering.html"},"PresentationDomainDataLayering")," for additional background)."),(0,r.kt)("p",null,"From ",(0,r.kt)("strong",{parentName:"p"},"bottom-up"),", these layers should approximately map to:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Data Access - Database query code and types, Redis client/functions, Paypal client, Firestore client, etc. (following a ",(0,r.kt)("a",{parentName:"li",href:"https://martinfowler.com/eaaCatalog/repository.html"},"Repository")," style pattern)."),(0,r.kt)("li",{parentName:"ul"},"Data Mapper - Domain/Feature specific logic around the Data Access layer, enforcing domain specific logic that returns its own types and errors, separating domain object logic from the underlying data store and access. These typically appear in the code-base as ",(0,r.kt)("inlineCode",{parentName:"li"},"*Manager")," classes."),(0,r.kt)("li",{parentName:"ul"},"Domain Objects - Higher level business logic around a specific domain, they may utilize multiple data mappers or other domain objects. An example of a domain object would be a class that handles business logic about a customers subscription or is responsibile for loading, saving, and deleting accounts."),(0,r.kt)("li",{parentName:"ul"},"Services - NestJS specific Service classes that orchestrate multiple domain objects for a given domain/feature. An example would be an account service utilizing the account domain object, as well as other domain objects to trigger relying party notifications around account actions, sending email regarding an account state change, etc. Services will frequently be assembled in a heirarchy and require other services to perform their function.")),(0,r.kt)("h4",{id:"organize-by-feature"},"Organize by Feature"),(0,r.kt)("p",null,"(This is ",(0,r.kt)("a",{parentName:"p",href:"https://google.github.io/styleguide/tsguide.html#organize-by-feature"},"present in the Google TypeScript Style Guide"),", but bears repeating)"),(0,r.kt)("p",null,"Code should be organized by feature, not by type."),(0,r.kt)("p",null,"Don't:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"app/\n\u251c\u2500\u2500 controllers/\n\u2502   \u2514\u2500\u2500 auth.ts\n\u251c\u2500\u2500 models/\n\u2502   \u2514\u2500\u2500 auth.ts\n\u251c\u2500\u2500 validators/\n\u2502   \u2514\u2500\u2500 auth.ts\n")),(0,r.kt)("p",null,"Do:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"app/\n\u251c\u2500\u2500 auth/\n\u2502   \u251c\u2500\u2500 auth.controller.ts\n\u2502   \u251c\u2500\u2500 auth.model.ts\n\u2502   \u2514\u2500\u2500 auth.validator.ts\n")),(0,r.kt)("p",null,"If a feature has many DTOs, models, etc., a hybrid approach may be used, organized by feature first:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"app/\n\u251c\u2500\u2500 auth/\n\u2502   \u251c\u2500\u2500 dto/\n\u2502   \u251c\u2500\u2500 model/\n\u2502   |   \u2514\u2500\u2500 auth.model.ts\n\u2502   \u251c\u2500\u2500 auth.controller.ts\n\u2502   \u2514\u2500\u2500 auth.validator.ts\n")),(0,r.kt)("p",null,"Tests should be organized alongside the code being tested, with the ",(0,r.kt)("inlineCode",{parentName:"p"},".spec.ts")," suffix or ",(0,r.kt)("inlineCode",{parentName:"p"},".in.spec.ts")," for integration tests:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"app/\n\u251c\u2500\u2500 auth/\n\u2502   \u251c\u2500\u2500 auth.controller.ts\n\u2502   \u251c\u2500\u2500 auth.controller.spec.ts\n\u2502   \u251c\u2500\u2500 auth.controller.in.spec.ts\n")),(0,r.kt)("h4",{id:"nestjs-file-naming-conventions"},"NestJS File Naming Conventions"),(0,r.kt)("h5",{id:"file-naming-for-class"},"File Naming for Class"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"export class PascalCaseSuffix {} //= pascal-case.suffix.ts\n// Except for suffix, PascalCase to hyphen-case\nclass FooBarNaming {} //= foo-bar.naming.ts\nclass FooController {} //= foo.controller.ts\n// These are both DTO's, which the package namespace should reflect rather than\n// adding DTO to every class name and file name.\nclass BarQueryInput {} //= dto/bar-query.input.ts\nclass BarResultPayload {} //= dto/bar-result.payload.ts\n\nabstract class BaseAccount {} //= baseAccount.ts\n")),(0,r.kt)("h4",{id:"interface-and-abstract-naming"},"Interface and Abstract Naming"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Avoid prefixing with ",(0,r.kt)("inlineCode",{parentName:"li"},"I")," or ",(0,r.kt)("inlineCode",{parentName:"li"},"Interface"),", as this impacts readability and the type of object is separate from the name."),(0,r.kt)("li",{parentName:"ul"},"Don't include ",(0,r.kt)("inlineCode",{parentName:"li"},"Abstract")," in the name of abstract classes, as this is the type. Prefer ",(0,r.kt)("inlineCode",{parentName:"li"},"Base")," or ",(0,r.kt)("inlineCode",{parentName:"li"},"Default")," prefix.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"interface User {}\ninterface CustomUser extends User {}\ninterface ThirdCustomUser extends CustomUser {}\nabstract class BaseAccount {}\n")),(0,r.kt)("h4",{id:"index-exporting"},"Index Exporting"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"It is recommended to place index.ts in each folder and export. Unless it's a special case, it is imported from a folder instead of directly from a file.")),(0,r.kt)("p",null,"Don't:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { FooController } from './feature/foo.controller';\nimport { BarController } from './feature/bar.controller';\n")),(0,r.kt)("p",null,"Do:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { FooController, BarController } from './feature';\n")),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},"Preferred method is to place only one file or folder name at the end of the path.")),(0,r.kt)("p",null,"Don't:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { UtilService } from '../common/providers/util.service';\n")),(0,r.kt)("p",null,"Do:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { UtilService } from '../common';\n")),(0,r.kt)("h3",{id:"typescript"},"TypeScript"),(0,r.kt)("h4",{id:"tests"},"Tests"),(0,r.kt)("p",null,"All tests should be written in TypeScript. Tests should utilize factory functions to generate objects for testing. Generating additional fake data for factory functions can be done with the ",(0,r.kt)("inlineCode",{parentName:"p"},"faker")," library."),(0,r.kt)("p",null,"Example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { faker } from '@faker-js/faker';\n\ninterface User {\n  id: string;\n  name: string;\n  email: string;\n}\n\nconst UserFactory = (override: Partial<User>): User => ({\n  id: faker.datatype.uuid(),\n  name: faker.person.fullName(),\n  email: faker.internet.email(),\n  ...override,\n});\n")),(0,r.kt)("h4",{id:"never-use-type-asserts"},"Never use Type Asserts"),(0,r.kt)("p",null,"Type asserts should not be used in any situation. Instead, use one of the following options:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Check if the variable is null/undefined, and if so throw an error")),(0,r.kt)("p",null,"Do:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"function example(arg?: string) {\n  if (typeof arg !== 'string') {\n    throw new Error('arg is required for example');\n  }\n\n  // arg is now of type 'string'\n}\n")),(0,r.kt)("p",null,"Don't:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"function example(arg?: string) {\n  return arg!.substring(0, 20);\n}\n")),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},"Return early if it matches the desired behavior")),(0,r.kt)("p",null,"Do:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"function example(arg?: string) {\n  if (!arg) return;\n\n  // arg is now of type 'string'\n}\n")),(0,r.kt)("ol",{start:3},(0,r.kt)("li",{parentName:"ol"},"Fallback to a default")),(0,r.kt)("p",null,"Do:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"const DEFAULT_VALUE = 'example';\n\nfunction example(arg?: string) {\n  const argWithDefault = arg || DEFAULT_VALUE;\n\n  // argWithDefault is of type 'string'\n}\n")),(0,r.kt)("ol",{start:4},(0,r.kt)("li",{parentName:"ol"},"Narrow the type with conditions")),(0,r.kt)("p",null,"Do:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"interface MyType {\n  prop: string;\n}\ninterface AnotherType {\n  prop2: string;\n}\nfunction otherFunc(): MyType | AnotherType;\n\nfunction example(): MyType {\n  const result = otherFunc();\n\n  if (!('prop' in result)) throw new Error('result was of an unexpected type');\n\n  // result is now of type MyType\n  return result;\n}\n")),(0,r.kt)("p",null,"Don't:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"function example(): MyType {\n  const result = otherFunc();\n  return result as unknown as MyType;\n}\n")),(0,r.kt)("h4",{id:"use-satisfies"},"Use ",(0,r.kt)("inlineCode",{parentName:"h4"},"satisfies")),(0,r.kt)("p",null,"Prior to TypeScript 4.9, new literal objects could be identified as a type, but would not be narrowed. Our code uses TypeScript 4.9 or greater, so ",(0,r.kt)("a",{parentName:"p",href:"https://www.typescriptlang.org/docs/handbook/release-notes/typescript-4-9.html#the-satisfies-operator"},(0,r.kt)("inlineCode",{parentName:"a"},"satisfies"))," should be preferred."),(0,r.kt)("p",null,"Don't:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},'interface Vibe {\n  mood: \'happy\' | \'sad\';\n}\n\nconst vibe: Vibe = {\n  mood: \'happy\',\n  // (property) Vibe.mood: "happy" | "sad"\n};\n\nvibe.mood;\n// (property) mood: "happy" | "sad"\n')),(0,r.kt)("p",null,"Do:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"interface Vibe {\n  mood: 'happy' | 'sad';\n}\n\nconst vibe = {\n  mood: 'happy',\n  // (property) Vibe.mood: \"happy\" | \"sad\"\n} satisfies Vibe;\n\nvibe.mood;\n// (property) mood: \"happy\"\n")),(0,r.kt)("p",null,"See ",(0,r.kt)("a",{parentName:"p",href:"https://www.learningtypescript.com/articles/the-satisfies-operator"},"additional examples of using ",(0,r.kt)("inlineCode",{parentName:"a"},"satisfies")),"."),(0,r.kt)("h2",{id:"legacy-code-packages"},"Legacy Code Packages"),(0,r.kt)("h3",{id:"style-1"},"Style"),(0,r.kt)("p",null,"Legacy code has no defined style-guide beyond that enforced by ESLint."),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://eslint.org/"},"ESLint")," configuration is provided for each legacy package which enforces its requirements, it will be run by default during ",(0,r.kt)("inlineCode",{parentName:"p"},"git commit"),"."),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://prettier.io/"},"Prettier")," is used to format the code."),(0,r.kt)("h3",{id:"structure-1"},"Structure"),(0,r.kt)("p",null,"A structural convention separates route handling code from library code by prefixing the route handlers with ",(0,r.kt)("inlineCode",{parentName:"p"},"routes"),"."),(0,r.kt)("p",null,"Tests are located in a file hierarchy that mirrors the code being tested, for example a file in a package called:"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"fxa-auth-server/lib/bounces.js")),(0,r.kt)("p",null,"Has a corresponding test at:"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"fxa-auth-server/tests/local/bounces.js")),(0,r.kt)("h3",{id:"asyncawait"},"Async/Await"),(0,r.kt)("p",null,"Some legacy code packages may still have callbacks and/or promises in use. New code should use async/await syntax."),(0,r.kt)("h3",{id:"typescript-1"},"TypeScript"),(0,r.kt)("p",null,"Packages that have TypeScript in them should have all new files created with TypeScript. Legacy code tests are all in JavaScript, and will remain that way until fully deprecated."))}d.isMDXComponent=!0}}]);