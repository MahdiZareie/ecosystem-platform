"use strict";(self.webpackChunkfirefox_ecosystem_platform=self.webpackChunkfirefox_ecosystem_platform||[]).push([[4381],{98445:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>r,default:()=>u,frontMatter:()=>o,metadata:()=>l,toc:()=>p});var i=n(87462),a=(n(67294),n(3905));n(8209);const o={title:"OAuth Details"},r=void 0,l={unversionedId:"reference/oauth-details",id:"reference/oauth-details",title:"OAuth Details",description:"Last updated: April 17, 2023",source:"@site/docs/reference/oauth-details.md",sourceDirName:"reference",slug:"/reference/oauth-details",permalink:"/ecosystem-platform/reference/oauth-details",draft:!1,editUrl:"https://github.com/mozilla/ecosystem-platform/edit/master/docs/reference/oauth-details.md",tags:[],version:"current",frontMatter:{title:"OAuth Details"},sidebar:"docs",previous:{title:"NPM / NX Guidelines",permalink:"/ecosystem-platform/reference/npm-scripts-and-nx"},next:{title:"Rate limiting",permalink:"/ecosystem-platform/reference/rate-limiting"}},s={},p=[{value:"Configuring OAuth clients",id:"configuring-oauth-clients",level:2},{value:"How to register a client manually",id:"how-to-register-a-client-manually",level:3},{value:"Difference between same site and external consumers",id:"difference-between-same-site-and-external-consumers",level:3},{value:"Installing a new consumer",id:"installing-a-new-consumer",level:3},{value:"Creating the client id and secret keys",id:"creating-the-client-id-and-secret-keys",level:4},{value:"OAuth resource server (a.k.a. <code>fxa-oauth-server</code>)",id:"oauth-resource-server-aka-fxa-oauth-server",level:4},{value:"OAuth clients",id:"oauth-clients",level:4},{value:"OAuth Scopes",id:"oauth-scopes",level:2},{value:"Short-name scope values",id:"short-name-scope-values",level:3},{value:"Profile data",id:"profile-data",level:4},{value:"OpenID Connect",id:"openid-connect",level:4},{value:"OAuth Client Management",id:"oauth-client-management",level:4},{value:"Basket",id:"basket",level:4},{value:"URL Scopes",id:"url-scopes",level:3},{value:"Scope Matching and Implication",id:"scope-matching-and-implication",level:3},{value:"Pairwise Pseudonymous Identifiers",id:"pairwise-pseudonymous-identifiers",level:2},{value:"Further enhancing privacy through PPID rotation",id:"further-enhancing-privacy-through-ppid-rotation",level:3},{value:"RP initiated PPID rotation",id:"rp-initiated-ppid-rotation",level:4},{value:"Server initiated PPID rotation",id:"server-initiated-ppid-rotation",level:4},{value:"Ensuring 3rd parties are unable to access user information",id:"ensuring-3rd-parties-are-unable-to-access-user-information",level:3},{value:"PPIDs and logging",id:"ppids-and-logging",level:2},{value:"PPID generation",id:"ppid-generation",level:3},{value:"Server enforced rotation input",id:"server-enforced-rotation-input",level:4},{value:"The future",id:"the-future",level:3},{value:"PKCE Support",id:"pkce-support",level:2},{value:"prompt=none support",id:"promptnone-support",level:2},{value:"prompt=none usage is controlled",id:"promptnone-usage-is-controlled",level:3},{value:"Requesting <code>prompt=none</code> during authorization",id:"requesting-promptnone-during-authorization",level:3},{value:"Handling errors",id:"handling-errors",level:3},{value:"Recovering from errors",id:"recovering-from-errors",level:4},{value:"Handling user logout",id:"handling-user-logout",level:3},{value:"Destroying an access token",id:"destroying-an-access-token",level:4},{value:"Destroying a refresh token",id:"destroying-a-refresh-token",level:4},{value:"SSO logout",id:"sso-logout",level:4},{value:"prompt=none and security",id:"promptnone-and-security",level:3},{value:"Future directions",id:"future-directions",level:3},{value:"Management of JWT Signing Keys",id:"management-of-jwt-signing-keys",level:2}],d={toc:p},c="wrapper";function u(e){let{components:t,...n}=e;return(0,a.kt)(c,(0,i.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"Last updated: ",(0,a.kt)("inlineCode",{parentName:"p"},"April 17, 2023")),(0,a.kt)("h2",{id:"configuring-oauth-clients"},"Configuring OAuth clients"),(0,a.kt)("h3",{id:"how-to-register-a-client-manually"},"How to register a client manually"),(0,a.kt)("p",null,"Usually, when you connect applications to their OAuth resource server, they generate a client ",(0,a.kt)("inlineCode",{parentName:"p"},"id")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"secret")," for you. In our case, we are the resource server."),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"id")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"secret")," keys, in this context, can be seen as a username and password. They do not need to be generated in relation between one and another. In other words, they are not public and private keys."),(0,a.kt)("p",null,"With this procedure you will generate both client id and secret tokens to provide to your other applications and also partners who wants to leverage your identity provider service. Once you have the client id and secret, paste them in both the fxa-oauth-server AND your client service you want to bind using OAuth."),(0,a.kt)("h3",{id:"difference-between-same-site-and-external-consumers"},"Difference between same site and external consumers"),(0,a.kt)("p",null,"While other applications within your infrastructure would ideally be pre-approved at the user point of view, external consumers shouldn't be. This is why when we develop a service leveraging another site, the user gets a confirmation window."),(0,a.kt)("p",null,"If you want to pre-approve your own web applications and prevent users in your accounts userbase to have a confirmation window, set the ",(0,a.kt)("inlineCode",{parentName:"p"},"trusted")," flag to ",(0,a.kt)("inlineCode",{parentName:"p"},"true"),"."),(0,a.kt)("h3",{id:"installing-a-new-consumer"},"Installing a new consumer"),(0,a.kt)("h4",{id:"creating-the-client-id-and-secret-keys"},"Creating the client id and secret keys"),(0,a.kt)("p",null,"Use the ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/mozilla/fxa-oauth-client"},"fxa-oauth-client")," CLI tool for registering new clients with your server."),(0,a.kt)("p",null,"FxA OAuth development environments support ",(0,a.kt)("inlineCode",{parentName:"p"},"localhost")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"localhost")," as valid ",(0,a.kt)("inlineCode",{parentName:"p"},"redirectUri")," values to ease development."),(0,a.kt)("h4",{id:"oauth-resource-server-aka-fxa-oauth-server"},"OAuth resource server (a.k.a. ",(0,a.kt)("inlineCode",{parentName:"h4"},"fxa-oauth-server"),")"),(0,a.kt)("p",null,"Let's assume that the client in this example is the ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/mozilla/123done"},"123done")," web application that you deployed at ",(0,a.kt)("inlineCode",{parentName:"p"},"https://clientapp.example.com")," and that the OAuth route is available at ",(0,a.kt)("inlineCode",{parentName:"p"},"api/oauth")," (this is specific to each client application, beware (!))"),(0,a.kt)("p",null,"Add a new object literal within the ",(0,a.kt)("inlineCode",{parentName:"p"},"clients")," array, that would look like:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},'{\n  "clients": [\n    {\n      "id": "<8-byte client id in hex>",\n      "hashedSecret": "<32-byte sha256 of the client secret in hex>",\n      "name": "123done",\n      "imageUri": "https://clientapp.example.com/static/img/logo100.png",\n      "redirectUri": "https://clientapp.example.com/api/oauth",\n      "trusted": true\n    }\n  ]\n}\n')),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"NOTE:")," the ",(0,a.kt)("inlineCode",{parentName:"p"},"trusted"),", this would be for an internal application that you manage."),(0,a.kt)("h4",{id:"oauth-clients"},"OAuth clients"),(0,a.kt)("p",null,"This can be very different depending on your installed and supported version, you should have a look at the profile server and client application what are the required callbacks."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},'{\n  "client_id": "<8-byte client id in hex>",\n  "client_secret": "<32-byte client secret in hex>",\n  "name": "123done",\n  "redirect_uri": "https://clientapp.example.com/api/oauth",\n  "signin_uri": "https://accounts.firefox.com/oauth/signin",\n  "oauth_uri": "https://oauth.accounts.firefox.com/v1",\n  "profile_uri": "https://profile.firefox.com/v1",\n  "scopes": "profile"\n}\n')),(0,a.kt)("h2",{id:"oauth-scopes"},"OAuth Scopes"),(0,a.kt)("p",null,'Each authorization grant in OAuth has an associated "scope", a list containing one or more "scope values" that indicate what capabilities the granted token will have. Each individual scope value indicates a particular capability, such as the ability to read or write profile data, or to access the user\'s data in a particular service.'),(0,a.kt)("p",null,"As defined in ",(0,a.kt)("a",{parentName:"p",href:"https://tools.ietf.org/html/rfc6749#section-3.3"},"RFC6749 Section 3.3"),", the scope of a token is expressed as a list of space-delimited, case-sensitive strings, and it is left up to the service to define the format and semantics of the individual scope values that make up this string."),(0,a.kt)("p",null,"This document defines the scope values accepted in the Mozilla accounts ecosystem, and the rules for parsing and validating them."),(0,a.kt)("h3",{id:"short-name-scope-values"},"Short-name scope values"),(0,a.kt)("p",null,'FxA supports a small set of "short-name" scope values that are identified by a short English word. These correspond either to scope values defined by external  specifications (e.g. OpenID Connect), or to legacy scope values introduced during early development.'),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"No new short-name scope values should be added."),"\nInstead we prefer to use URLs for new scope values, both to ensure uniqueness and to simplify parsing rules."),(0,a.kt)("p",null,'Short-name scope values imply read-only access by default, with write access indicated by the suffix ":write". The may also have "sub-scopes" to indicate finer-grained access control. Each name component may contain only ascii alphanumeric characters and the underscore.'),(0,a.kt)("p",null,"For example:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"profile")," indicates read-only access to the user's profile data."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"profile:write")," indicates read/write access to the user's profile data."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"profile:display_name")," indicates read-only access to the user's display name, but not any other profile data."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"profile:email:write")," indicates read/write access to the user's email address.")),(0,a.kt)("p",null,"The following short-name scope values are recognized in the FxA ecosystem."),(0,a.kt)("h4",{id:"profile-data"},"Profile data"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"profile"),": access the user's profile data."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"profile:uid"),": access the user's opaque user id."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"profile:email"),": access the user's email address."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"profile:locale"),": access the user's locale."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"profile:avatar"),": access the user's avatar picture."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"profile:display_name"),": access the user's human-readable display name."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"profile:amr"),": access information about the user's authentication methods and 2FA status.")),(0,a.kt)("h4",{id:"openid-connect"},"OpenID Connect"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"openid"),": used to request an OpenID Connect ",(0,a.kt)("inlineCode",{parentName:"li"},"id_token"),"."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"email"),": a synonym for ",(0,a.kt)("inlineCode",{parentName:"li"},"profile:email"),", defined by the OIDC spec.")),(0,a.kt)("h4",{id:"oauth-client-management"},"OAuth Client Management"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"clients"),": access the list of OAuth clients connected to a user's account."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"oauth"),": register a new OAuth client record.")),(0,a.kt)("h4",{id:"basket"},"Basket"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"basket"),": access the user's subscription data in\n",(0,a.kt)("a",{parentName:"li",href:"http://basket.readthedocs.io/"},"basket"))),(0,a.kt)("h3",{id:"url-scopes"},"URL Scopes"),(0,a.kt)("p",null,"For new capabilities, scope values are represented as URLs. This helps to ensure uniqueness and reduces ambiguity in parsing. URL-format scope value imply read/write access by default, are compared as heirarchical resource references, and use the hash fragment for permission qualifiers. For example:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"https://identity.mozilla.com/apps/oldsync")," indicates full access to the user's data in Firefox Sync."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"https://identity.mozilla.com/apps/oldsync/bookmarks")," indicates full access to the user's bookmark data in Firefox Sync, but not to other data types."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"https://identity.mozilla.com/apps/oldsync#read")," indicates read-only access to the user's data in Firefox Sync."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"https://identity.mozilla.com/apps/oldsync/history#write")," indicates write-only access to the user's history data in Firefox Sync.")),(0,a.kt)("p",null,"To be a valid scope value, the URL must:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Be an absolute ",(0,a.kt)("inlineCode",{parentName:"li"},"https://")," URL."),(0,a.kt)("li",{parentName:"ul"},"Have no username, password, or query component."),(0,a.kt)("li",{parentName:"ul"},"If present, have a fragment component consisting only of alphanumeric ascii characters and underscore."),(0,a.kt)("li",{parentName:"ul"},"Remain unchanged when parsed and serialized following the rules in the ",(0,a.kt)("a",{parentName:"li",href:"https://url.spec.whatwg.org"},"WhatWG URL Spec"),".")),(0,a.kt)("p",null,"The following URL scope values are currently recognized by FxA:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"https://identity.mozilla.com/apps/oldsync"),": access to data in Firefox Sync."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"https://identity.mozilla.com/apps/notes"),": access to data in Firefox Notes."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"https://identity.mozilla.com/account/subscriptions"),": access to subscription data from Subscription Platform.")),(0,a.kt)("h3",{id:"scope-matching-and-implication"},"Scope Matching and Implication"),(0,a.kt)("p",null,"We say that a scope value A ",(0,a.kt)("em",{parentName:"p"},"implies")," another scope value B if they are exactly equal, or if A represents a more general capability than B. Similarly, a scope A implies scope value B if there is some scope value in A that implies B. This is the basic operation used to check permissions when processing an OAuth token."),(0,a.kt)("p",null,"Consumers of OAuth tokens should avoid directly parsing and comparing scopes where possible, and instead use the existing implementation in the ",(0,a.kt)("inlineCode",{parentName:"p"},"fxa-shared")," node module."),(0,a.kt)("p",null,"For consumers that must implement their own scope checking, the rules for implication can be summarized as:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"For URL scope values, ",(0,a.kt)("inlineCode",{parentName:"li"},"A")," implies ",(0,a.kt)("inlineCode",{parentName:"li"},"B")," if ",(0,a.kt)("inlineCode",{parentName:"li"},"A")," is a parent resource of ",(0,a.kt)("inlineCode",{parentName:"li"},"B"),"."),(0,a.kt)("li",{parentName:"ul"},'For short-name scope values, split on the ":" character,  and ',(0,a.kt)("inlineCode",{parentName:"li"},"A")," implies ",(0,a.kt)("inlineCode",{parentName:"li"},"B")," if either:",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"B[-1]"),' is not "write" and ',(0,a.kt)("inlineCode",{parentName:"li"},"A")," is a prefix of ",(0,a.kt)("inlineCode",{parentName:"li"},"B"),", or."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"A[-1]"),' is "write", and:',(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"A[:-1]")," is a prefix of ",(0,a.kt)("inlineCode",{parentName:"li"},"B"),", or"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"B[-1]"),' is "write" and ',(0,a.kt)("inlineCode",{parentName:"li"},"A[:-1]")," is a prefix of ",(0,a.kt)("inlineCode",{parentName:"li"},"B[:-1]"))))))),(0,a.kt)("p",null,"More precisely, the algoritm for checking implication is:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"If ",(0,a.kt)("inlineCode",{parentName:"li"},"A")," is a ",(0,a.kt)("inlineCode",{parentName:"li"},"https://")," URL, then:",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"If ",(0,a.kt)("inlineCode",{parentName:"li"},"B")," is not a ",(0,a.kt)("inlineCode",{parentName:"li"},"https://")," URL, then fail."),(0,a.kt)("li",{parentName:"ul"},"If the origin of ",(0,a.kt)("inlineCode",{parentName:"li"},"B")," is different than that of ",(0,a.kt)("inlineCode",{parentName:"li"},"A"),", then fail."),(0,a.kt)("li",{parentName:"ul"},"If the path component list of ",(0,a.kt)("inlineCode",{parentName:"li"},"A")," is not a prefix of the path\ncomponent list of ",(0,a.kt)("inlineCode",{parentName:"li"},"B"),", then fail."),(0,a.kt)("li",{parentName:"ul"},"If ",(0,a.kt)("inlineCode",{parentName:"li"},"A")," has a fragment, then:",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"If ",(0,a.kt)("inlineCode",{parentName:"li"},"B")," does not have a fragment, then fail."),(0,a.kt)("li",{parentName:"ul"},"If ",(0,a.kt)("inlineCode",{parentName:"li"},"B")," has a fragment that differs from ",(0,a.kt)("inlineCode",{parentName:"li"},"A"),", then fail."))),(0,a.kt)("li",{parentName:"ul"},"Otherwise, succeed."))),(0,a.kt)("li",{parentName:"ul"},"Otherwise:",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"If ",(0,a.kt)("inlineCode",{parentName:"li"},"B")," is a ",(0,a.kt)("inlineCode",{parentName:"li"},"https://")," URL, then fail."),(0,a.kt)("li",{parentName:"ul"},"Split ",(0,a.kt)("inlineCode",{parentName:"li"},"A")," and ",(0,a.kt)("inlineCode",{parentName:"li"},"B")," into components based on ",(0,a.kt)("inlineCode",{parentName:"li"},":")," delimiter."),(0,a.kt)("li",{parentName:"ul"},"If the last component of ",(0,a.kt)("inlineCode",{parentName:"li"},"B")," is ",(0,a.kt)("inlineCode",{parentName:"li"},"write"),", then:",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"If the last component of ",(0,a.kt)("inlineCode",{parentName:"li"},"A")," is not ",(0,a.kt)("inlineCode",{parentName:"li"},"write"),", then fail."))),(0,a.kt)("li",{parentName:"ul"},"If the last component of ",(0,a.kt)("inlineCode",{parentName:"li"},"A")," is ",(0,a.kt)("inlineCode",{parentName:"li"},"write"),", remove it."),(0,a.kt)("li",{parentName:"ul"},"If ",(0,a.kt)("inlineCode",{parentName:"li"},"A")," is not a prefix of ",(0,a.kt)("inlineCode",{parentName:"li"},"B"),", then fail."),(0,a.kt)("li",{parentName:"ul"},"Otherwise, succeed.")))),(0,a.kt)("p",null,"Below are some testcases against which scope-checking code can be validated."),(0,a.kt)("p",null,"Valid implications:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"profile:write")," implies ",(0,a.kt)("inlineCode",{parentName:"li"},"profile"),"."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"profile")," implies ",(0,a.kt)("inlineCode",{parentName:"li"},"profile:email"),"."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"profile:write")," implies ",(0,a.kt)("inlineCode",{parentName:"li"},"profile:email"),"."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"profile:write")," implies ",(0,a.kt)("inlineCode",{parentName:"li"},"profile:email:write"),"."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"profile:email:write")," implies ",(0,a.kt)("inlineCode",{parentName:"li"},"profile:email"),"."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"profile profile:email:write")," implies ",(0,a.kt)("inlineCode",{parentName:"li"},"profile:email"),"."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"profile profile:email:write")," implies ",(0,a.kt)("inlineCode",{parentName:"li"},"profile:display_name"),"."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"profile https://identity.mozilla.com/apps/oldsync")," implies ",(0,a.kt)("inlineCode",{parentName:"li"},"profile"),"."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"profile https://identity.mozilla.com/apps/oldsync")," implies ",(0,a.kt)("inlineCode",{parentName:"li"},"https://identity.mozilla.com/apps/oldsync"),"."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"https://identity.mozilla.com/apps/oldsync")," implies ",(0,a.kt)("inlineCode",{parentName:"li"},"https://identity.mozilla.com/apps/oldsync#read"),"."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"https://identity.mozilla.com/apps/oldsync")," implies ",(0,a.kt)("inlineCode",{parentName:"li"},"https://identity.mozilla.com/apps/oldsync/bookmarks"),"."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"https://identity.mozilla.com/apps/oldsync")," implies ",(0,a.kt)("inlineCode",{parentName:"li"},"https://identity.mozilla.com/apps/oldsync/bookmarks#read"),"."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"https://identity.mozilla.com/apps/oldsync#read")," implies ",(0,a.kt)("inlineCode",{parentName:"li"},"https://identity.mozilla.com/apps/oldsync/bookmarks#read"),"."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"https://identity.mozilla.com/apps/oldsync#read profile")," implies ",(0,a.kt)("inlineCode",{parentName:"li"},"https://identity.mozilla.com/apps/oldsync/bookmarks#read"),".")),(0,a.kt)("p",null,"Invalid implications:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"profile:email:write")," does ",(0,a.kt)("em",{parentName:"li"},"not")," imply ",(0,a.kt)("inlineCode",{parentName:"li"},"profile"),"."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"profile:email:write")," does ",(0,a.kt)("em",{parentName:"li"},"not")," imply ",(0,a.kt)("inlineCode",{parentName:"li"},"profile:write"),"."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"profile:email")," does ",(0,a.kt)("em",{parentName:"li"},"not")," imply ",(0,a.kt)("inlineCode",{parentName:"li"},"profile:display_name"),"."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"profilebogey")," does ",(0,a.kt)("em",{parentName:"li"},"not")," imply ",(0,a.kt)("inlineCode",{parentName:"li"},"profile"),"."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"profile:write")," does ",(0,a.kt)("em",{parentName:"li"},"not")," imply ",(0,a.kt)("inlineCode",{parentName:"li"},"https://identity.mozilla.com/apps/oldsync"),"."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"profile profile:email:write")," does ",(0,a.kt)("em",{parentName:"li"},"not")," imply ",(0,a.kt)("inlineCode",{parentName:"li"},"profile:write"),"."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"https")," does ",(0,a.kt)("em",{parentName:"li"},"not")," imply ",(0,a.kt)("inlineCode",{parentName:"li"},"https://identity.mozilla.com/apps/oldsync"),"."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"https://identity.mozilla.com/apps/oldsync")," does ",(0,a.kt)("em",{parentName:"li"},"not")," imply ",(0,a.kt)("inlineCode",{parentName:"li"},"profile"),"."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"https://identity.mozilla.com/apps/oldsync#read")," does ",(0,a.kt)("em",{parentName:"li"},"not")," imply ",(0,a.kt)("inlineCode",{parentName:"li"},"https://identity.mozilla.com/apps/oldsync/bookmarks"),"."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"https://identity.mozilla.com/apps/oldsync#write")," does ",(0,a.kt)("em",{parentName:"li"},"not")," imply ",(0,a.kt)("inlineCode",{parentName:"li"},"https://identity.mozilla.com/apps/oldsync/bookmarks#read"),"."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"https://identity.mozilla.com/apps/oldsync/bookmarks")," does ",(0,a.kt)("em",{parentName:"li"},"not")," imply ",(0,a.kt)("inlineCode",{parentName:"li"},"https://identity.mozilla.com/apps/oldsync"),"."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"https://identity.mozilla.com/apps/oldsync/bookmarks")," does ",(0,a.kt)("em",{parentName:"li"},"not")," imply ",(0,a.kt)("inlineCode",{parentName:"li"},"https://identity.mozilla.com/apps/oldsync/passwords"),"."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"https://identity.mozilla.com/apps/oldsyncer")," does ",(0,a.kt)("em",{parentName:"li"},"not")," imply ",(0,a.kt)("inlineCode",{parentName:"li"},"https://identity.mozilla.com/apps/oldsync"),"."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"https://identity.mozilla.com/apps/oldsync")," does ",(0,a.kt)("em",{parentName:"li"},"not")," imply ",(0,a.kt)("inlineCode",{parentName:"li"},"https://identity.mozilla.com/apps/oldsyncer"),"."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"https://identity.mozilla.org/apps/oldsync")," does ",(0,a.kt)("em",{parentName:"li"},"not")," imply ",(0,a.kt)("inlineCode",{parentName:"li"},"https://identity.mozilla.com/apps/oldsync"),".")),(0,a.kt)("h2",{id:"pairwise-pseudonymous-identifiers"},"Pairwise Pseudonymous Identifiers"),(0,a.kt)("p",null,"A Pairwise Pseudonymous Identifier (PPID) is defined in the ",(0,a.kt)("a",{parentName:"p",href:"https://openid.net/specs/oidc-core-1_0.html#Terminology"},"OpenID Connect Spec")," as:"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"Identifier that identifies the Entity to a Relying Party that cannot be correlated with the Entity's PPID at another Relying Party.")),(0,a.kt)("p",null,"Put another way, PPIDs provide a single user with distinct userids across distinct Relying Parties (RPs), enhancing user privacy by preventing cross-site correlation based on userid."),(0,a.kt)("p",null,"By default, Mozilla accounts provides the same userid to all Mozilla-internal RPs to facilitate cross service correlation. As Mozilla expands its product offering to include white labeled 3rd party services, we want to uphold Mozilla's principles regarding user privacy by providing external services with only the minimal data necessary."),(0,a.kt)("p",null,"PPIDs allow Mozilla to enforce our privacy stance by providing each PPID enabled RP with a distinct userid for a given user. For example, a user that signs into 2 PPID enabled services would have 3 distinct userids:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"FxA userid, only seen by Mozilla properties"),(0,a.kt)("li",{parentName:"ul"},"PPID for service 1, known by Mozilla and service 1"),(0,a.kt)("li",{parentName:"ul"},"PPID for service 2, known by Mozilla and service 2")),(0,a.kt)("p",null,"PPIDs prevents service 1 and service 2 from correlating user data with each other based on userid alone. ",(0,a.kt)("em",{parentName:"p"},"PPIDs only prevent correlation based on userid"),", transient information such as IP address, shared 3rd party cookies, and user-agent information can still be used by RPs to correlate users. This also assumes that RPs are unable to fetch user profile information such as email address and display name that could be used as additional data points."),(0,a.kt)("p",null,"PPIDs are returned as the ",(0,a.kt)("inlineCode",{parentName:"p"},"sub")," claim within an ",(0,a.kt)("a",{parentName:"p",href:"https://openid.net/specs/openid-connect-core-1_0.html#IDToken"},"OIDC ID Token")," or ",(0,a.kt)("a",{parentName:"p",href:"https://tools.ietf.org/html/draft-ietf-oauth-access-token-jwt"},"OAuth JWT Access Token"),"."),(0,a.kt)("h3",{id:"further-enhancing-privacy-through-ppid-rotation"},"Further enhancing privacy through PPID rotation"),(0,a.kt)("p",null,"User privacy can be further enhanced by preventing long term profiles from being built for a given user through PPID rotation. Mozilla accounts supports two methods of PPID rotation, RP initiated, and server initiated."),(0,a.kt)("h4",{id:"rp-initiated-ppid-rotation"},"RP initiated PPID rotation"),(0,a.kt)("p",null,"Any PPID enabled RP that receives JWT access tokens or OIDC ID tokens can initiate PPID rotation by specifying an additional parameter, ",(0,a.kt)("inlineCode",{parentName:"p"},"ppid_seed"),", when requesting tokens from ",(0,a.kt)("inlineCode",{parentName:"p"},"/token")," endpoints on the OAuth server. ",(0,a.kt)("inlineCode",{parentName:"p"},"ppid_seed")," must be an integer between 0 and 1024, and can be rotated at any time."),(0,a.kt)("h4",{id:"server-initiated-ppid-rotation"},"Server initiated PPID rotation"),(0,a.kt)("p",null,"By default, Mozilla accounts does not enforce sub rotation, but for sensitive RPs where long term user profiles are undesirable, Mozilla accounts can enforce periodic rotation without depending on the RP to pass in a ",(0,a.kt)("inlineCode",{parentName:"p"},"ppid_seed"),". The default period is 6 hours."),(0,a.kt)("h3",{id:"ensuring-3rd-parties-are-unable-to-access-user-information"},"Ensuring 3rd parties are unable to access user information"),(0,a.kt)("p",null,"An OAuth access token is a bearer token that can be presented by anyone to an OAuth service provider to access a protected resource. If a JWT access token contains a PPID ",(0,a.kt)("inlineCode",{parentName:"p"},"sub")," claim that is meant to protect a user's privacy, but is granted the ",(0,a.kt)("inlineCode",{parentName:"p"},"profile")," scope allows the service provider to present the same access token to the FxA profile server and learn the user's true identity. As such, tokens ",(0,a.kt)("em",{parentName:"p"},"MUST NOT")," be requested with the ",(0,a.kt)("inlineCode",{parentName:"p"},"profile")," scope or any of its implicants such as ",(0,a.kt)("inlineCode",{parentName:"p"},"profile:uid")," or ",(0,a.kt)("inlineCode",{parentName:"p"},"profile:email"),"."),(0,a.kt)("h2",{id:"ppids-and-logging"},"PPIDs and logging"),(0,a.kt)("p",null,"PPIDs are not used by internal Mozilla properties and are not logged."),(0,a.kt)("h3",{id:"ppid-generation"},"PPID generation"),(0,a.kt)("p",null,"PPIDs are generated using ",(0,a.kt)("a",{parentName:"p",href:"https://tools.ietf.org/html/rfc5869"},"HKDF")," with the following inputs:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"km"),": ",(0,a.kt)("inlineCode",{parentName:"li"},"client_id"),".",(0,a.kt)("inlineCode",{parentName:"li"},"userid_hex"),".",(0,a.kt)("inlineCode",{parentName:"li"},"ppid_seed||0"),".",(0,a.kt)("inlineCode",{parentName:"li"},"serverEnforcedRotationInput")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"info"),": ",(0,a.kt)("inlineCode",{parentName:"li"},"oidc ppid sub")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"salt"),": A secret configured by Ops"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"len"),": 16 bytes, which leads to a 32 hex character result")),(0,a.kt)("h4",{id:"server-enforced-rotation-input"},"Server enforced rotation input"),(0,a.kt)("p",null,"The server enforced rotation input defaults to the string ",(0,a.kt)("inlineCode",{parentName:"p"},"0"),". If server enforced rotation is enabled for the client, it is calculated as follows:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"serverEnforcedRotationInput = Math.floor(Date.now() / ROTATION_PERIOD)\n")),(0,a.kt)("p",null,"If an RP requests two tokens in short succession, their ",(0,a.kt)("inlineCode",{parentName:"p"},"sub")," claims could be different if the first token was generated previous to the rotation epoch and the second after."),(0,a.kt)("h3",{id:"the-future"},"The future"),(0,a.kt)("p",null,"Mozilla accounts does not currently support ",(0,a.kt)("a",{parentName:"p",href:"https://openid.net/specs/openid-connect-core-1_0.html#PairwiseAlg"},"sector identifiers"),". Sector identifiers allow multiple client_ids to receive the same PPID, this would be useful if the RP has applications on multiple platforms, e.g., an app on Android, iOS, and an addon in Firefox."),(0,a.kt)("h2",{id:"pkce-support"},"PKCE Support"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"Proof Key for Code Exchange by OAuth Public Clients")),(0,a.kt)("p",null,"Mozilla accounts OAuth flow supports the ",(0,a.kt)("a",{parentName:"p",href:"https://tools.ietf.org/html/rfc7636"},"PKCE RFC7636"),".  This feature helps us authenticate clients such as WebExtensions and Native apps and any other clients that do not have a server component or a secure way to store a ",(0,a.kt)("inlineCode",{parentName:"p"},"client_secret"),"."),(0,a.kt)("p",null,"To better understand this protocol please read the ",(0,a.kt)("a",{parentName:"p",href:"https://www.authlete.com/documents/article/pkce/index"},"Proof Key for Code Exchange (RFC 7636) by Authlete Inc."),"."),(0,a.kt)("p",null,"You'll need to include support parameters ",(0,a.kt)("inlineCode",{parentName:"p"},"code_challenge_method"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"code_challenge")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"code_verifier"),"."),(0,a.kt)("p",null,"At this time Mozilla accounts requires you to use the ",(0,a.kt)("inlineCode",{parentName:"p"},"S256")," flow, we do not support the ",(0,a.kt)("inlineCode",{parentName:"p"},"plain")," code challenge method."),(0,a.kt)("h2",{id:"promptnone-support"},"prompt=none support"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"prompt=none")," enables authorized RPs to check a user's authentication state and receive an OAuth grant or access token without requiring user interaction."),(0,a.kt)("p",null,"More formally, ",(0,a.kt)("inlineCode",{parentName:"p"},"prompt=none")," is a flow described by the ",(0,a.kt)("a",{parentName:"p",href:"https://openid.net/specs/openid-connect-core-1_0.html"},"OpenID Connect spec")," as:"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"The Authorization Server MUST NOT display any authentication or consent user interface pages. An error is returned if an End-User is not already authenticated or the Client does not have pre-configured consent for the requested Claims or does not fulfill other conditions for processing the request. The error code will typically be login_required, interaction_required, or another code defined in Section 3.1.2.6. This can be used as a method to check for existing authentication and/or consent.")),(0,a.kt)("h3",{id:"promptnone-usage-is-controlled"},"prompt=none usage is controlled"),(0,a.kt)("p",null,"Usage of ",(0,a.kt)("inlineCode",{parentName:"p"},"prompt=none")," with ",(0,a.kt)("inlineCode",{parentName:"p"},"login_hint")," / ",(0,a.kt)("inlineCode",{parentName:"p"},"email")," is controlled to an authorized list of RPs, since\nit bypasses the normal authorization flow and use could easily fall afoul of user expectations."),(0,a.kt)("p",null,"However, ",(0,a.kt)("em",{parentName:"p"},"all")," RPs can check the user's FxA login state using ",(0,a.kt)("inlineCode",{parentName:"p"},"id_token_hint"),": since RPs not on the\nauthorized list can only obtain an ",(0,a.kt)("a",{parentName:"p",href:"https://openid.net/specs/openid-connect-core-1_0.html#IDToken"},"id_token")," by\ngoing through the normal authorization flow, it is safe to assume an RP presenting the ",(0,a.kt)("inlineCode",{parentName:"p"},"id_token"),"\nas part of a ",(0,a.kt)("inlineCode",{parentName:"p"},"prompt=none")," flow has already been granted authorization."),(0,a.kt)("h3",{id:"requesting-promptnone-during-authorization"},"Requesting ",(0,a.kt)("inlineCode",{parentName:"h3"},"prompt=none")," during authorization"),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"/api#tag/OAuth-Server-API-Overview/operation/getAuthorization"},(0,a.kt)("inlineCode",{parentName:"a"},"prompt=none")," and either ",(0,a.kt)("inlineCode",{parentName:"a"},"login_hint=<email>")," or ",(0,a.kt)("inlineCode",{parentName:"a"},"id_token_hint=<ID Token>"))," are appended onto the query parameters when opening the ",(0,a.kt)("inlineCode",{parentName:"p"},"/authorization")," endpoint."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"GET https://accounts.firefox.com/authorization?client_id=ea3ca969f8c6bb0d&state=2sfas415FSSF@A5f&scope=profile&prompt=none&login_hint=conscious.chooser%40mozilla.com\n")),(0,a.kt)("p",null,"If a different user is currently signed in to the email specified by the ",(0,a.kt)("inlineCode",{parentName:"p"},"login_hint")," or ",(0,a.kt)("inlineCode",{parentName:"p"},"id_token_hint"),", an ",(0,a.kt)("a",{parentName:"p",href:"#handling-errors"},(0,a.kt)("inlineCode",{parentName:"a"},"account_selection_required")," error will be returned"),"."),(0,a.kt)("h3",{id:"handling-errors"},"Handling errors"),(0,a.kt)("p",null,"Most ",(0,a.kt)("inlineCode",{parentName:"p"},"prompt=none")," failures cause the user to be redirected back to the RP's ",(0,a.kt)("inlineCode",{parentName:"p"},"redirectURI")," with ",(0,a.kt)("inlineCode",{parentName:"p"},"state")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"error")," query parameters."),(0,a.kt)("p",null,"The following is a table of ",(0,a.kt)("a",{parentName:"p",href:"https://openid.net/specs/openid-connect-core-1_0.html#AuthError"},"OIDC compliant error codes")," ","\u2192"," reasons"),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"error"),(0,a.kt)("th",{parentName:"tr",align:null},"reason"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},(0,a.kt)("inlineCode",{parentName:"td"},"invalid_request")),(0,a.kt)("td",{parentName:"tr",align:null},"prompt=none is not enabled")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\xa0"),(0,a.kt)("td",{parentName:"tr",align:null},"OR ",(0,a.kt)("inlineCode",{parentName:"td"},"login_hint")," is missing")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\xa0"),(0,a.kt)("td",{parentName:"tr",align:null},"OR scoped keys are requested")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\xa0"),(0,a.kt)("td",{parentName:"tr",align:null},"OR the ",(0,a.kt)("inlineCode",{parentName:"td"},"id_token_hint")," token is invalid")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},(0,a.kt)("inlineCode",{parentName:"td"},"unauthorized_client")),(0,a.kt)("td",{parentName:"tr",align:null},"prompt=none is not enabled for the client")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},(0,a.kt)("inlineCode",{parentName:"td"},"* interaction_required")),(0,a.kt)("td",{parentName:"tr",align:null},"account or session is not verified")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},(0,a.kt)("inlineCode",{parentName:"td"},"* login_required")),(0,a.kt)("td",{parentName:"tr",align:null},"user is not signed in")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},(0,a.kt)("inlineCode",{parentName:"td"},"* account_selection_required")),(0,a.kt)("td",{parentName:"tr",align:null},"a different user is signed in")))),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"*")," indicates the user must take some form of action to recover"),(0,a.kt)("p",null,"As an example, suppose the ",(0,a.kt)("inlineCode",{parentName:"p"},"authorization")," request from the previous section failed because the user is not signed in and assume the ",(0,a.kt)("inlineCode",{parentName:"p"},"redirectURI")," for client ",(0,a.kt)("inlineCode",{parentName:"p"},"ea3ca969f8c6bb0d")," is ",(0,a.kt)("inlineCode",{parentName:"p"},"https://service.firefox.com/oauth/complete"),". The user would be redirected to:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"GET https://service.firefox.com/oauth/complete?state=2sfas415FSSF@A5f&error=login_required\n")),(0,a.kt)("h4",{id:"recovering-from-errors"},"Recovering from errors"),(0,a.kt)("p",null,"At this point, the RP knows the user must authenticate to Mozilla accounts before OAuth codes or access tokens are returned. The RP can generate a new ",(0,a.kt)("inlineCode",{parentName:"p"},"state")," and try again without the ",(0,a.kt)("inlineCode",{parentName:"p"},"prompt=none")," query parameter:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"GET https://accounts.firefox.com/authorization?client_id=ea3ca969f8c6bb0d&state=gASDF-3df@A5f&scope=profile&login_hint=conscious.chooser%40mozilla.com\n")),(0,a.kt)("admonition",{type:"warning"},(0,a.kt)("p",{parentName:"admonition"},"When ",(0,a.kt)("inlineCode",{parentName:"p"},"prompt=none")," is not specified, FxA handles ",(0,a.kt)("inlineCode",{parentName:"p"},"login_hint")," as a suggestion, users are still able to authenticate/authorize using a different email. If the user specified in ",(0,a.kt)("inlineCode",{parentName:"p"},"login_hint")," ",(0,a.kt)("em",{parentName:"p"},"MUST")," be used, specify ",(0,a.kt)("a",{parentName:"p",href:"/api#tag/OAuth-Server-API-Overview/operation/getAuthorization"},(0,a.kt)("inlineCode",{parentName:"a"},"action=force_auth"))," when redirecting back to FxA."),(0,a.kt)("p",{parentName:"admonition"},"If a different user is allowed to sign in, it may be necessary to clear locally held session state before redirecting back to FxA.")),(0,a.kt)("h3",{id:"handling-user-logout"},"Handling user logout"),(0,a.kt)("p",null,"Whenever the user terminates a session at the RP, any access and refresh tokens held by the RP for that session should be destroyed. Destroying the access and refresh tokens will ensure an entry for the session no longer appears in the ",(0,a.kt)("a",{parentName:"p",href:"https://accounts.firefox.com/settings#connected-services"},"Devices and Apps")," list."),(0,a.kt)("h4",{id:"destroying-an-access-token"},"Destroying an access token"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"POST https://oauth.accounts.firefox.com/v1/destroy\n{\n  access_token: <access_token>\n}\n")),(0,a.kt)("h4",{id:"destroying-a-refresh-token"},"Destroying a refresh token"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"POST https://oauth.accounts.firefox.com/v1/destroy\n{\n  refresh_token: <refresh_token>\n}\n")),(0,a.kt)("p",null,"More information on destroying tokens can be found on the ",(0,a.kt)("a",{parentName:"p",href:"/api#tag/OAuth-Server-API-Overview/operation/postDestroy"},"OAuth server's API docs"),"."),(0,a.kt)("h4",{id:"sso-logout"},"SSO logout"),(0,a.kt)("p",null,"Several concerns are noted, most importantly:"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"...there's potentially confusing behaviour around logging out of an FxA relier. If I use FxA to sign in to AMO, and then I sign out in AMO, I could reasonably expect to have to enter my password again if I want to sign back in. But we don't have a way for AMO to signal back to FxA that the user signed out.")),(0,a.kt)("p",null,"This concern is not currently addressed as none of the ",(0,a.kt)("a",{parentName:"p",href:"https://medium.com/@robert.broeckelmann/openid-connect-logout-eccc73df758f"},"OIDC logout flows")," are currently supported."),(0,a.kt)("p",null,"RPs can protect themselves a little bit here by not using ",(0,a.kt)("inlineCode",{parentName:"p"},"prompt=none"),' unless they still have a valid local login session for that user. If the users signs out of the RP, they will always see some UI when trying to sign back in, even if it\'s just the "Continue as X" button rather than a password prompt.'),(0,a.kt)("h3",{id:"promptnone-and-security"},"prompt=none and security"),(0,a.kt)("p",null,"For users that are already authenticated to Mozilla accounts, ",(0,a.kt)("inlineCode",{parentName:"p"},"prompt=none")," bypasses the FxA authorization screen and redirects back to the RP without any user interaction. This behavior applies equally to users with 2FA enabled and could easily cause confusion with users. The Mozilla accounts team only enables the use of ",(0,a.kt)("inlineCode",{parentName:"p"},"prompt=none")," for a service if both a good use case exists and the integration has been audited."),(0,a.kt)("h3",{id:"future-directions"},"Future directions"),(0,a.kt)("p",null,"Support for and OIDC RP Initiated Logout may go some way to reducing user confusion on what it means to sign out of an RP and whether they should have to enter their password again. Upon signing out of the RP, RPs that support the OIDC RP Initiated Logout protocol will redirect the user to FxA where they are given the option to destroy their FxA session as well."),(0,a.kt)("h2",{id:"management-of-jwt-signing-keys"},"Management of JWT Signing Keys"),(0,a.kt)("p",null,"This server uses signed ",(0,a.kt)("a",{parentName:"p",href:"https://jwt.io/"},"JWTs")," to represent various kinds of security token, including:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"id_token"),"s as defined by ",(0,a.kt)("a",{parentName:"li",href:"https://openid.net/specs/openid-connect-core-1_0.html"},"OpenID Connect")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"access_token"),"s as defined by ",(0,a.kt)("a",{parentName:"li",href:"https://datatracker.ietf.org/doc/draft-ietf-oauth-access-token-jwt/"},"JWT Profile for OAuth 2.0 Access\nTokens")),(0,a.kt)("li",{parentName:"ul"},"Security Event Tokens as defined by ",(0,a.kt)("a",{parentName:"li",href:"https://tools.ietf.org/html/rfc8417"},"RFC8417"))),(0,a.kt)("p",null,"RPs are expected to verify the signatures on these JWTs by fetching our public keys via the\n",(0,a.kt)("a",{parentName:"p",href:"https://openid.net/specs/openid-connect-discovery-1_0.html"},"OpenID Connect Discovery Protocol"),",\nwhich involves:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Fetching our main OpenID metadata document at ",(0,a.kt)("a",{parentName:"li",href:"https://accounts.firefox.com/.well-known/openid-configuration"},"https://accounts.firefox.com/.well-known/openid-configuration")),(0,a.kt)("li",{parentName:"ol"},"Extracting the contained ",(0,a.kt)("inlineCode",{parentName:"li"},'"jwks_uri"')," entry"),(0,a.kt)("li",{parentName:"ol"},"Fetching a ",(0,a.kt)("a",{parentName:"li",href:"https://tools.ietf.org/html/rfc7517"},"JWK Set")," document from that URI"),(0,a.kt)("li",{parentName:"ol"},"Respecting standard HTTP cache-control headers on those resources")),(0,a.kt)("p",null,"We thus have a coordination problem between this server and its RPs when it comes to changing our\nJWT signing keys. Let ",(0,a.kt)("inlineCode",{parentName:"p"},"T_cache")," be the max age in the cache-control headers of our metadata documents,\nand ",(0,a.kt)("inlineCode",{parentName:"p"},"T_tokens")," be the maximum lifetime of any token issued by this service. Then:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"We must advertise a new signing key in our JWK Set for at least ",(0,a.kt)("inlineCode",{parentName:"li"},"T_cache")," seconds before we start\nusing it to sign tokens. If we don't, RPs with a cached copy of our JWK Set may not know to trust\nthe new key, resulting in spurious verification failures and/or fragile logic to refresh the cached\ncopy on-demand when verification fails."),(0,a.kt)("li",{parentName:"ul"},"We must continue to advertise an old signing key in our JWK Set for at least ",(0,a.kt)("inlineCode",{parentName:"li"},"T_tokens")," seconds\nafter we stop using it to sign tokens. If we don't, RPs who refresh their cache of our JWK Set may\ntreat tokens signed with that key as invalid before they expire, resulting in spurious verification\nfailures.")),(0,a.kt)("p",null,"To help manage this, the server config has slots for three different keys, one required and the others\noptional:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"openid.key"),": The private key that is actively being used to sign tokens. This key is required."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"openid.newKey"),": A new private key that we intend to start using to sign tokens in the future.\nThis key is optional, but can be specified in order to start advertising it before use."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"openid.oldKey"),": The ",(0,a.kt)("em",{parentName:"li"},"public")," component of a key we previously used to sign tokens. This key is\noptional, but can be specified in order to continue advertising it while tokens bearing its signature\nmay be active.")),(0,a.kt)("p",null,"The procedure for rotating the active signing key is:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Create the new signing key and configure it as ",(0,a.kt)("inlineCode",{parentName:"li"},"openid.newKey"),", while leaving the existing ",(0,a.kt)("inlineCode",{parentName:"li"},"openid.key")," intact.",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"This can be performed using ",(0,a.kt)("inlineCode",{parentName:"li"},"../scripts/prepare-new-signing-key.js"),"."))),(0,a.kt)("li",{parentName:"ul"},"Deploy to all server instances, then wait for at least ",(0,a.kt)("inlineCode",{parentName:"li"},"T_cache")," seconds plus some margin for clock error."),(0,a.kt)("li",{parentName:"ul"},"Take the public component of ",(0,a.kt)("inlineCode",{parentName:"li"},"openid.key")," and configure it as ",(0,a.kt)("inlineCode",{parentName:"li"},"openid.oldKey"),", then move ",(0,a.kt)("inlineCode",{parentName:"li"},"openid.newKey"),"\nto ",(0,a.kt)("inlineCode",{parentName:"li"},"openid.key"),".",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"This can be performed using ",(0,a.kt)("inlineCode",{parentName:"li"},"../scripts/activate-new-signing-key.js"),"."))),(0,a.kt)("li",{parentName:"ul"},"Deploy to all server instances, then wait for at least ",(0,a.kt)("inlineCode",{parentName:"li"},"T_tokens")," seconds plus some margin for clock error."),(0,a.kt)("li",{parentName:"ul"},"Remove ",(0,a.kt)("inlineCode",{parentName:"li"},"openid.oldKey")," from the configuration.",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"This can be performed using ",(0,a.kt)("inlineCode",{parentName:"li"},"../scripts/retire-old-signing-key.js"),"."))),(0,a.kt)("li",{parentName:"ul"},"Deploy to all server instances, then celebrate a job well done.")),(0,a.kt)("p",null,"This scheme keeps things fairly simple, but it also means that each key rotation event must be at least\n",(0,a.kt)("inlineCode",{parentName:"p"},"T_cache + T_tokens")," seconds apart. If this proves to be a problem in practice, we could reduce the limit\nto ",(0,a.kt)("inlineCode",{parentName:"p"},"T_cache")," by keeping a ",(0,a.kt)("em",{parentName:"p"},"list")," of old signing keys rather than a single key."),(0,a.kt)("p",null,"For our main production environment, secret keys are managed via ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/mozilla/sops"},"SOPS"),".\nIf you're working in such an environment you can do this to extract the keys from SOPS into local files:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"./scripts/sops-key-config.js extract path/to/encrypted/config.yaml\n")),(0,a.kt)("p",null,"Then, after operating on them locally using the above key-rotation scripts, you can insert the modified\nvalues back into SOPS via:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"./scripts/sops-key-config.js insert path/to/encrypted/config.yaml\n")))}u.isMDXComponent=!0}}]);