"use strict";(self.webpackChunkfirefox_ecosystem_platform=self.webpackChunkfirefox_ecosystem_platform||[]).push([[8110],{54578:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>r,default:()=>d,frontMatter:()=>i,metadata:()=>l,toc:()=>p});var n=a(87462),o=(a(67294),a(3905));a(8209);const i={title:"Application Logging"},r=void 0,l={unversionedId:"reference/application-logging",id:"reference/application-logging",title:"Application Logging",description:"Application Logging",source:"@site/docs/reference/application-logging.md",sourceDirName:"reference",slug:"/reference/application-logging",permalink:"/ecosystem-platform/reference/application-logging",draft:!1,editUrl:"https://github.com/mozilla/ecosystem-platform/edit/master/docs/reference/application-logging.md",tags:[],version:"current",frontMatter:{title:"Application Logging"},sidebar:"docs",previous:{title:"Continuous Integration for Monorepos",permalink:"/ecosystem-platform/reference/continuous-integration-for-monorepos"},next:{title:"Application Tracing",permalink:"/ecosystem-platform/reference/application-tracing"}},s={},p=[{value:"Application Logging",id:"application-logging",level:2},{value:"Capturing Event Details",id:"capturing-event-details",level:3},{value:"Viewing Event Logs",id:"viewing-event-logs",level:3}],g={toc:p},c="wrapper";function d(e){let{components:t,...a}=e;return(0,o.kt)(c,(0,n.Z)({},g,a,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"application-logging"},"Application Logging"),(0,o.kt)("p",null,"In FxA Javascript/Typescript server-side applications, logging is emitted via ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/mozilla/mozlog/"},"mozlog")," which adheres to the ",(0,o.kt)("a",{parentName:"p",href:"https://wiki.mozilla.org/Firefox/Services/Logging#MozLog_JSON_schema"},"mozlog schema")," format. The log messages are captured from ",(0,o.kt)("inlineCode",{parentName:"p"},"stdout")," and aggregated into Google ",(0,o.kt)("a",{parentName:"p",href:"https://console.cloud.google.com/bigquery"},"BigQuery")," via Stackdriver. Application exceptions are captured via ",(0,o.kt)("a",{parentName:"p",href:"https://sentry.io/"},"Sentry")," and sent to our Sentry instance."),(0,o.kt)("p",null,"Stage and development logging is grouped under the ",(0,o.kt)("inlineCode",{parentName:"p"},"fxa-nonprod")," project, while accessing the ",(0,o.kt)("inlineCode",{parentName:"p"},"fxa-prod")," logs requires additional special access privileges."),(0,o.kt)("h3",{id:"capturing-event-details"},"Capturing Event Details"),(0,o.kt)("p",null,"Once a ",(0,o.kt)("inlineCode",{parentName:"p"},"mozlog")," instance is created, log events are captured with a dot concatenated string indicating an (ideally) unique location of the logging statement that is clear where in the code-base it was made, along with any additional fields to include."),(0,o.kt)("p",null,"Creating a ",(0,o.kt)("inlineCode",{parentName:"p"},"mozlog")," instance can be done by instantiating the log object with a configuration object:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"const logConfig = {\n    app: 'fxa-content-server',\n    fmt: 'heka',\n    level: 'info'\n};\nconst log = require('mozlog')(logConfig);\n")),(0,o.kt)("p",null,"It can then be used to log with:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"log.error('push.sendPush', {uid, deviceId, err });\n")),(0,o.kt)("p",null,"The above log event will have a ",(0,o.kt)("inlineCode",{parentName:"p"},"jsonPayload.type")," set to ",(0,o.kt)("inlineCode",{parentName:"p"},"push.sendPush"),", while the additional object properties will be attached as the ",(0,o.kt)("inlineCode",{parentName:"p"},"jsonPayload.fields")," object."),(0,o.kt)("h3",{id:"viewing-event-logs"},"Viewing Event Logs"),(0,o.kt)("p",null,"Using ",(0,o.kt)("a",{parentName:"p",href:"https://console.cloud.google.com/bigquery"},"bigquery"),", the logs can be retrieved from the application service that generated them by narrowing down the ",(0,o.kt)("inlineCode",{parentName:"p"},"stdout")," table used and the originating service by its container name ",(0,o.kt)("em",{parentName:"p"},"or")," querying the service table directly."),(0,o.kt)("p",null,"Container names for currently deployed services that output to ",(0,o.kt)("inlineCode",{parentName:"p"},"stdout")," tables:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"payments")," - FxA Payment Server"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"amplitude")," - FxA Amplitude Send"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"eventbroker")," - FxA Event Broker")),(0,o.kt)("p",null,"As these change over time, a quick way to determine available container names can be done using a ",(0,o.kt)("inlineCode",{parentName:"p"},"DISTINCT")," query (using the desired date):"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT DISTINCT(resource.labels.container_name)\nFROM `moz-fx-fxa-nonprod-375e.fxa_stage_logs.stdout_20191204`\n")),(0,o.kt)("p",null,"The ",(0,o.kt)("a",{parentName:"p",href:"https://console.cloud.google.com/bigquery"},"bigquery")," console has tab-complete for table-names and SQL statements to make query generation easy."),(0,o.kt)("p",null,"Accessing logs from the FxA Auth Server, FxA Auth Db MySQL Service, etc. requires querying the appropriate table. Some table prefix examples from ",(0,o.kt)("inlineCode",{parentName:"p"},"stage"),":"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"fxa-auth-server - ",(0,o.kt)("inlineCode",{parentName:"li"},"moz-fx-fxa-nonprod-375e.fxa_stage_logs.docker_fxa_auth_20191205")),(0,o.kt)("li",{parentName:"ul"},"fxa-auth-db-server - ",(0,o.kt)("inlineCode",{parentName:"li"},"moz-fx-fxa-nonprod-375e.fxa_stage_logs.docker_fxa_auth_db_20191204"))),(0,o.kt)("p",null,"A full list of these tabale prefixes can be found in the ",(0,o.kt)("a",{parentName:"p",href:"https://console.cloud.google.com/bigquery"},"bigquery")," console by clicking on the left side drop-down and expanding it under ",(0,o.kt)("inlineCode",{parentName:"p"},"fxa_stage_logs")," (or prod). FxA services all start with ",(0,o.kt)("inlineCode",{parentName:"p"},"docker_fxa_"),"."),(0,o.kt)("p",null,"For the newer moz-fx-fxa-nonprod and moz-fx-fxa-prod projects in GCP, logs are in ",(0,o.kt)("a",{parentName:"p",href:"https://console.cloud.google.com/bigquery"},"bigquery")," with separate tables based on the type of log. These include events, export_errors, requests, stderr, and stdout."),(0,o.kt)("p",null,"Below is an example of searching logs written to standard out for July 10, 2023. "),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},'SELECT LogName, resource.type, resource.labels.project_id, resource.labels.pod_name, resource.labels.location, resource.labels.location, resource.labels.namespace_name, resource.labels.cluster_name, textPayload FROM `moz-fx-fxa-nonprod.gke_fxa_stage_log.stdout` WHERE TIMESTAMP_TRUNC(_PARTITIONTIME, DAY) = TIMESTAMP("2023-07-10") LIMIT 1000\n')))}d.isMDXComponent=!0}}]);