"use strict";(self.webpackChunkfirefox_ecosystem_platform=self.webpackChunkfirefox_ecosystem_platform||[]).push([[9643],{92723:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>c,frontMatter:()=>n,metadata:()=>l,toc:()=>p});var o=a(87462),r=(a(67294),a(3905));a(8209);const n={title:"Metrics"},i=void 0,l={unversionedId:"reference/metrics",id:"reference/metrics",title:"Metrics",description:"Last updated: Sep 15th, 2023",source:"@site/docs/reference/metrics.md",sourceDirName:"reference",slug:"/reference/metrics",permalink:"/ecosystem-platform/reference/metrics",draft:!1,editUrl:"https://github.com/mozilla/ecosystem-platform/edit/master/docs/reference/metrics.md",tags:[],version:"current",frontMatter:{title:"Metrics"},sidebar:"docs",previous:{title:"Localization",permalink:"/ecosystem-platform/reference/localization"},next:{title:"Mobile Specifics",permalink:"/ecosystem-platform/reference/mobile-specifics"}},s={},p=[{value:"Application metrics",id:"application-metrics",level:2},{value:"Working with Raw Logs",id:"working-with-raw-logs",level:3},{value:"Crashes",id:"crashes",level:2},{value:"Server Health",id:"server-health",level:2},{value:"Front-end Performance",id:"front-end-performance",level:2}],m={toc:p},d="wrapper";function c(e){let{components:t,...a}=e;return(0,r.kt)(d,(0,o.Z)({},m,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"Last updated: ",(0,r.kt)("inlineCode",{parentName:"p"},"Sep 15th, 2023")),(0,r.kt)("p",null,"Firefox accounts collects metrics from servers running our code and clients accessing our services.  Mozilla takes data collection seriously so our policies and processes around it may seem more complex than most organizations but it is in an effort to grant agency to users over their own data."),(0,r.kt)("p",null,"Note that the ",(0,r.kt)("a",{parentName:"p",href:"https://wiki.mozilla.org/Data_Collection"},"Mozilla Data Collection policies")," apply to Firefox Accounts."),(0,r.kt)("p",null,"Our code is deployed to a staging environment before it goes to production so the metrics detailed below are available for both environments.  The details below will focus mostly on production."),(0,r.kt)("p",null,"Keep in mind that Firefox accounts allows users to opt-out of data collection via a toggle on the account settings page."),(0,r.kt)("p",null,"We also have a ",(0,r.kt)("a",{parentName:"p",href:"../explanation/metrics"},"metrics section which expands on the history of our system and how these are implemented"),"."),(0,r.kt)("h2",{id:"application-metrics"},"Application metrics"),(0,r.kt)("admonition",{type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"This is all undergoing major changes now with the move to GCP as well as a migration to using Glean.  Hopefully we can remove this message in 2024 and simplify these docs.")),(0,r.kt)("p",null,"These are logs from Firefox accounts code.  These are probably the most useful logs for product decision making as they were written by hand by engineers.  They are also the most complex."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Example data recorded"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"See the ",(0,r.kt)("a",{parentName:"li",href:"https://docs.telemetry.mozilla.org/datasets/fxa.html"},"taxonomies in the Mozilla Data Docs"),"."),(0,r.kt)("li",{parentName:"ul"},"As we move to Glean the dictionaries here will remain up to date automatically:  ",(0,r.kt)("a",{parentName:"li",href:"https://dictionary.telemetry.mozilla.org/apps/accounts_frontend"},"Frontend")," and ",(0,r.kt)("a",{parentName:"li",href:"https://dictionary.telemetry.mozilla.org/apps/accounts_backend"},"Backend")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Recorded with"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"These are logged via ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/mozilla/mozlog/"},"mozlog")," as regular server logs.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"The logs are immediately ingested into ",(0,r.kt)("a",{parentName:"p",href:"https://cloud.google.com/logging"},"GCP Cloud Logging"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"From there they are passed and stored in BigQuery in the ",(0,r.kt)("inlineCode",{parentName:"p"},"moz-fx-fxa-prod.gke-fx-fxa-prod")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"moz-fx-fxa-nonprod.gke-fx-fxa-stage")," projects depending on which environment they are coming out of.  These projects are relatively restricted and not for general consumption.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Every 24 hours, ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/mozilla/bigquery-etl/tree/main/sql/moz-fx-data-shared-prod/firefox_accounts_derived"},"some ETL jobs")," run which create derived tables from the original logs and store them in the ",(0,r.kt)("inlineCode",{parentName:"p"},"mozdata")," project in BigQuery.  ",(0,r.kt)("inlineCode",{parentName:"p"},"mozdata")," is accessible by anyone at Mozilla.  Please note: ",(0,r.kt)("em",{parentName:"p"},"Derived tables do not include all the events or details in the original logs.  You can read the queries that create the derived tables to see what is included."))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Additionally, there are some ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/mozilla/bigquery-etl/tree/main/sql/moz-fx-data-shared-prod/firefox_accounts"},"user-facing datasets")," of that same data, and also in ",(0,r.kt)("inlineCode",{parentName:"p"},"mozdata"),", which are designed to be easier to use.")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Accessible via"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://console.cloud.google.com/bigquery?"},"BigQuery"),".  Look for the ",(0,r.kt)("inlineCode",{parentName:"li"},"firefox_accounts")," dataset in the ",(0,r.kt)("inlineCode",{parentName:"li"},"mozdata")," project.  ",(0,r.kt)("em",{parentName:"li"},"Be aware that there are large amounts of data in BigQuery and you can spend a lot of money if you don't restrict your queries.")),(0,r.kt)("li",{parentName:"ul"},"Looker is backed by BigQuery and there is a ",(0,r.kt)("a",{parentName:"li",href:"https://mozilla.cloud.looker.com/folders/374"},"Firefox Accounts folder")," there"),(0,r.kt)("li",{parentName:"ul"},"There are ",(0,r.kt)("a",{parentName:"li",href:"https://earthangel-b40313e5.influxcloud.net/?orgId=1&search=open&query=fxa"},"several dashboards in grafana")," with a mix of these metrics on them"),(0,r.kt)("li",{parentName:"ul"},"See the section below about raw logs also")))),(0,r.kt)("h3",{id:"working-with-raw-logs"},"Working with Raw Logs"),(0,r.kt)("p",null,"If you need real-time data you need to be looking at the raw logs in ",(0,r.kt)("inlineCode",{parentName:"p"},"moz-fx-fxa-prod.gke-fx-fxa-prod")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"moz-fx-fxa-nonprod.gke-fx-fxa-stage"),".  Otherwise there will be a 24 hour delay.  We don't run our normal metrics out of those logs because it is too expensive and slow."),(0,r.kt)("p",null,"As noted above, these datasets are restricted but if you have access you'll find each package logging to those datasets in either the ",(0,r.kt)("inlineCode",{parentName:"p"},"stderr")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"stdout")," tables.  You can (and should) filter your queries by the package.  For example, to only look at logs from ",(0,r.kt)("inlineCode",{parentName:"p"},"fxa-customs-server")," we would filter where ",(0,r.kt)("inlineCode",{parentName:"p"},'labels.k8s_pod_deployment="customs" AND resource.labels.container_name="customs"'),".  This will capture the pod name and the container name.  We need to filter on both because each pod runs the package as well as nginx."),(0,r.kt)("h2",{id:"crashes"},"Crashes"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Example data recorded:",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"t is undefined")," and a link to the JS that failed to run"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"An internal validation check failed.")," and details about what the software expected to see and what it actually saw"))),(0,r.kt)("li",{parentName:"ul"},"Recorded with",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Sentry"))),(0,r.kt)("li",{parentName:"ul"},"Accessible via",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://sentry.prod.mozaws.net/operations/"},"Sentry")),(0,r.kt)("li",{parentName:"ul"},"Look for any project starting with ",(0,r.kt)("inlineCode",{parentName:"li"},"fxa-"),".  Eg. ",(0,r.kt)("inlineCode",{parentName:"li"},"fxa-auth-prod")," and ",(0,r.kt)("inlineCode",{parentName:"li"},"fxa-content-client-prod"))))),(0,r.kt)("h2",{id:"server-health"},"Server Health"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Example data recorded",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"There are 30 healthy hosts running"),(0,r.kt)("li",{parentName:"ul"},"A host is running at 100% cpu"))),(0,r.kt)("li",{parentName:"ul"},"Recorded with",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"The reporting tools built into the clouds we use"))),(0,r.kt)("li",{parentName:"ul"},"Accessible via",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"In their most detailed form, you'd need access to the cloud consoles themselves, but most of the data is also available in our Grafana instance.  ",(0,r.kt)("a",{parentName:"li",href:"https://earthangel-b40313e5.influxcloud.net/d/HqOQKXoZk/fxa-auth-prod-elb?orgId=1"},"Here is one of our dashboards hitting CloudWatch for metrics"))))),(0,r.kt)("h2",{id:"front-end-performance"},"Front-end Performance"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Example data recorded",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"It took 400ms to load ",(0,r.kt)("inlineCode",{parentName:"li"},"/settings")))),(0,r.kt)("li",{parentName:"ul"},"Recorded with",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"As of this writing we record the data using our own library (which maybe isn't totally accurate) and write the data via ",(0,r.kt)("inlineCode",{parentName:"li"},"statsd")," which ends up in influxdb.  We expect to move to ",(0,r.kt)("a",{parentName:"li",href:"https://sentry.io/for/performance/"},"Sentry Performance")," soon"))),(0,r.kt)("li",{parentName:"ul"},"Accessible via",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Look for the ",(0,r.kt)("inlineCode",{parentName:"li"},"svcops_aws")," project in Grafana.  ",(0,r.kt)("a",{parentName:"li",href:"https://earthangel-b40313e5.influxcloud.net/d/1tthDDrWk/content-server?orgId=1"},"Here is a dashboard with some examples"))))))}c.isMDXComponent=!0}}]);