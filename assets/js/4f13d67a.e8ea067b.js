"use strict";(self.webpackChunkfirefox_ecosystem_platform=self.webpackChunkfirefox_ecosystem_platform||[]).push([[1412],{24111:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>r,contentTitle:()=>o,default:()=>m,frontMatter:()=>s,metadata:()=>l,toc:()=>p});var n=a(87462),i=(a(67294),a(3905));a(29420);const s={title:"Session Tokens"},o="FxA Session Tokens",l={unversionedId:"explanation/session-tokens",id:"explanation/session-tokens",title:"Session Tokens",description:"This is a bit of a braindump, but here we are.",source:"@site/docs/explanation/session-tokens.md",sourceDirName:"explanation",slug:"/explanation/session-tokens",permalink:"/ecosystem-platform/explanation/session-tokens",draft:!1,editUrl:"https://github.com/mozilla/ecosystem-platform/edit/master/docs/explanation/session-tokens.md",tags:[],version:"current",frontMatter:{title:"Session Tokens"},sidebar:"docs",previous:{title:"Content-server architecture",permalink:"/ecosystem-platform/explanation/content-server-architecture"},next:{title:"Additional Docs",permalink:"/ecosystem-platform/additional-docs"}},r={},p=[],u={toc:p};function m(e){let{components:t,...a}=e;return(0,i.kt)("wrapper",(0,n.Z)({},u,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"fxa-session-tokens"},"FxA Session Tokens"),(0,i.kt)("p",null,(0,i.kt)("em",{parentName:"p"},"This is a bit of a braindump, but here we are.")),(0,i.kt)("p",null,"Initially, session tokens were just stored in MySQL with everything else. As part of some work to enable the device manager, we added columns for parsed user-agent info and last-access time, along with a new stored procedure to update a token:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/mozilla/fxa-auth-db-mysql/pull/65"},"https://github.com/mozilla/fxa-auth-db-mysql/pull/65")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/mozilla/fxa-auth-server/pull/997"},"https://github.com/mozilla/fxa-auth-server/pull/997"))),(0,i.kt)("p",null,"However, when we turned it on in prod it caused a significant increase in write IOPS and it had to be backed out:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/mozilla/fxa-auth-server/pull/1169"},"https://github.com/mozilla/fxa-auth-server/pull/1169")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/mozilla/fxa-auth-server/pull/1171"},"https://github.com/mozilla/fxa-auth-server/pull/1171"))),(0,i.kt)("p",null,"So, the decision was taken to move just the new properties into Redis and then aggregate tokens from the two data stores when reading them out:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/mozilla/fxa-auth-server/pull/1968"},"https://github.com/mozilla/fxa-auth-server/pull/1968"))),(0,i.kt)("p",null,"Later, the size of our Redis instance became a growing concern and we did some work to reduce it by removing property keys and by pruning old tokens:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/mozilla/fxa-auth-server/pull/2254"},"https://github.com/mozilla/fxa-auth-server/pull/2254")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/mozilla/fxa-auth-server/pull/2257"},"https://github.com/mozilla/fxa-auth-server/pull/2257"))),(0,i.kt)("p",null,"The latter of those two changes mirrored work that we previously did to prune old session tokens from MySQL:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/mozilla/fxa-auth-server/pull/1996"},"https://github.com/mozilla/fxa-auth-server/pull/1996")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/mozilla/fxa-auth-db-mysql/pull/282"},"https://github.com/mozilla/fxa-auth-db-mysql/pull/282"))),(0,i.kt)("p",null,"Session tokens in MySQL can be associated with a device record. \u201cDevice\u201d is a misleading name here because it really means \u201cFirefox instance\u201d. A true device record would require some kind of reliable fingerprinting mechanism so we could recognise common devices between instances of the browser. When we started tracking metrics for how many devices a user connected, we tried to make accommodations for this by taking into account the operating system details. But in most places in the code, bear in mind that device === browser."),(0,i.kt)("p",null,"A session token that has a device record will never be pruned, because that would break Sync. So we only prune tokens if there\u2019s no corresponding device in the db. And we only prune them if they\u2019re more than 4 weeks old."),(0,i.kt)("p",null,"Pruning from MySQL happens in one of our regular versioned stored procedures, at the time of writing it\u2019s called ",(0,i.kt)("inlineCode",{parentName:"p"},"prune_7"),":"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"packages/fxa-auth-db-mysql/lib/db/schema/patch-068-069.sql")),(0,i.kt)("p",null,"There are properties in config that control this called enablePruning, pruneEvery and pruneTokensMaxAge. The code that uses them is near the top of ",(0,i.kt)("inlineCode",{parentName:"p"},"lib/db/mysql.js")," in the ",(0,i.kt)("inlineCode",{parentName:"p"},"fxa-auth-db-mysql")," package."),(0,i.kt)("p",null,"Pruning from Redis happens opportunistically whenever session tokens are read by calling ",(0,i.kt)("inlineCode",{parentName:"p"},"db.pruneSessionTokens"),". This method is called automatically on every endpoint that is authenticated by session token, via code inside ",(0,i.kt)("inlineCode",{parentName:"p"},"makeCredentialFn")," in ",(0,i.kt)("inlineCode",{parentName:"p"},"lib/server.js")," in the ",(0,i.kt)("inlineCode",{parentName:"p"},"fxa-auth-server")," package. I just noticed it\u2019s also explicitly called by ",(0,i.kt)("inlineCode",{parentName:"p"},"db.sessions")," in ",(0,i.kt)("inlineCode",{parentName:"p"},"lib/db.js"),", which seems unnecessary. Perhaps that is an artifact of some older arrangement, I can\u2019t remember now. We may be able to get rid of it."),(0,i.kt)("p",null,"There are also explicit calls to ",(0,i.kt)("inlineCode",{parentName:"p"},"db.deleteSessionTokenFromRedis")," in all of the places it makes sense to do so. That includes ",(0,i.kt)("inlineCode",{parentName:"p"},"db.createSessionToken"),", to handle any occurrences where a session token id gets reused and the old session token still had data in Redis."))}m.isMDXComponent=!0}}]);