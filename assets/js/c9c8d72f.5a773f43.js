"use strict";(self.webpackChunkfirefox_ecosystem_platform=self.webpackChunkfirefox_ecosystem_platform||[]).push([[8843],{3905:function(e,t,n){n.d(t,{Zo:function(){return m},kt:function(){return h}});var a=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=a.createContext({}),d=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},m=function(e){var t=d(e.components);return a.createElement(s.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},p=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,s=e.parentName,m=l(e,["components","mdxType","originalType","parentName"]),p=d(n),h=i,u=p["".concat(s,".").concat(h)]||p[h]||c[h]||r;return n?a.createElement(u,o(o({ref:t},m),{},{components:n})):a.createElement(u,o({ref:t},m))}));function h(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=p;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:i,o[1]=l;for(var d=2;d<r;d++)o[d]=n[d];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}p.displayName="MDXCreateElement"},53774:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return l},contentTitle:function(){return s},metadata:function(){return d},toc:function(){return m},default:function(){return p}});var a=n(87462),i=n(63366),r=(n(67294),n(3905)),o=["components"],l={title:"How does FxA process email?"},s=void 0,d={unversionedId:"reference/how-does-fxa-process-email",id:"reference/how-does-fxa-process-email",title:"How does FxA process email?",description:"Current as of October 7th, 2019",source:"@site/docs/reference/how-does-fxa-process-email.md",sourceDirName:"reference",slug:"/reference/how-does-fxa-process-email",permalink:"/ecosystem-platform/reference/how-does-fxa-process-email",editUrl:"https://github.com/mozilla/ecosystem-platform/edit/main/website/docs/reference/how-does-fxa-process-email.md",tags:[],version:"current",frontMatter:{title:"How does FxA process email?"},sidebar:"docs",previous:{title:"Incident Response",permalink:"/ecosystem-platform/reference/incident-response"},next:{title:"Localization",permalink:"/ecosystem-platform/reference/localization"}},m=[{value:"fxa-auth-server",id:"fxa-auth-server",children:[],level:2},{value:"Templates",id:"templates",children:[],level:2},{value:"L10n",id:"l10n",children:[],level:2},{value:"Bounces and complaints",id:"bounces-and-complaints",children:[],level:2},{value:"Metrics",id:"metrics",children:[],level:2},{value:"Tests",id:"tests",children:[],level:2},{value:"Bulk mailer",id:"bulk-mailer",children:[],level:2},{value:"How do I\u2026",id:"how-do-i",children:[{value:"...change an existing template?",id:"change-an-existing-template",children:[],level:3},{value:"...add a new template?",id:"add-a-new-template",children:[],level:3},{value:"...change an email subject?",id:"change-an-email-subject",children:[],level:3},{value:"...view rendered templates locally?",id:"view-rendered-templates-locally",children:[],level:3}],level:2}],c={toc:m};function p(e){var t=e.components,n=(0,i.Z)(e,o);return(0,r.kt)("wrapper",(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"Current as of ",(0,r.kt)("inlineCode",{parentName:"p"},"October 7th, 2019")),(0,r.kt)("h2",{id:"fxa-auth-server"},"fxa-auth-server"),(0,r.kt)("p",null,"All of the code for sending email lives in the auth server."),(0,r.kt)("p",null,"Emails are sent by calling methods on the mailer object that is passed around the codebase. The methods are defined by a reducer in ",(0,r.kt)("inlineCode",{parentName:"p"},"lib/senders/index.js")," and have names like ",(0,r.kt)("inlineCode",{parentName:"p"},"sendVerifyEmail"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"sendNewDeviceLoginEmail")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"sendPasswordResetEmail"),", but those are really just thin wrappers that do a little bit of argument marshalling before handing off to other methods that actually do the work. Those are defined in ",(0,r.kt)("inlineCode",{parentName:"p"},"lib/senders/email.js")," and don\u2019t have send in the name, so ",(0,r.kt)("inlineCode",{parentName:"p"},"verifyEmail"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"newDeviceLoginEmail")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"passwordResetEmail")," would be counterparts to the above. Ultimately each of these methods calls ",(0,r.kt)("inlineCode",{parentName:"p"},"send"),", which in turn calls the nuts-and-bolts methods ",(0,r.kt)("inlineCode",{parentName:"p"},"localize"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"render"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"selectEmailServices")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"sendMail"),"."),(0,r.kt)("h2",{id:"templates"},"Templates"),(0,r.kt)("p",null,"The templates are written using handlebars syntax and live under ",(0,r.kt)("inlineCode",{parentName:"p"},"lib/senders/templates"),". Directly in that directory you\u2019ll see templates with names corresponding to the mail-sending methods mentioned above, in HTML and plain text versions. There is also code for rendering the templates in ",(0,r.kt)("inlineCode",{parentName:"p"},"index.js"),", template versions for metrics in ",(0,r.kt)("inlineCode",{parentName:"p"},"_versions.json")," and any pending strings for L10n in ",(0,r.kt)("inlineCode",{parentName:"p"},"_pending.txt"),"."),(0,r.kt)("p",null,"There are also two subdirectories, layouts and partials:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The templates in ",(0,r.kt)("inlineCode",{parentName:"li"},"layouts")," contain outer scaffolding that\u2019s common across emails. For the HTML emails that includes stuff like metadata, header logo and smallprint in the footer. For the plain text emails it\u2019s just the standard footer text. Layout names are specified in the call to ",(0,r.kt)("inlineCode",{parentName:"li"},"render"),"."),(0,r.kt)("li",{parentName:"ul"},"The templates in ",(0,r.kt)("inlineCode",{parentName:"li"},"partials")," contain reusable components that are common to many emails. They\u2019re included inline using the handlebars ",(0,r.kt)("inlineCode",{parentName:"li"},"{{> partialName}}")," syntax.")),(0,r.kt)("h2",{id:"l10n"},"L10n"),(0,r.kt)("p",null,"There is more detailed documentation about localization elsewhere. For the scope of this document though if will suffice to say that there is a grunt task called ",(0,r.kt)("inlineCode",{parentName:"p"},"l10n-extract")," which is run as part of our L10n automation. It extracts strings from templates by looking for the ",(0,r.kt)("inlineCode",{parentName:"p"},'{{t "this string needs translating"}}')," syntax and from JS code by looking for the ",(0,r.kt)("inlineCode",{parentName:"p"},"gettext('this string needs translating')")," syntax.  Stuff like the email subject and variable data for partials will be in the JS code."),(0,r.kt)("p",null,"Bear in mind that occasionally we need to bump the parser version that\u2019s used for the JS code, e.g. when we start using some super-duper newfangled JS features. That\u2019s done in ",(0,r.kt)("inlineCode",{parentName:"p"},"grunttasks/l10n-extract.js"),"."),(0,r.kt)("h2",{id:"bounces-and-complaints"},"Bounces and complaints"),(0,r.kt)("p",null,"[SES delivery, bounce and complaint notifications][aws-notification-docs]"," are published to SQS queues. As well as emitting metrics (see below), we also store bounce records in the auth db whenever a bounce or complaint occurs. The email service then checks those records against thresholds defined in the config and if any thresholds are violated, sending will fail."),(0,r.kt)("p",null,"The bounce and complaint handling code is in ",(0,r.kt)("inlineCode",{parentName:"p"},"lib/email/bounces.js")," but long-term we want to migrate to the email service\u2019s implementation instead, which was written some time ago but has ","[not been deployed yet][3358]",". The motivation for moving is partly semantic, because bounce records don\u2019t really belong in the auth db, but also security, because the email service should not need access to the auth db."),(0,r.kt)("h2",{id:"metrics"},"Metrics"),(0,r.kt)("p",null,"We emit metrics when emails are sent, delivered and when they bounce or complaints are received. A regrettable decision was made to treat complaints as a type of bounce when the metrics were first implemented, which means some of the numbers are unintuitive. Specifically, you might expect that ",(0,r.kt)("inlineCode",{parentName:"p"},"count sent = count delivered + count bounced"),". That\u2019s not true. Instead, ",(0,r.kt)("inlineCode",{parentName:"p"},"count sent = count delivered + count bounced - count complained"),"."),(0,r.kt)("p",null,"The metrics code is slightly confusing because, as mentioned in the previous section, we haven\u2019t finished migrating to the email service yet. That means there\u2019s metrics code we\u2019re using right now and other stuff we\u2019re not using yet, which is waiting for the ","[email service deployment][3358]","."),(0,r.kt)("p",null,"The stuff we\u2019re using right now is in ",(0,r.kt)("inlineCode",{parentName:"p"},"lib/email/delivery.js")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"lib/email/bounces.js"),". These modules receive events directly from SES and should be pretty straightforward to understand."),(0,r.kt)("p",null,"The stuff we\u2019re not using yet is in ",(0,r.kt)("inlineCode",{parentName:"p"},"lib/email/notifications.js"),", which receives events from the email service (using the same format as SES for consistency). That queue won\u2019t receive any events until the above-linked PR is deployed. The story behind it is we want to keep the metrics code in the auth server, even though bounce and complaint handling is moving away."),(0,r.kt)("p",null,"The two handlers are designed to co-exist, so it\u2019s fine for them both to be in operation when the email service stuff gets deployed, they\u2019ll just compete for events without duplicating any metrics or whatever. When we\u2019re happy that the email service is behaving correctly, we should land the draft PR that I worked on to remove the old SQS handlers from the auth server: ","[#2192][2192]","."),(0,r.kt)("h2",{id:"tests"},"Tests"),(0,r.kt)("p",null,"Historically the email tests have been a burden to maintain because there\u2019s so many of them, and it\u2019s easy for such a large volume of tests to obscure the presence of bugs."),(0,r.kt)("p",null,"The main test cases are in ",(0,r.kt)("inlineCode",{parentName:"p"},"test/local/senders/email.js"),", declared as data in maps called ",(0,r.kt)("inlineCode",{parentName:"p"},"TESTS")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"COMMON_TESTS"),". Taking a declarative approach like this made it easier to get a feel for the test coverage and spot gaps in it. It also ensured we had common test cases that are applied to every email, e.g. we can make sure there are no HTML character entities in the plain text emails and that required headers are always set."),(0,r.kt)("h2",{id:"bulk-mailer"},"Bulk mailer"),(0,r.kt)("p",null,"There have been unfortunate occasions in the past where it became necessary to manually send email out to large subsets of our user base. Shane wrote a script that does this, ",(0,r.kt)("inlineCode",{parentName:"p"},"scripts/bulk-mailer.js"),". Run ",(0,r.kt)("inlineCode",{parentName:"p"},"node scripts/bulk-mailer --help")," to see usage information."),(0,r.kt)("h2",{id:"how-do-i"},"How do I\u2026"),(0,r.kt)("h3",{id:"change-an-existing-template"},"...change an existing template?"),(0,r.kt)("ol",{start:0},(0,r.kt)("li",{parentName:"ol"},"Find the template you want to change in ",(0,r.kt)("inlineCode",{parentName:"li"},"lib/senders/templates"),"."),(0,r.kt)("li",{parentName:"ol"},"Make sure you update both the HTML and plain text forms of your template."),(0,r.kt)("li",{parentName:"ol"},"If you need to make changes in ",(0,r.kt)("inlineCode",{parentName:"li"},"layouts")," or ",(0,r.kt)("inlineCode",{parentName:"li"},"partials"),", ensure you don\u2019t break other templates."),(0,r.kt)("li",{parentName:"ol"},"Change or add test data in ",(0,r.kt)("inlineCode",{parentName:"li"},"TESTS")," in ",(0,r.kt)("inlineCode",{parentName:"li"},"test/local/senders/email.js"),"."),(0,r.kt)("li",{parentName:"ol"},"Bump the template version(s) in ",(0,r.kt)("inlineCode",{parentName:"li"},"lib/senders/templates/_versions.json"),", so that metrics can attribute any changes to the template change."),(0,r.kt)("li",{parentName:"ol"},"If you\u2019re changing strings, make sure you\u2019ve made the cut for L10n. If you want to avoid missing the cut, land strings ahead of time in ",(0,r.kt)("inlineCode",{parentName:"li"},"lib/senders/templates/_pending.txt"),".")),(0,r.kt)("h3",{id:"add-a-new-template"},"...add a new template?"),(0,r.kt)("ol",{start:0},(0,r.kt)("li",{parentName:"ol"},"Add HTML and plain text copies in ",(0,r.kt)("inlineCode",{parentName:"li"},"lib/senders/templates"),"."),(0,r.kt)("li",{parentName:"ol"},"Add a version property to ",(0,r.kt)("inlineCode",{parentName:"li"},"lib/senders/templates/_versions.json"),". Set it to 1."),(0,r.kt)("li",{parentName:"ol"},"Add a corresponding method to ",(0,r.kt)("inlineCode",{parentName:"li"},"lib/senders/email.js"),". Make sure that method calls send with the subject and any template data you need."),(0,r.kt)("li",{parentName:"ol"},"Invoke your method from the code as ",(0,r.kt)("inlineCode",{parentName:"li"},"mailer.send...Email"),"."),(0,r.kt)("li",{parentName:"ol"},"Add new test data to ",(0,r.kt)("inlineCode",{parentName:"li"},"TESTS")," in ",(0,r.kt)("inlineCode",{parentName:"li"},"test/local/senders/email.js"),".")),(0,r.kt)("h3",{id:"change-an-email-subject"},"...change an email subject?"),(0,r.kt)("ol",{start:0},(0,r.kt)("li",{parentName:"ol"},"Make the change in the relevant method in ",(0,r.kt)("inlineCode",{parentName:"li"},"lib/senders/email.js"),"."),(0,r.kt)("li",{parentName:"ol"},"Make sure the string is wrapped inside a call to gettext, so that the L10n automation can translate it."),(0,r.kt)("li",{parentName:"ol"},"Update the test data in ",(0,r.kt)("inlineCode",{parentName:"li"},"TESTS")," in ",(0,r.kt)("inlineCode",{parentName:"li"},"test/local/senders/email.js"),".")),(0,r.kt)("h3",{id:"view-rendered-templates-locally"},"...view rendered templates locally?"),(0,r.kt)("ol",{start:0},(0,r.kt)("li",{parentName:"ol"},"Run ",(0,r.kt)("inlineCode",{parentName:"li"},"node scripts/write-emails-to-disk")," all then open the ",(0,r.kt)("inlineCode",{parentName:"li"},".mail_output")," directory in your browser. A rendered copy of every template will be there."),(0,r.kt)("li",{parentName:"ol"},"Note this is not a substitute for testing changes in a real mail client. Email rendering is famously unreliable.")))}p.isMDXComponent=!0}}]);