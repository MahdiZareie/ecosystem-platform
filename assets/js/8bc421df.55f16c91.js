"use strict";(self.webpackChunkfirefox_ecosystem_platform=self.webpackChunkfirefox_ecosystem_platform||[]).push([[8062],{4130:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>r,contentTitle:()=>o,default:()=>p,frontMatter:()=>l,metadata:()=>s,toc:()=>m});var n=a(7462),i=(a(7294),a(3905));a(1839);const l={title:"Emails"},o=void 0,s={unversionedId:"reference/emails",id:"reference/emails",title:"Emails",description:"Current as of April 11, 2022",source:"@site/docs/reference/emails.md",sourceDirName:"reference",slug:"/reference/emails",permalink:"/ecosystem-platform/reference/emails",draft:!1,editUrl:"https://github.com/mozilla/ecosystem-platform/edit/master/docs/reference/emails.md",tags:[],version:"current",frontMatter:{title:"Emails"},sidebar:"docs",previous:{title:"Incident Response",permalink:"/ecosystem-platform/reference/incident-response"},next:{title:"Localization",permalink:"/ecosystem-platform/reference/localization"}},r={},m=[{value:"fxa-auth-server",id:"fxa-auth-server",level:2},{value:"Triggering emails locally",id:"triggering-emails-locally",level:2},{value:"Templates",id:"templates",level:2},{value:"Previewing Emails and Storybook",id:"previewing-emails-and-storybook",level:3},{value:"write-emails-to-disk.js",id:"write-emails-to-diskjs",level:4},{value:"Styles",id:"styles",level:3},{value:"MJML styling caveats",id:"mjml-styling-caveats",level:4},{value:"Email subjects and actions",id:"email-subjects-and-actions",level:3},{value:"Localization (L10n)",id:"localization-l10n",level:3},{value:"Images and localizing alt text",id:"images-and-localizing-alt-text",level:3},{value:"Bounces and complaints",id:"bounces-and-complaints",level:2},{value:"Bounce types",id:"bounce-types",level:3},{value:"Metrics",id:"metrics",level:2},{value:"Tests",id:"tests",level:2},{value:"Bulk mailer",id:"bulk-mailer",level:2},{value:"How do I\u2026",id:"how-do-i",level:2},{value:"...change an existing template?",id:"change-an-existing-template",level:3},{value:"...add a new template?",id:"add-a-new-template",level:3},{value:"...change an email subject?",id:"change-an-email-subject",level:3},{value:"...view rendered templates locally?",id:"view-rendered-templates-locally",level:3},{value:"Relevant ADRs",id:"relevant-adrs",level:2}],d={toc:m};function p(e){let{components:t,...a}=e;return(0,i.kt)("wrapper",(0,n.Z)({},d,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"Current as of ",(0,i.kt)("inlineCode",{parentName:"p"},"April 11, 2022")),(0,i.kt)("h2",{id:"fxa-auth-server"},"fxa-auth-server"),(0,i.kt)("p",null,"All of the code for sending email lives in the ",(0,i.kt)("inlineCode",{parentName:"p"},"fxa-auth-server"),". FxA uses nodemailer and AWS SES to send its emails."),(0,i.kt)("p",null,"Emails are sent by calling methods on the mailer object that are passed around the codebase. The methods are defined by a reducer in ",(0,i.kt)("inlineCode",{parentName:"p"},"lib/senders/index.js")," and have names like ",(0,i.kt)("inlineCode",{parentName:"p"},"sendVerifyEmail"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"sendNewDeviceLoginEmail")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"sendPasswordResetEmail"),", but those are really just thin wrappers that do a little bit of argument marshalling before handing off to other methods that actually do the work. Those are defined in ",(0,i.kt)("inlineCode",{parentName:"p"},"lib/senders/email.js")," and don\u2019t have send in the name, so ",(0,i.kt)("inlineCode",{parentName:"p"},"verifyEmail"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"newDeviceLoginEmail")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"passwordResetEmail")," would be counterparts to the above. Ultimately each of these methods calls ",(0,i.kt)("inlineCode",{parentName:"p"},"send"),", which in turn calls the nuts-and-bolts methods ",(0,i.kt)("inlineCode",{parentName:"p"},"localize"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"render"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"selectEmailServices")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"sendMail"),"."),(0,i.kt)("h2",{id:"triggering-emails-locally"},"Triggering emails locally"),(0,i.kt)("p",null,"Check out ",(0,i.kt)("a",{parentName:"p",href:"../how-tos/creating-an-account-locally"},"creating an account locally")," as well as our ",(0,i.kt)("a",{parentName:"p",href:"/ecosystem-platform/how-tos/local-emails-with-maildev"},"local emails with MailDev")," docs. Almost every email can be triggered locally by walking through the flow locally to trigger an email, but certain environment variables may be different across staging and production than they are locally."),(0,i.kt)("p",null,"If you want to run CAD (connect another device) emails locally, update ",(0,i.kt)("inlineCode",{parentName:"p"},"dev.json")," to something like this:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'"cadReminders": {\n  "firstInterval": "1s",\n  "secondInterval": "2s"\n},\n')),(0,i.kt)("p",null,"Then, run:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"NODE_ENV=dev ./scripts/verification-reminders.js\n")),(0,i.kt)("h2",{id:"templates"},"Templates"),(0,i.kt)("p",null,"FxA emails use ",(0,i.kt)("a",{parentName:"p",href:"https://ejs.co/"},"EJS")," to allow logic and conditional rendering without additional helper methods, ",(0,i.kt)("a",{parentName:"p",href:"https://mjml.io/"},"MJML")," to shift the burden of maintaining solutions for email quirks off of FxA engineers, ",(0,i.kt)("a",{parentName:"p",href:"https://sass-lang.com/"},"SCSS")," with ",(0,i.kt)("a",{parentName:"p",href:"https://tailwindcss.com/"},"Tailwind"),"-like classes compiled down to inline CSS for easy maintenance and consistency, and ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/projectfluent/fluent.js/tree/master/fluent-dom"},"Fluent")," for localization. We also create ",(0,i.kt)("a",{parentName:"p",href:"https://storybook.js.org/"},"Storybook")," stories to preview emails and for documentation purposes. ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/mozilla/fxa/blob/main/docs/adr/0024-upgrade-templating-toolset-of-auth-server-emails.md"},"See this ADR")," for more details on why this stack was chosen."),(0,i.kt)("p",null,"A small example of how template variables are passed down from the mailer object and consumed in the templates:"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"email.js"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"Mailer.prototype.verifyLoginCodeEmail = async function (message) {\n  // ... Logging for metrics, setting headers, and assigning other variables\n\n  return this.send({\n  ...message,\n  // always send appropriate headers\n  headers,\n  // always specify the name of the template\n  template: 'verifyLoginCode',\n  templateValues: {\n    code: message.code,\n    // ... all other templateValues\n}\n")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"layout")," defaults to ",(0,i.kt)("inlineCode",{parentName:"p"},"fxa"),". Pass in ",(0,i.kt)("inlineCode",{parentName:"p"},"layout: 'subscription'")," at the same level ",(0,i.kt)("inlineCode",{parentName:"p"},"headers")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"template")," is at (",(0,i.kt)("em",{parentName:"p"},"outside")," of the ",(0,i.kt)("inlineCode",{parentName:"p"},"templateValues")," object) for the SubPlat layout."),(0,i.kt)("p",null,"Corresponding MJML/EJS:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-html"},'<mj-section>\n  <mj-column>\n    // other MJML elements and strings\n\n    <mj-text css-class="code-large"><%- code %></mj-text>\n\n    // other MJML elements and strings\n  </mj-column>\n</mj-section>\n\n')),(0,i.kt)("p",null,'Emails have a "campaign" assigned to them in a key/value map in ',(0,i.kt)("inlineCode",{parentName:"p"},"email.js"),", as well as a ",(0,i.kt)("inlineCode",{parentName:"p"},"_versions.json")," file for metrics. Every email has a rich HTML version as well as a plaintext version for users that prefer to see plaintext emails instead. Sometimes, the HTML version and plaintext version differ very slightly, but as a rule of thumb they should generally match for a consistent experience."),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"lib/senders/emails")," contains ",(0,i.kt)("inlineCode",{parentName:"p"},"layouts"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"partials"),", and ",(0,i.kt)("inlineCode",{parentName:"p"},"templates.")," Layouts contain outer scaffolding that\u2019s common across emails, like headers and footers. Partials contain reusable components that are common to many emails. Templates are the actual body of emails, and their names map to conventions described at the beginning of this doc, without the words 'send' or 'email', e.g. ",(0,i.kt)("inlineCode",{parentName:"p"},"verify"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"newDeviceLogin")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"passwordReset")," etc."),(0,i.kt)("h3",{id:"previewing-emails-and-storybook"},"Previewing Emails and Storybook"),(0,i.kt)("p",null,"You can quickly preview all emails ",(0,i.kt)("a",{parentName:"p",href:"https://storage.googleapis.com/mozilla-storybooks-fxa/commits/latest/fxa-auth-server/index.html"},"here"),", or alternatively run ",(0,i.kt)("inlineCode",{parentName:"p"},"yarn storybook")," in the auth-server. We maintain Storybook for all FxA emails as a single source of truth for documentation; every email should have a clear description noting when and why we send the email, and all email states should be accounted for when updating or creating a new email template."),(0,i.kt)("p",null,"Check out our docs on ",(0,i.kt)("a",{parentName:"p",href:"/ecosystem-platform/reference/storybook-deploys-with-circleci"},"Storybook deploys with CircleCI")," for details on how to preview changes in PRs or to send a link out to anyone who may need to see FxA email copy or documentation."),(0,i.kt)("admonition",{type:"note"},(0,i.kt)("p",{parentName:"admonition"},"Emails previewed in HTML are meant to be a rough representation of what an email will look like in an email client. They're essentially identical and MJML helps us with consistency, but keep in mind you're previewing in a browser when emails may be viewed in email clients in practice.")),(0,i.kt)("p",null,"We couple Storybook with the ",(0,i.kt)("inlineCode",{parentName:"p"},"merge-ftl")," grunttask to display strings from our ",(0,i.kt)("inlineCode",{parentName:"p"},"en.ftl")," files (see the l10n section for more details). At the time of writing, Storybook is our way to preview or manually check the English strings we ultimately pass to translators, and our tests cover the English fallback copy."),(0,i.kt)("p",null,"In addition to running locally, Storybook can be built into a static format. This is ultimately what happens in our CI. This static format is then deployed and manual QA may be conducted against it. To test what this will look like, run ",(0,i.kt)("inlineCode",{parentName:"p"},"yarn build-storybook")," then navigate to the ",(0,i.kt)("inlineCode",{parentName:"p"},"storybook-static")," folder and run ",(0,i.kt)("inlineCode",{parentName:"p"},"http-server . -p 8081"),". From there, simply navigate to ",(0,i.kt)("inlineCode",{parentName:"p"},"http://locahost:8081/index.html")," and you will see the resulting static build. ",(0,i.kt)("em",{parentName:"p"},"(If you don't have ",(0,i.kt)("inlineCode",{parentName:"em"},"http-server")," installed, simply run ",(0,i.kt)("inlineCode",{parentName:"em"},"npm install -g http-server"),")")),(0,i.kt)("admonition",{type:"info"},(0,i.kt)("p",{parentName:"admonition"},"The previews in Storybook are generated using the ",(0,i.kt)("inlineCode",{parentName:"p"},"mjml-browser")," module and not the de facto ",(0,i.kt)("inlineCode",{parentName:"p"},"mjml")," module. The difference is subtle but important. As the name indicates, ",(0,i.kt)("inlineCode",{parentName:"p"},"mjml-browser")," is designed to render from a browser context, whereas mjml uses a nodejs context. Ideally these modules would be identical, but at the time of writing this, there are a couple of ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/mjmlio/mjml/tree/master/packages/mjml-browser#unavailable-features"},"minor differences"),". Our code introduces a couple work arounds to achieve parity with the way templates would be rendered using the ",(0,i.kt)("inlineCode",{parentName:"p"},"mjml")," module. If styles in sent out emails ever seem off, consider this discrepancy as an unlikely but potential source of error.")),(0,i.kt)("h4",{id:"write-emails-to-diskjs"},"write-emails-to-disk.js"),(0,i.kt)("p",null,"Before Storybook, the only way to preview emails was to run ",(0,i.kt)("inlineCode",{parentName:"p"},"yarn write-emails")," which runs the ",(0,i.kt)("inlineCode",{parentName:"p"},"write-emails-to-disk.js")," script. This runs through each ",(0,i.kt)("inlineCode",{parentName:"p"},"Mailer.prototype.templateNameEmail")," function and writes its output to disk. This script has a lot of limitations that Storybook makes up for, but is still around because it actually creates an instance of our Mailer and gives us a more production-like output with real links generated from the server with UTM parameters. Because of this, it's also useful sometimes for debugging."),(0,i.kt)("p",null,"At the time of writing, we are maintaining use of the script ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/mozilla/fxa/issues/10601"},"until it can be phased out"),"."),(0,i.kt)("h3",{id:"styles"},"Styles"),(0,i.kt)("p",null,"We use ",(0,i.kt)("inlineCode",{parentName:"p"},"scss")," stylesheets compiled to CSS and inlined by MJML for maximum mail client compatibility. We maintain shared stylesheets with common styles and variables, and template or partial-specific stylesheets scoped to that template or partial."),(0,i.kt)("p",null,"FxA created a ",(0,i.kt)("a",{parentName:"p",href:"https://storage.googleapis.com/mozilla-storybooks-fxa/index.html"},"styleguide"),' (click on a recent commit, and go into "fxa-settings"; also see ',(0,i.kt)("a",{parentName:"p",href:"https://github.com/mozilla/fxa/tree/main/packages/fxa-settings#styling-components"},'"styling components" in ',(0,i.kt)("inlineCode",{parentName:"a"},"fxa-settings")),") for engineers to reference convenience classes provided by Tailwind, which we use in other major front-end packages. While we would love to use Tailwind itself, it would have added even more complexity to the build pipeline and was not immediately compatible with MJML. Instead, we use class name conventions and styles that mirror Tailwind classes as using the closest ",(0,i.kt)("inlineCode",{parentName:"p"},"px")," value to the design guide for consistency across FxA's CSS."),(0,i.kt)("p",null,"Use SCSS variables set to mirror Tailwind's values, like for colors, ",(0,i.kt)("inlineCode",{parentName:"p"},"margin"),", and ",(0,i.kt)("inlineCode",{parentName:"p"},"padding"),", typically in the global file. Try to use existing, or create new, helper utility classes, when needed, that are similar to Tailwind's classes."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-scss"},"$s-2: 8px;\n$s-5: 20px;\n\n.mt {\n  &-2 {\n    margin-top: $s-2 !important;\n  }\n  &-5 {\n    margin-top: $s-5 !important;\n  }\n  ...\n")),(0,i.kt)("p",null,"Use ",(0,i.kt)("inlineCode",{parentName:"p"},"@extend")," and placeholder selectors where appropriate."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-scss"},".font-sans {\n  font-family: $font-sans !important;\n}\n\n.link-blue {\n  @extend .text-blue-400, .font-sans;\n  text-decoration: none;\n}\n\n%text-body-common {\n  @extend .font-sans;\n}\n")),(0,i.kt)("p",null,"Then use the placeable:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-scss"},".text-body-no-margin div {\n  @extend %text-body-common;\n}\n\n.text-body div {\n  @extend %text-body-common;\n  @extend .mb-5;\n}\n")),(0,i.kt)("p",null,"If it makes more sense to scope changes to a certain layout file or component file, do so. You'll have to import any files that have references you need to use, and reference any variables with ",(0,i.kt)("inlineCode",{parentName:"p"},"global.")," in front."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-scss"},"@use '../../global.scss';\n@use '../../layouts/fxa/index.scss';\n\n.text-body-grey-no-margin div {\n  @extend %text-body-common;\n  color: global.$grey-500 !important;\n}\n\n.text-body-grey {\n  @extend .text-body-grey-no-margin;\n  div {\n    @extend .mb-6;\n  }\n}\n")),(0,i.kt)("h4",{id:"mjml-styling-caveats"},"MJML styling caveats"),(0,i.kt)("p",null,"MJML internally adds some default styling to their elements and use ",(0,i.kt)("inlineCode",{parentName:"p"},"!important")," for better coverage of mail client quirks. This means if we add custom styles to overwrite theirs, we inevitably also need to use ",(0,i.kt)("inlineCode",{parentName:"p"},"!important"),". With that in mind, we should ",(0,i.kt)("em",{parentName:"p"},"not")," use it unless we explicitely need to."),(0,i.kt)("p",null,"Sometimes, styling classes is not always how it seems due to how MJML compiles into HTML, and you may need to add ",(0,i.kt)("inlineCode",{parentName:"p"},"div")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"td")," after the class to target that specific element."),(0,i.kt)("h3",{id:"email-subjects-and-actions"},"Email subjects and actions"),(0,i.kt)("p",null,"Every template has either an ",(0,i.kt)("inlineCode",{parentName:"p"},"includes.json")," file or an ",(0,i.kt)("inlineCode",{parentName:"p"},"includes.ts")," file where email subjects and optionally, actions, are housed. These are pulled in and localized ",(0,i.kt)("em",{parentName:"p"},"before"),' the email is rendered because 1) these values are needed in layout files and aren\'t easily localized since "subject" goes inside an ',(0,i.kt)("inlineCode",{parentName:"p"},"mj-title"),' and "action" goes in a script in ',(0,i.kt)("inlineCode",{parentName:"p"},"metadata.mjml"),' (where would we insert the Fluent IDs in the DOM?) and 2) we need to return a localized "subject" back to the Mailer anyway.'),(0,i.kt)("p",null,"Use ",(0,i.kt)("inlineCode",{parentName:"p"},"includes.json")," unless logic is required to determine the subject or action like so:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "subject": {\n    "id": "verify-subject",\n    "message": "Finish creating your account"\n  },\n  "action": {\n    "id": "verify-action",\n    "message": "Confirm email"\n  }\n}\n')),(0,i.kt)("p",null,"Then in the corresponding FTL file:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ftl"},"verify-subject = Finish creating your account\nverify-action = Confirm email\n")),(0,i.kt)("p",null,"If you need logic, you must create a function that is returned at the import step after checking for the template name. An example of ",(0,i.kt)("inlineCode",{parentName:"p"},"includes.ts"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"import { GlobalTemplateValues } from '../../../renderer';\n\nconst getSubject = (numberRemaining: number) =>\n  numberRemaining === 1\n    ? '1 recovery code remaining'\n    : '<%= numberRemaining %> recovery codes remaining';\n\nexport const getIncludes = (numberRemaining: number): GlobalTemplateValues => ({\n  subject: {\n    id: 'lowRecoveryCodes-subject',\n    message: getSubject(numberRemaining),\n  },\n  action: {\n    id: 'lowRecoveryCodes-action',\n    message: 'Confirm email',\n  },\n});\n\nexport default getIncludes;\n")),(0,i.kt)("p",null,"The corresponding FTL file:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"lowRecoveryCodes-subject =\n    { $numberRemaining ->\n        [one] 1 recovery code remaining\n       *[other] { $numberRemaining } recovery codes remaining\n   }\n")),(0,i.kt)("p",null,"And then, in the Renderer, check for the template and dynamically import the required file with the argument it expects:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"if (context.template === 'lowRecoveryCodes') {\n  return (\n    await require('../emails/templates/lowRecoveryCodes/includes')\n  ).getIncludes(context.numberRemaining);\n}\n")),(0,i.kt)("h3",{id:"localization-l10n"},"Localization (L10n)"),(0,i.kt)("admonition",{type:"note"},(0,i.kt)("p",{parentName:"admonition"},"See also ",(0,i.kt)("a",{parentName:"p",href:"localization"},"this deep dive on Localization"),".")),(0,i.kt)("p",null,"Strings are automatically extracted to the ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/mozilla/fxa-content-server-l10n"},(0,i.kt)("inlineCode",{parentName:"a"},"fxa-content-server-l10n")," repo")," where they reach Pontoon for translations to occur by our l10n team and contributors. This is achieved by concatenating all of our .ftl (Fluent) files into a single ",(0,i.kt)("inlineCode",{parentName:"p"},"auth.ftl")," file with the ",(0,i.kt)("inlineCode",{parentName:"p"},"merge-ftl")," grunttask, and the ",(0,i.kt)("inlineCode",{parentName:"p"},"extract-and-pull-request.sh")," script that runs in ",(0,i.kt)("inlineCode",{parentName:"p"},"fxa-content-server-l10n")," on a weekly cadence."),(0,i.kt)("p",null,"Non-email strings that must be translated are placed directly in ",(0,i.kt)("inlineCode",{parentName:"p"},"lib/l10n/auth.ftl"),", under any brands we have set to ",(0,i.kt)("a",{parentName:"p",href:"https://projectfluent.org/fluent/guide/references.html"},"message references"),". Email strings for translation are placed in a nearby (",(0,i.kt)("inlineCode",{parentName:"p"},"templates/[templateName]/en.ftl")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"partials/[partialName]/en.ftl"),")."),(0,i.kt)("p",null,"Fluent requires a Fluent ID to find the translated string in other languages, but MJML doesn't support custom attributes since an MJML element may produce many HTML elements. We pass our email templates into ",(0,i.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/@fluent/dom"},(0,i.kt)("inlineCode",{parentName:"a"},"@fluent/dom"))," and provide Fluent an FTL ID by ensuring strings wrapped in a DOM element, like a ",(0,i.kt)("inlineCode",{parentName:"p"},"span"),", where we can supply the ID via ",(0,i.kt)("inlineCode",{parentName:"p"},"data-l10n-id"),"."),(0,i.kt)("p",null,"We don't have a hard rule for FTL ID naming but generally we start the ID matching the template, partial, or variable name, or a shortened version of it which may be snake-case or camelCase, followed by a short, snake case summary of the text."),(0,i.kt)("admonition",{type:"tip"},(0,i.kt)("p",{parentName:"admonition"},"You must use curly quotes for strings in our MJML, plaintext, and FTL files, except in comments. They're considered more proper for copy and the l10n team will push back against straight quotes.")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"subscriptionSupportContact")," MJML partial:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-html"},'<mj-text css-class="text-body">\n  <span data-l10n-id="subscriptionSupportContact" data-l10n-args="<%= JSON.stringify({productName}) %>">\n    Thank you for subscribing to <%- productName %>. If you have any questions about your subscription or need more information about <%- productName %>, please <a data-l10n-name="subscriptionSupportUrl" href="<%- subscriptionSupportUrl %>">contact us</a>.\n  </span>\n</mj-text>\n')),(0,i.kt)("p",null,"We use ",(0,i.kt)("inlineCode",{parentName:"p"},"JSON.stringify")," to ensure all values are JSON strings as expected. Note that at the time of writing, we have a spike open for l10n improvements across FxA (",(0,i.kt)("a",{parentName:"p",href:"https://mozilla-hub.atlassian.net/browse/FXA-4477"},"FXA-4477"),"), including not needing to specify ",(0,i.kt)("inlineCode",{parentName:"p"},"data-l10n-args"),"."),(0,i.kt)("p",null,"We also use Fluent to localize our plaintext. Strings in plaintext should follow a ",(0,i.kt)("inlineCode",{parentName:"p"},'fluent-id = "default value provided"')," pattern where value of ",(0,i.kt)("inlineCode",{parentName:"p"},"fluent-id")," is same as ",(0,i.kt)("inlineCode",{parentName:"p"},"data-l10n-id")," attribute of the corresponding markup element. If ",(0,i.kt)("inlineCode",{parentName:"p"},"fluent-id")," is present in Fluent bundle, the text will be localized, else it will be replaced with the fallback value present. In cases where we don't need localization, like for directly outputting a variable, use EJS instead and it will be rendered as-is."),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"subscriptionSupportContact")," plaintext partial:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'subscriptionSupportContact-plaintext = "Thank you for subscribing to <%- productName %>. If you have any questions about your subscription or need more information about <%- productName %>, please contact us:"\n<%- subscriptionSupportUrl %>\n')),(0,i.kt)("p",null,"Every variable should have a comment to help translators with context. It can also be helpful to let translators know what a word's intent is if it can be ambiguous, or to let them know if something is followed by a link."),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"subscriptionSupportContact")," FTL:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'# Variables\n#   $productName (String) - The name of the subscribed product, e.g. Mozilla VPN\nsubscriptionSupportContact = Thank you for subscribing to { $productName }. If you have any questions about your subscription or need more information about { $productName }, please <a data-l10n-name="subscriptionSupportUrl">contact us</a>.\n# After the colon, there\'s a link to https://accounts.firefox.com/support\nsubscriptionSupportContact-plaintext = Thank you for subscribing to { $productName }. If you have any questions about your subscription or need more information about { $productName }, please contact us:\n')),(0,i.kt)("p",null,"If the element you need translated is already wrapped in a non-MJML tag, like ",(0,i.kt)("inlineCode",{parentName:"p"},"b"),", or ",(0,i.kt)("inlineCode",{parentName:"p"},"li"),", supply the ",(0,i.kt)("inlineCode",{parentName:"p"},"data-l10n-id")," on that element instead of creating an extra ",(0,i.kt)("inlineCode",{parentName:"p"},"span")," DOM element."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'<b data-l10n-id="payment-details">Payment details:</b>\n')),(0,i.kt)("p",null,"You do ",(0,i.kt)("em",{parentName:"p"},"not")," need a ",(0,i.kt)("inlineCode",{parentName:"p"},"data-l10n-id")," on strings that only contains a variable since the variable won't be localized."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'<mj-text css-class="code-large"><%- code %></mj-text>\n')),(0,i.kt)("p",null,"Fluent will overlay the translation onto the source fragment preserving attributes like ",(0,i.kt)("inlineCode",{parentName:"p"},"class")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"href")," from the source and adding translations for the elements inside."),(0,i.kt)("admonition",{type:"warning"},(0,i.kt)("p",{parentName:"admonition"},"If you need to change a string, you must also update the Fluent ID. Generally speaking, we just append a ",(0,i.kt)("inlineCode",{parentName:"p"},"-2")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"-v2")," to the string if it's a rewording or we create a new ID entirely if the copy is significantly different. We must do this because IDs are saved in Pontoon and tied to translations for the original string."),(0,i.kt)("p",{parentName:"admonition"},"If you change a variable name and not the string text around it, technically you also need a new ID since the string is not identical. However, to not lose existing translations, you can also find-and-replace the variable name in that ID across locales in the l10n repo directly before or after your PR in ",(0,i.kt)("inlineCode",{parentName:"p"},"fxa")," is merged. You must coordinate with the l10n team if you plan to do this. ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/mozilla/fxa-content-server-l10n/pull/559"},"See a PR")," where we did this.")),(0,i.kt)("p",null,"At the time of writing, Storybook is our way to preview or manually check the English strings we ultimately pass to translators, and our tests cover the English fallback copy."),(0,i.kt)("h3",{id:"images-and-localizing-alt-text"},"Images and localizing alt text"),(0,i.kt)("p",null,"You ",(0,i.kt)("em",{parentName:"p"},"must")," provide a ",(0,i.kt)("inlineCode",{parentName:"p"},"width")," on ",(0,i.kt)("inlineCode",{parentName:"p"},"mj-image")," tags. Otherwise, the parent width will be used in at least MacOS' native Mail app, resulting in large, 100% width images. See ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/mozilla/fxa/pull/11840"},"this PR")," for more details."),(0,i.kt)("p",null,"Since we must pass Fluent an FTL ID for each string to be localized, localizing alt text for images is tricky. We use ",(0,i.kt)("a",{parentName:"p",href:"https://documentation.mjml.io/#mj-html-attributes"},(0,i.kt)("inlineCode",{parentName:"a"},"mj-html-attributes"))," to add a custom attribute where we need them, and all of our images are given these HTML attributes in an ",(0,i.kt)("inlineCode",{parentName:"p"},"images.mjml")," file pulled into every layout file:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-html"},'<mj-selector path=".mozilla-logo a">\n  <mj-html-attribute name="data-l10n-id">subplat-footer-mozilla-logo</mj-html-attribute>\n</mj-selector>\n')),(0,i.kt)("p",null,"In MJML layout:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-html"},'\x3c!--- remember to always provide a width ---\x3e\n<mj-image css-class="mozilla-logo"\n  width="120px"\n  href="https://www.mozilla.org"\n  src="https://accounts-static.cdn.mozilla.net/product-icons/mozilla-logo.png"\n  alt="Mozilla logo"\n  title="Mozilla">\n</mj-image>\n')),(0,i.kt)("p",null,"In corresponding FTL files:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'subplat-footer-mozilla-logo = <img data-l10n-name="mozilla-logo" alt="{ -brand-mozilla } logo">\n')),(0,i.kt)("p",null,"We could have technically localized strings this way as well rather than wrap text elements in ",(0,i.kt)("inlineCode",{parentName:"p"},"span"),"s, but that would have been significantly messier and confusing."),(0,i.kt)("h2",{id:"bounces-and-complaints"},"Bounces and complaints"),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/ses/latest/dg/notification-contents.html"},"SES delivery, bounce and complaint notifications")," are published to SQS queues. As well as emitting metrics (see below), we also store bounce records in the auth db whenever a bounce or complaint occurs. The email service then checks those records against thresholds defined in the config and if any thresholds are violated, sending will fail."),(0,i.kt)("p",null,"The bounce and complaint handling code is in ",(0,i.kt)("inlineCode",{parentName:"p"},"lib/email/bounces.js")," but long-term we want to migrate to the email service\u2019s implementation instead, which was written some time ago but has not been deployed yet. The motivation for moving is partly semantic, because bounce records don\u2019t really belong in the auth db, but also security, because the email service should not need access to the auth db."),(0,i.kt)("h3",{id:"bounce-types"},"Bounce types"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"bounceType"),(0,i.kt)("th",{parentName:"tr",align:null},"bounceSubType"),(0,i.kt)("th",{parentName:"tr",align:null},"Description"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"Undetermined")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"Undetermined")),(0,i.kt)("td",{parentName:"tr",align:null},"The recipient's email provider sent a bounce message. The bounce message didn't contain enough information for Amazon SES to determine the reason for the bounce. The bounce email, which was sent to the address in the Return-Path header of the email that resulted in the bounce, might contain additional information about the issue that caused the email to bounce.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"Permanent")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"General")),(0,i.kt)("td",{parentName:"tr",align:null},"The recipient's email provider sent a hard bounce message, but didn't specify the reason for the hard bounce.",(0,i.kt)("br",null),"\u26a0\ufe0f ",(0,i.kt)("strong",{parentName:"td"},"Important"),(0,i.kt)("br",null),"When you receive this type of bounce notification, you should immediately remove the recipient's email address from your mailing list. Sending messages to addresses that produce hard bounces can have a negative impact on your reputation as a sender. If you continue sending email to addresses that produce hard bounces, we might pause your ability to send additional email.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"Permanent")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"NoEmail")),(0,i.kt)("td",{parentName:"tr",align:null},"The intended recipient's email provider sent a bounce message indicating that the email address doesn't exist.",(0,i.kt)("br",null),"\u26a0\ufe0f ",(0,i.kt)("strong",{parentName:"td"},"Important"),(0,i.kt)("br",null),"When you receive this type of bounce notification, you should immediately remove the recipient's email address from your mailing list. Sending messages to addresses that don't exist can have a negative impact on your reputation as a sender. If you continue sending email to addresses that don't exist, we might pause your ability to send additional email.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"Permanent")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"Suppressed")),(0,i.kt)("td",{parentName:"tr",align:null},"The recipient's email address is on the Amazon SES suppression list because it has a recent history of producing hard bounces. To override the global suppression list, see ",(0,i.kt)("a",{parentName:"td",href:"https://docs.aws.amazon.com/ses/latest/dg/sending-email-suppression-list.html"},"Using the Amazon SES account-level suppression list"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"Permanent")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"OnAccountSuppressionList")),(0,i.kt)("td",{parentName:"tr",align:null},"Amazon SES has suppressed sending to this address because it is on the ",(0,i.kt)("a",{parentName:"td",href:"https://docs.aws.amazon.com/ses/latest/dg/sending-email-suppression-list.html"},"account-level suppression list"),". This does not count toward your bounce rate metric.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"Transient")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"General")),(0,i.kt)("td",{parentName:"tr",align:null},"The recipient's email provider sent a general bounce message. You might be able to send a message to the same recipient in the future if the issue that caused the message to bounce is resolved.",(0,i.kt)("br",null),"\u2139\ufe0f ",(0,i.kt)("strong",{parentName:"td"},"Note"),(0,i.kt)("br",null),'If you send an email to a recipient who has an active automatic response rule (such as an "out of the office" message), you might receive this type of notification. Even though the response has a notification type of ',(0,i.kt)("inlineCode",{parentName:"td"},"Bounce"),", Amazon SES doesn't count automatic responses when it calculates the bounce rate for your account.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"Transient")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"MailboxFull")),(0,i.kt)("td",{parentName:"tr",align:null},"The recipient's email provider sent a bounce message because the recipient's inbox was full. You might be able to send to the same recipient in the future when the mailbox is no longer full.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"Transient")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"MessageTooLarge")),(0,i.kt)("td",{parentName:"tr",align:null},"The recipient's email provider sent a bounce message because message you sent was too large. You might be able to send a message to the same recipient if you reduce the size of the message.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"Transient")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"ContentRejected")),(0,i.kt)("td",{parentName:"tr",align:null},"The recipient's email provider sent a bounce message because the message you sent contains content that the provider doesn't allow. You might be able to send a message to the same recipient if you change the content of the message.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"Transient")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"AttachmentRejected")),(0,i.kt)("td",{parentName:"tr",align:null},"The recipient's email provider sent a bounce message because the message contained an unacceptable attachment. For example, some email providers may reject messages with attachments of a certain file type, or messages with very large attachments. You might be able to send a message to the same recipient if you remove or change the content of the attachment.")))),(0,i.kt)("p",null,"Source: ",(0,i.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/ses/latest/dg/notification-contents.html#bounce-types"},"Bounce types | Amazon SNS notification contents for Amazon SES")),(0,i.kt)("h2",{id:"metrics"},"Metrics"),(0,i.kt)("p",null,"We emit metrics when emails are sent, delivered and when they bounce or complaints are received. A regrettable decision was made to treat complaints as a type of bounce when the metrics were first implemented, which means some of the numbers are unintuitive. Specifically, you might expect that ",(0,i.kt)("inlineCode",{parentName:"p"},"count sent = count delivered + count bounced"),". That\u2019s not true. Instead, ",(0,i.kt)("inlineCode",{parentName:"p"},"count sent = count delivered + count bounced - count complained"),"."),(0,i.kt)("p",null,"The metrics code is slightly confusing because, as mentioned in the previous section, we haven\u2019t finished migrating to the email service yet. That means there\u2019s metrics code we\u2019re using right now and other stuff we\u2019re not using yet, which is waiting for the email service deployment."),(0,i.kt)("p",null,"The stuff we\u2019re using right now is in ",(0,i.kt)("inlineCode",{parentName:"p"},"lib/email/delivery.js")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"lib/email/bounces.js"),". These modules receive events directly from SES and should be pretty straightforward to understand."),(0,i.kt)("p",null,"The stuff we\u2019re not using yet is in ",(0,i.kt)("inlineCode",{parentName:"p"},"lib/email/notifications.js"),", which receives events from the email service (using the same format as SES for consistency). That queue won\u2019t receive any events until the above-linked PR is deployed. The story behind it is we want to keep the metrics code in the auth server, even though bounce and complaint handling is moving away."),(0,i.kt)("p",null,"The two handlers are designed to co-exist, so it\u2019s fine for them both to be in operation when the email service stuff gets deployed, they\u2019ll just compete for events without duplicating any metrics or whatever. When we\u2019re happy that the email service is behaving correctly, we should remove the old SQS handlers from the auth server."),(0,i.kt)("h2",{id:"tests"},"Tests"),(0,i.kt)("p",null,"Historically the email tests have been a burden to maintain because there\u2019s so many of them, and it\u2019s easy for such a large volume of tests to obscure the presence of bugs."),(0,i.kt)("p",null,"The main test cases are in ",(0,i.kt)("inlineCode",{parentName:"p"},"test/local/senders/email.js"),", declared as data in maps called ",(0,i.kt)("inlineCode",{parentName:"p"},"TESTS")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"COMMON_TESTS"),'. Taking a declarative approach like this made it easier to get a feel for the test coverage and spot gaps in it. It also ensured we had common test cases that are applied to every email, e.g. we can make sure there are no HTML character entities in the plain text emails and that required headers are always set. There is also a "partials" test section for testing stateful partials.'),(0,i.kt)("p",null,"To test values other than what's in the ",(0,i.kt)("inlineCode",{parentName:"p"},"MESSAGE")," const at the top of the file, use the ",(0,i.kt)("inlineCode",{parentName:"p"},"updateTemplateValues")," helper function. In this example, ",(0,i.kt)("inlineCode",{parentName:"p"},"productName")," will be updated and then the tests above it will be ran with the new value, ",(0,i.kt)("inlineCode",{parentName:"p"},"undefined"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"['templateNameEmail', new Map<string, Test | any>([\n  ['subject', { test: 'equal', expected: 'Expected subject' }],\n  ['headers', new Map([/* header tests */],\n  ])],\n  ['html', [/* html tests */],\n  ['text', [/* plaintext tests */]\n]), {updateTemplateValues: templateValues => ({...templateValues, productName: undefined})}],\n")),(0,i.kt)("p",null,"We also have a ",(0,i.kt)("inlineCode",{parentName:"p"},"functional-tests")," package containing end-to-end tests for our emails. You may need to update or add to them depending on your changes."),(0,i.kt)("h2",{id:"bulk-mailer"},"Bulk mailer"),(0,i.kt)("p",null,"There have been unfortunate occasions in the past where it became necessary to manually send email out to large subsets of our user base. We have ",(0,i.kt)("inlineCode",{parentName:"p"},"scripts/bulk-mailer.js")," for that purpose. Run ",(0,i.kt)("inlineCode",{parentName:"p"},"node scripts/bulk-mailer --help")," to see usage information."),(0,i.kt)("h2",{id:"how-do-i"},"How do I\u2026"),(0,i.kt)("h3",{id:"change-an-existing-template"},"...change an existing template?"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Find the template you want to change in ",(0,i.kt)("inlineCode",{parentName:"li"},"lib/senders/emails/templates"),"."),(0,i.kt)("li",{parentName:"ol"},"Make sure you update the HTML, plaintext, FTL, and Storybook forms of your template if applicable. You will need a new Fluent ID for new strings, see the l10n section for more info."),(0,i.kt)("li",{parentName:"ol"},"If you need to make changes in ",(0,i.kt)("inlineCode",{parentName:"li"},"layouts")," or ",(0,i.kt)("inlineCode",{parentName:"li"},"partials"),", ensure you don\u2019t break other templates."),(0,i.kt)("li",{parentName:"ol"},"Change or add test data in ",(0,i.kt)("inlineCode",{parentName:"li"},"test/local/senders/emails.ts"),"."),(0,i.kt)("li",{parentName:"ol"},"Bump the template version(s) in ",(0,i.kt)("inlineCode",{parentName:"li"},"lib/senders/emails/templates/_versions.json"),", so that metrics can attribute any changes to the template change."),(0,i.kt)("li",{parentName:"ol"},"If you\u2019re changing strings, make sure you\u2019ve updated the FTL ID, more details above."),(0,i.kt)("li",{parentName:"ol"},"Be sure to run Storybook and make any needed changes there as well.")),(0,i.kt)("h3",{id:"add-a-new-template"},"...add a new template?"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Add HTML (",(0,i.kt)("inlineCode",{parentName:"li"},"index.mjml"),"), plaintext (",(0,i.kt)("inlineCode",{parentName:"li"},"index.txt"),"), FTL (",(0,i.kt)("inlineCode",{parentName:"li"},"en.ftl"),"), includes (",(0,i.kt)("inlineCode",{parentName:"li"},"includes.json"),"), and ",(0,i.kt)("inlineCode",{parentName:"li"},"index.stories.ts")," in a new directory, lib/senders/templates/","[templateName]","`."),(0,i.kt)("li",{parentName:"ol"},"Use MJML (HTML) and EJS (HTML, plaintext, ",(0,i.kt)("inlineCode",{parentName:"li"},"includes.json"),") to create your new template. Ensure the rich HTML and plaintext versions render as expected, the FTL file is properly filled out, and that Storybook includes documentation as well as displaying all states."),(0,i.kt)("li",{parentName:"ol"},"Add a version property to ",(0,i.kt)("inlineCode",{parentName:"li"},"lib/senders/templates/_versions.json"),". Set it to 1."),(0,i.kt)("li",{parentName:"ol"},"Add a corresponding method to ",(0,i.kt)("inlineCode",{parentName:"li"},"lib/senders/email.js"),". Make sure that method calls send with the subject and any template data you need."),(0,i.kt)("li",{parentName:"ol"},"Invoke your method from the code as ",(0,i.kt)("inlineCode",{parentName:"li"},"mailer.send...Email"),"."),(0,i.kt)("li",{parentName:"ol"},"Add new test data in ",(0,i.kt)("inlineCode",{parentName:"li"},"test/local/senders/email.js"),"."),(0,i.kt)("li",{parentName:"ol"},"If all the pieces are hooked up at the time (the endpoint, etc.), add the end-to-end test to ",(0,i.kt)("inlineCode",{parentName:"li"},"functional-tests/lib/email.ts"),". Otherwise, make sure to file a follow up issue.")),(0,i.kt)("h3",{id:"change-an-email-subject"},"...change an email subject?"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Make the change in the relevant ",(0,i.kt)("inlineCode",{parentName:"li"},"includes.json")," or ",(0,i.kt)("inlineCode",{parentName:"li"},"includes.ts")," file, updating the FTL ID as well."),(0,i.kt)("li",{parentName:"ol"},"Update the test data in ",(0,i.kt)("inlineCode",{parentName:"li"},"test/local/senders/email.js"),".")),(0,i.kt)("h3",{id:"view-rendered-templates-locally"},"...view rendered templates locally?"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Run ",(0,i.kt)("inlineCode",{parentName:"li"},"yarn storybook")," and see all emails, HTML and plaintext, with all states, alongside documentation."),(0,i.kt)("li",{parentName:"ol"},"Optionally run ",(0,i.kt)("inlineCode",{parentName:"li"},"node scripts/write-emails-to-disk")," then open the ",(0,i.kt)("inlineCode",{parentName:"li"},".mail_output")," directory in your browser. A rendered copy of every* template will be there."),(0,i.kt)("li",{parentName:"ol"},"Note this is not a substitute for testing changes in a real mail client. Email rendering is famously unreliable.")),(0,i.kt)("p",null,"*Some email methods render two templates based on conditional logic. Using ",(0,i.kt)("inlineCode",{parentName:"p"},"yarn write-emails")," only runs through each method once providing the Mailer the ",(0,i.kt)("inlineCode",{parentName:"p"},"message")," constant set in the script. You won't see every single template or state this way."),(0,i.kt)("h2",{id:"relevant-adrs"},"Relevant ADRs"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/mozilla/fxa/blob/main/docs/adr/0024-upgrade-templating-toolset-of-auth-server-emails.md"},"Upgrade the templating toolset of auth server emails")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/mozilla/fxa/blob/main/docs/adr/0028-retiring-email-service.md"},"Retiring fxa-email-service"))))}p.isMDXComponent=!0}}]);