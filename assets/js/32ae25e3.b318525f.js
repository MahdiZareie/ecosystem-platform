"use strict";(self.webpackChunkfirefox_ecosystem_platform=self.webpackChunkfirefox_ecosystem_platform||[]).push([[8110],{3905:function(e,t,n){n.d(t,{Zo:function(){return s},kt:function(){return d}});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var p=a.createContext({}),c=function(e){var t=a.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},s=function(e){var t=c(e.components);return a.createElement(p.Provider,{value:t},e.children)},g={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,p=e.parentName,s=l(e,["components","mdxType","originalType","parentName"]),u=c(n),d=r,m=u["".concat(p,".").concat(d)]||u[d]||g[d]||o;return n?a.createElement(m,i(i({ref:t},s),{},{components:n})):a.createElement(m,i({ref:t},s))}));function d(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=u;var l={};for(var p in t)hasOwnProperty.call(t,p)&&(l[p]=t[p]);l.originalType=e,l.mdxType="string"==typeof e?e:r,i[1]=l;for(var c=2;c<o;c++)i[c]=n[c];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},86502:function(e,t,n){n.r(t),n.d(t,{assets:function(){return s},contentTitle:function(){return p},default:function(){return d},frontMatter:function(){return l},metadata:function(){return c},toc:function(){return g}});var a=n(83117),r=n(80102),o=(n(67294),n(3905)),i=["components"],l={title:"Application Logging"},p=void 0,c={unversionedId:"reference/application-logging",id:"reference/application-logging",title:"Application Logging",description:"Application Logging",source:"@site/docs/reference/application-logging.md",sourceDirName:"reference",slug:"/reference/application-logging",permalink:"/ecosystem-platform/reference/application-logging",draft:!1,editUrl:"https://github.com/mozilla/ecosystem-platform/edit/master/docs/reference/application-logging.md",tags:[],version:"current",frontMatter:{title:"Application Logging"},sidebar:"docs",previous:{title:"System Diagrams",permalink:"/ecosystem-platform/reference/system-diagrams"},next:{title:"Scheduled Maintenance",permalink:"/ecosystem-platform/reference/scheduled-maintenance"}},s={},g=[{value:"Application Logging",id:"application-logging",level:2},{value:"Capturing Event Details",id:"capturing-event-details",level:3},{value:"Viewing Event Logs",id:"viewing-event-logs",level:3}],u={toc:g};function d(e){var t=e.components,n=(0,r.Z)(e,i);return(0,o.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"application-logging"},"Application Logging"),(0,o.kt)("p",null,"In FxA Javascript/Typescript server-side applications, logging is emitted via ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/mozilla/mozlog/"},"mozlog")," which adheres to the ",(0,o.kt)("a",{parentName:"p",href:"https://wiki.mozilla.org/Firefox/Services/Logging#MozLog_JSON_schema"},"mozlog schema")," format. The log messages are captured from ",(0,o.kt)("inlineCode",{parentName:"p"},"stdout")," and aggregated into Google ",(0,o.kt)("a",{parentName:"p",href:"https://console.cloud.google.com/bigquery"},"BigQuery")," via Stackdriver. Application exceptions are captured via ",(0,o.kt)("a",{parentName:"p",href:"https://sentry.io/"},"Sentry")," and sent to our Sentry instance."),(0,o.kt)("p",null,"Stage and development logging is grouped under the ",(0,o.kt)("inlineCode",{parentName:"p"},"fxa-nonprod")," project, while accessing the ",(0,o.kt)("inlineCode",{parentName:"p"},"fxa-prod")," logs requires additional special access privileges."),(0,o.kt)("h3",{id:"capturing-event-details"},"Capturing Event Details"),(0,o.kt)("p",null,"Once a ",(0,o.kt)("inlineCode",{parentName:"p"},"mozlog")," instance is created, log events are captured with a dot concatenated string indicating an (ideally) unique location of the logging statement that is clear where in the code-base it was made, along with any additional fields to include."),(0,o.kt)("p",null,"Creating a ",(0,o.kt)("inlineCode",{parentName:"p"},"mozlog")," instance can be done by instantiating the log object with a configuration object:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"const logConfig = {\n    app: 'fxa-content-server',\n    fmt: 'heka',\n    level: 'info'\n};\nconst log = require('mozlog')(logConfig);\n")),(0,o.kt)("p",null,"It can then be used to log with:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"log.error('push.sendPush', {uid, deviceId, err });\n")),(0,o.kt)("p",null,"The above log event will have a ",(0,o.kt)("inlineCode",{parentName:"p"},"jsonPayload.type")," set to ",(0,o.kt)("inlineCode",{parentName:"p"},"push.sendPush"),", while the additional object properties will be attached as the ",(0,o.kt)("inlineCode",{parentName:"p"},"jsonPayload.fields")," object."),(0,o.kt)("h3",{id:"viewing-event-logs"},"Viewing Event Logs"),(0,o.kt)("p",null,"Using ",(0,o.kt)("a",{parentName:"p",href:"https://console.cloud.google.com/bigquery"},"bigquery"),", the logs can be retrieved from the application service that generated them by narrowing down the ",(0,o.kt)("inlineCode",{parentName:"p"},"stdout")," table used and the originating service by its container name ",(0,o.kt)("em",{parentName:"p"},"or")," querying the service table directly."),(0,o.kt)("p",null,"Container names for currently deployed services that output to ",(0,o.kt)("inlineCode",{parentName:"p"},"stdout")," tables:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"payments")," - FxA Payment Server"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"amplitude")," - FxA Amplitude Send"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"eventbroker")," - FxA Event Broker")),(0,o.kt)("p",null,"As these change over time, a quick way to determine available container names can be done using a ",(0,o.kt)("inlineCode",{parentName:"p"},"DISTINCT")," query (using the desired date):"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT DISTINCT(resource.labels.container_name)\nFROM `moz-fx-fxa-nonprod-375e.fxa_stage_logs.stdout_20191204`\n")),(0,o.kt)("p",null,"The ",(0,o.kt)("a",{parentName:"p",href:"https://console.cloud.google.com/bigquery"},"bigquery")," console has tab-complete for table-names and SQL statements to make query generation easy."),(0,o.kt)("p",null,"Accessing logs from the FxA Auth Server, FxA Auth Db MySQL Service, etc. requires querying the appropriate table. Some table prefix examples from ",(0,o.kt)("inlineCode",{parentName:"p"},"stage"),":"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"fxa-auth-server - ",(0,o.kt)("inlineCode",{parentName:"li"},"moz-fx-fxa-nonprod-375e.fxa_stage_logs.docker_fxa_auth_20191205")),(0,o.kt)("li",{parentName:"ul"},"fxa-auth-db-server - ",(0,o.kt)("inlineCode",{parentName:"li"},"moz-fx-fxa-nonprod-375e.fxa_stage_logs.docker_fxa_auth_db_20191204"))),(0,o.kt)("p",null,"A full list of these tabale prefixes can be found in the ",(0,o.kt)("a",{parentName:"p",href:"https://console.cloud.google.com/bigquery"},"bigquery")," console by clicking on the left side drop-down and expanding it under ",(0,o.kt)("inlineCode",{parentName:"p"},"fxa_stage_logs")," (or prod). FxA services all start with ",(0,o.kt)("inlineCode",{parentName:"p"},"docker_fxa_"),"."))}d.isMDXComponent=!0}}]);