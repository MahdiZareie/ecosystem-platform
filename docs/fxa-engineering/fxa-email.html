<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>How does FxA process email? · Firefox Ecosystem Platform</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="Current as of `October 7th, 2019`"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="How does FxA process email? · Firefox Ecosystem Platform"/><meta property="og:type" content="website"/><meta property="og:url" content="https://mozilla.github.io/ecosystem-platform/"/><meta property="og:description" content="Current as of `October 7th, 2019`"/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/ecosystem-platform/img/fx-master-brand.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script src="/ecosystem-platform/js/scrollSpy.js"></script><link rel="stylesheet" href="/ecosystem-platform/css/main.css"/><script src="/ecosystem-platform/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/ecosystem-platform/"><img class="logo" src="/ecosystem-platform/img/fx-master-brand.png" alt="Firefox Ecosystem Platform"/><h2 class="headerTitleWithLogo">Firefox Ecosystem Platform</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/ecosystem-platform/docs/welcome" target="_self">Docs</a></li><li class=""><a href="https://github.com/mozilla/ecosystem-platform" target="_self">GitHub</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Topic Deep Dives</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Introduction</h3><ul class=""><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/welcome">Welcome</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/platform-overview">Platform Overview</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">The Process</h3><ul class=""><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/process/integration-with-fxa">Integration with FxA</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/process/integration-with-subscription-platform">Integration with Subscription Platform</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/process/becoming-a-sync-client">Becoming A Sync Client</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Platform Features</h3><ul class=""><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/features">Overview</a></li><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Firefox Account Management</h4><ul><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/fxa-details/fxa-features-overview">Overview</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/fxa-details/feature-detail-example">Feature Detail Example</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Subscription Management</h4><ul><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/subscription-platform-details/subscription-platform-features">Overview</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Firefox Sync</h4><ul><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/firefox-sync/sync-feature">Overview</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/firefox-sync/password-management-feature">Password Management and Syncing</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/firefox-sync/bookmarks-feature">Bookmarks</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/firefox-sync/history-feature">History</a></li></ul></div></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Reference</h3><ul class=""><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/reference/best-practices">Best Practices</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/reference/glossary">Glossary</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/reference/ecosystem-map">reference/ecosystem-map</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">For Relying Parties</h3><ul class=""><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/relying-parties/end-to-end-encryption">End-to-end Encryption</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/relying-parties/metrics-for-relying-parties">Metrics</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">For FxA Engineers</h3><ul class=""><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-dev-process">Development Process</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/release-process">Release Process</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-api">Internal API Documentation</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-system-diagrams">FxA System Diagrams</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-logging">Application Logging</a></li><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Topic Deep Dives</h4><ul><li class="navListItem navListItemActive"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-email">Processing Email</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-metrics">Metrics</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-localization">Localization</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-jwt-access-tokens">JWT Access Tokens</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-webchannel-protocol">WebChannels in Desktop &amp; Fennec</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-oauth-webchannel-protocol">WebChannels in Fenix &amp; WebExtensions</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-content-server-ab-testing">Experiments &amp; A/B testing</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-tests-circleci">Tests in CircleCI</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/functional-testing">Functional/Selenium Tests</a></li></ul></div><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-adr">Architectural Decision Records</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">About</h3><ul class=""><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/about/the-teams">The teams</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/about/history">History</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle">How does FxA process email?</h1></header><article><div><span><p>Current as of <code>October 7th, 2019</code></p>
<h2><a class="anchor" aria-hidden="true" id="fxa-auth-server"></a><a href="#fxa-auth-server" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>fxa-auth-server</h2>
<p>Historically, all of the code for sending email lived in the auth server. That code was tightly coupled to Amazon SES, so we decided to break the email-sending guts of it out to a dedicated project, <code>fxa-email-service</code>. The things that were left in the auth server were the templates, localization, and metrics. There is also a mechanism for selecting the underlying email service which should migrate to the email service too at some point.</p>
<p>Emails are sent by calling methods on the mailer object that is passed around the codebase. The methods are defined by a reducer in <code>lib/senders/index.js</code> and have names like <code>sendVerifyEmail</code>, <code>sendNewDeviceLoginEmail</code> and <code>sendPasswordResetEmail</code>, but those are really just thin wrappers that do a little bit of argument marshalling before handing off to other methods that actually do the work. Those are defined in <code>lib/senders/email.js</code> and don’t have send in the name, so <code>verifyEmail</code>, <code>newDeviceLoginEmail</code> and <code>passwordResetEmail</code> would be counterparts to the above. Ultimately each of these methods calls <code>send</code>, which in turn calls the nuts-and-bolts methods <code>localize</code>, <code>render</code>, <code>selectEmailServices</code> and <code>sendMail</code>.</p>
<h2><a class="anchor" aria-hidden="true" id="templates"></a><a href="#templates" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Templates</h2>
<p>The templates are written using handlebars syntax and live under <code>lib/senders/templates</code>. Directly in that directory you’ll see templates with names corresponding to the mail-sending methods mentioned above, in HTML and plain text versions. There is also code for rendering the templates in <code>index.js</code>, template versions for metrics in <code>_versions.json</code> and any pending strings for L10n in <code>_pending.txt</code>.</p>
<p>There are also two subdirectories, layouts and partials:</p>
<ul>
<li>The templates in <code>layouts</code> contain outer scaffolding that’s common across emails. For the HTML emails that includes stuff like metadata, header logo and smallprint in the footer. For the plain text emails it’s just the standard footer text. Layout names are specified in the call to <code>render</code>.</li>
<li>The templates in <code>partials</code> contain reusable components that are common to many emails. They’re included inline using the handlebars <code>{{&gt; partialName}}</code> syntax.</li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="l10n"></a><a href="#l10n" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>L10n</h2>
<p>There is more detailed documentation about localization elsewhere. For the scope of this document though if will suffice to say that there is a grunt task called <code>l10n-extract</code> which is run as part of our L10n automation. It extracts strings from templates by looking for the <code>{{t &quot;this string needs translating&quot;}}</code> syntax and from JS code by looking for the <code>gettext('this string needs translating')</code> syntax.  Stuff like the email subject and variable data for partials will be in the JS code.</p>
<p>Bear in mind that occasionally we need to bump the parser version that’s used for the JS code, e.g. when we start using some super-duper newfangled JS features. That’s done in <code>grunttasks/l10n-extract.js</code>.</p>
<h2><a class="anchor" aria-hidden="true" id="bounces-and-complaints"></a><a href="#bounces-and-complaints" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Bounces and complaints</h2>
<p><a href="https://docs.aws.amazon.com/ses/latest/DeveloperGuide/notification-contents.html">SES delivery, bounce and complaint notifications</a> are published to SQS queues. As well as emitting metrics (see below), we also store bounce records in the auth db whenever a bounce or complaint occurs. The email service then checks those records against thresholds defined in the config and if any thresholds are violated, sending will fail.</p>
<p>The bounce and complaint handling code is in <code>lib/email/bounces.js</code> but long-term we want to migrate to the email service’s implementation instead, which was written some time ago but has <a href="https://github.com/mozilla-services/cloudops-deployment/pull/3358">not been deployed yet</a>. The motivation for moving is partly semantic, because bounce records don’t really belong in the auth db, but also security, because the email service should not need access to the auth db.</p>
<h2><a class="anchor" aria-hidden="true" id="metrics"></a><a href="#metrics" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Metrics</h2>
<p>We emit metrics when emails are sent, delivered and when they bounce or complaints are received. A regrettable decision was made to treat complaints as a type of bounce when the metrics were first implemented, which means some of the numbers are unintuitive. Specifically, you might expect that <code>count sent = count delivered + count bounced</code>. That’s not true. Instead, <code>count sent = count delivered + count bounced - count complained</code>.</p>
<p>The metrics code is slightly confusing because, as mentioned in the previous section, we haven’t finished migrating to the email service yet. That means there’s metrics code we’re using right now and other stuff we’re not using yet, which is waiting for the <a href="https://github.com/mozilla-services/cloudops-deployment/pull/3358">email service deployment</a>.</p>
<p>The stuff we’re using right now is in <code>lib/email/delivery.js</code> and <code>lib/email/bounces.js</code>. These modules receive events directly from SES and should be pretty straightforward to understand.</p>
<p>The stuff we’re not using yet is in <code>lib/email/notifications.js</code>, which receives events from the email service (using the same format as SES for consistency). That queue won’t receive any events until the above-linked PR is deployed. The story behind it is we want to keep the metrics code in the auth server, even though bounce and complaint handling is moving away.</p>
<p>The two handlers are designed to co-exist, so it’s fine for them both to be in operation when the email service stuff gets deployed, they’ll just compete for events without duplicating any metrics or whatever. When we’re happy that the email service is behaving correctly, we should land the draft PR that I worked on to remove the old SQS handlers from the auth server: <a href="https://github.com/mozilla/fxa/pull/2192">#2192</a>.</p>
<h2><a class="anchor" aria-hidden="true" id="tests"></a><a href="#tests" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Tests</h2>
<p>Historically the email tests have been a burden to maintain because there’s so many of them, and it’s easy for such a large volume of tests to obscure the presence of bugs.</p>
<p>The main test cases are in <code>test/local/senders/email.js</code>, declared as data in maps called <code>TESTS</code> and <code>COMMON_TESTS</code>. Taking a declarative approach like this made it easier to get a feel for the test coverage and spot gaps in it. It also ensured we had common test cases that are applied to every email, e.g. we can make sure there are no HTML character entities in the plain text emails and that required headers are always set.</p>
<h2><a class="anchor" aria-hidden="true" id="selectemailservices"></a><a href="#selectemailservices" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>selectEmailServices</h2>
<p>The email service supports sending via Amazon SES, Sendgrid, SocketLabs and plain SMTP. We wanted to be able to set config for that stuff dynamically, without redeploying the stack, so <a href="https://github.com/mozilla/fxa-auth-server/pull/2574">some code was written</a> to keep it in Redis. Because one of the states we were modelling was for email not to be sent through the email service at all, that code had to live in the auth server initially. But now we use the email service for everything, <a href="https://github.com/mozilla/fxa/issues/435">it probably makes sense for it to move there now</a>. Anyway, the function that does all this stuff is called <code>selectEmailServices</code> and it lives in <code>lib/senders/select_email_services.js</code>.</p>
<p>There is a long comment at the top of that module, describing how it works and the data format and so on, so I won’t reproduce it all here. It should be pretty straightforward.</p>
<p>That code is only the read part though, the write part is in a separate script that Ops can run against prod when we want to divert email for a particular email address or domain or whatever. That script is in <code>scripts/email-config.js</code> and if you run <code>node scripts/email-config</code> without arguments it will print usage information.</p>
<h2><a class="anchor" aria-hidden="true" id="bulk-mailer"></a><a href="#bulk-mailer" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Bulk mailer</h2>
<p>There have been unfortunate occasions in the past where it became necessary to manually send email out to large subsets of our user base. Shane wrote a script that does this, <code>scripts/bulk-mailer.js</code>. Run <code>node scripts/bulk-mailer --help</code> to see usage information.</p>
<h2><a class="anchor" aria-hidden="true" id="how-do-i"></a><a href="#how-do-i" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>How do I…</h2>
<h3><a class="anchor" aria-hidden="true" id="change-an-existing-template"></a><a href="#change-an-existing-template" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>...change an existing template?</h3>
<ol>
<li>Find the template you want to change in <code>lib/senders/templates</code>.</li>
<li>Make sure you update both the HTML and plain text forms of your template.</li>
<li>If you need to make changes in <code>layouts</code> or <code>partials</code>, ensure you don’t break other templates.</li>
<li>Change or add test data in <code>TESTS</code> in <code>test/local/senders/email.js</code>.</li>
<li>Bump the template version(s) in <code>lib/senders/templates/_versions.json</code>, so that metrics can attribute any changes to the template change.</li>
<li>If you’re changing strings, make sure you’ve made the cut for L10n. If you want to avoid missing the cut, land strings ahead of time in <code>lib/senders/templates/_pending.txt</code>.</li>
</ol>
<h3><a class="anchor" aria-hidden="true" id="add-a-new-template"></a><a href="#add-a-new-template" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>...add a new template?</h3>
<ol>
<li>Add HTML and plain text copies in <code>lib/senders/templates</code>.</li>
<li>Add a version property to <code>lib/senders/templates/_versions.json</code>. Set it to 1.</li>
<li>Add a corresponding method to <code>lib/senders/email.js</code>. Make sure that method calls send with the subject and any template data you need.</li>
<li>Invoke your method from the code as <code>mailer.send...Email</code>.</li>
<li>Add new test data to <code>TESTS</code> in <code>test/local/senders/email.js</code>.</li>
</ol>
<h3><a class="anchor" aria-hidden="true" id="change-an-email-subject"></a><a href="#change-an-email-subject" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>...change an email subject?</h3>
<ol>
<li>Make the change in the relevant method in <code>lib/senders/email.js</code>.</li>
<li>Make sure the string is wrapped inside a call to gettext, so that the L10n automation can translate it.</li>
<li>Update the test data in <code>TESTS</code> in <code>test/local/senders/email.js</code>.</li>
</ol>
<h3><a class="anchor" aria-hidden="true" id="view-rendered-templates-locally"></a><a href="#view-rendered-templates-locally" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>...view rendered templates locally?</h3>
<ol>
<li>Run <code>node scripts/write-emails-to-disk</code> all then open the <code>.mail_output</code> directory in your browser. A rendered copy of every template will be there.</li>
<li>Note this is not a substitute for testing changes in a real mail client. Email rendering is famously unreliable.</li>
</ol>
<h2><a class="anchor" aria-hidden="true" id="fxa-email-service"></a><a href="#fxa-email-service" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>fxa-email-service</h2>
<p>Unlike most packages in the FxA monorepo, the email service is written in Rust. The readme has useful information about how to build it, run it, run the tests etc. There are <a href="https://mozilla.github.io/fxa/fxa-email-service/fxa_email_service/">detailed code-level docs</a> that get built in CI and published to GitHub Pages.</p>
<p>There are two parts to the email service: an HTTP API and a separate process that listens to SQS queues for delivery, bounce and complaint notifications. As mentioned previously, that second part is <a href="https://github.com/mozilla-services/cloudops-deployment/pull/3358">still awaiting deployment</a>.</p>
<p>The email service uses Redis for storage. It has 3 storage types:</p>
<ol>
<li>Bounce and complaint records. Writes for this are implemented, but we don’t want to read from it until it has enough history to cut across seamlessly from the auth db. And the writes won’t actually write anything until that deployment I keep linking to is done.</li>
<li>Message metadata. This is so we can stash things like flow id when sending a message and still have access to them when delivery, bounce and complaint notifications arrive on the queue. Reads and writes are implemented.</li>
<li>Config. This is intended to replace the <code>selectEmailServices</code> stuff from the auth server and also act as storage for any relier-specific config we might need when the email service is opened up to other services. I did have this implemented on a branch somewhere once upon a time, but I can’t find it anywhere. So, not implemented.</li>
</ol>
<p>As mentioned, the migration to the email service is unfinished. These are some issues from the backlog that I had to cover the outstanding work:</p>
<ul>
<li><a href="https://github.com/mozilla/fxa/issues/434">Enable the queues process in prod</a></li>
<li><a href="https://github.com/mozilla/fxa/issues/435">Add a config endpoint</a></li>
<li><a href="https://github.com/mozilla/fxa/issues/440">Migrate away from auth db</a></li>
</ul>
<p>Then later, if we want to make the email service fully standalone and open it up to other consumers within Mozilla, we should implement these issues:</p>
<ul>
<li><a href="https://github.com/mozilla/fxa/issues/436">Bounce-handling behaviours</a></li>
<li><a href="https://github.com/mozilla/fxa/issues/437">Running as a separate service</a></li>
<li><a href="https://github.com/mozilla/fxa/issues/438">Authentication</a></li>
<li><a href="https://github.com/mozilla/fxa/issues/439">Rate-limiting</a></li>
</ul>
<p>(those are not exhaustive lists btw, there’s other issues that should also be fixed at some point)</p>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/ecosystem-platform/docs/fxa-engineering/fxa-logging"><span class="arrow-prev">← </span><span>Application Logging</span></a><a class="docs-next button" href="/ecosystem-platform/docs/fxa-engineering/fxa-metrics"><span>Metrics</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#fxa-auth-server">fxa-auth-server</a></li><li><a href="#templates">Templates</a></li><li><a href="#l10n">L10n</a></li><li><a href="#bounces-and-complaints">Bounces and complaints</a></li><li><a href="#metrics">Metrics</a></li><li><a href="#tests">Tests</a></li><li><a href="#selectemailservices">selectEmailServices</a></li><li><a href="#bulk-mailer">Bulk mailer</a></li><li><a href="#how-do-i">How do I…</a><ul class="toc-headings"><li><a href="#change-an-existing-template">...change an existing template?</a></li><li><a href="#add-a-new-template">...add a new template?</a></li><li><a href="#change-an-email-subject">...change an email subject?</a></li><li><a href="#view-rendered-templates-locally">...view rendered templates locally?</a></li></ul></li><li><a href="#fxa-email-service">fxa-email-service</a></li></ul></nav></div><footer><img src="/ecosystem-platform/img/mozilla-logo.png" height="24"/><script src="https://unpkg.com/mermaid@8.4.2/dist/mermaid.min.js" type="application/javascript"></script><script>
        mermaid.initialize({
            startOnReady: true,
            theme: 'forest',
            themeCSS: '.noteText { font-family: monospace; }'
          });
        // remarkable converts the mermaid diagrams to HTML and injects a bunch
        // of HTML tags the mermaid parser cannot handle. Remove the HTML and
        // run the parser on the original text.
        const mermaidDiagramEls = document.querySelectorAll('.language-mermaid');
        mermaidDiagramEls.forEach(function(diagramEl, index) {
          // strip out any HTML
          diagramEl.innerHTML = diagramEl.innerText;
          diagramEl.addEventListener('click', (evt) => {
            evt.currentTarget.classList.toggle('highlight');
            document.body.classList.toggle('highlight-service');
          }, false);
        });
        mermaid.init(undefined, mermaidDiagramEls);
        </script></footer></div></body></html>