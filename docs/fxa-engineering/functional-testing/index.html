<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Functional/Selenium Tests · Firefox Ecosystem Platform</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="Current as of `March 11th, 2021`"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Functional/Selenium Tests · Firefox Ecosystem Platform"/><meta property="og:type" content="website"/><meta property="og:url" content="https://mozilla.github.io/ecosystem-platform/"/><meta property="og:description" content="Current as of `March 11th, 2021`"/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/ecosystem-platform/img/fx-master-brand.png"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script src="/ecosystem-platform/js/scrollSpy.js"></script><link rel="stylesheet" href="/ecosystem-platform/css/main.css"/><script src="/ecosystem-platform/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/ecosystem-platform/"><img class="logo" src="/ecosystem-platform/img/fx-master-brand.png" alt="Firefox Ecosystem Platform"/><h2 class="headerTitleWithLogo">Firefox Ecosystem Platform</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/ecosystem-platform/docs/welcome" target="_self">Docs</a></li><li class=""><a href="https://github.com/mozilla/ecosystem-platform" target="_self">GitHub</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Topic Deep Dives</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Introduction</h3><ul class=""><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/welcome">Welcome</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Platform</h3><ul class=""><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Firefox Accounts</h4><ul><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/firefox-accounts/fxa-overview">Overview</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/process/integration-with-fxa">Integration with FxA</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/relying-parties/end-to-end-encryption">End-to-end Encryption</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/relying-parties/metrics-for-relying-parties">Metrics</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/firefox-accounts/pairing">Pairing authentication</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Subscription Platform</h4><ul><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/sub-plat/sub-plat-overview">Overview</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/sub-plat/sub-plat-features">Subscription Features</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/process/integration-with-subscription-platform">Integration with Subscription Platform</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Firefox Push</h4><ul><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/firefox-push/push-feature">Overview</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/firefox-push/push-design">Design, API&#x27;s, Error Codes</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/firefox-push/push-development">Development Process</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/firefox-push/push-history">History</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Firefox Sync</h4><ul><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/firefox-sync/sync-feature">Overview</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/firefox-sync/password-management-feature">Password Management and Syncing</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/firefox-sync/bookmarks-feature">Bookmarks</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/firefox-sync/storage-feature">Storage</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/firefox-sync/history-feature">History</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/firefox-sync/account-management-feature">Account Management</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/process/becoming-a-sync-client">Becoming A Sync Client</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/process/sync-testing">Sync Testing</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/process/using-the-staging-environment">Using the Staging Environment</a></li></ul></div></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">For FxA Engineers</h3><ul class=""><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-dev-process">Development Process</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-work-breakdown-process">Work Breakdown Process</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/release-process">Release Process</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-api">Internal API Documentation</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-system-diagrams">FxA System Diagrams</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-logging">Application Logging</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/vscode-development">Using VS Code with FxA</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-sub-platform">Subscription Platform</a></li><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Topic Deep Dives</h4><ul><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-email">Processing Email</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-metrics">Metrics</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-localization">Localization</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-jwt-access-tokens">JWT Access Tokens</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-scoped-keys">Scoped Keys</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-onepw-protocol">onepw Protocol</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-webchannel-protocol">WebChannels in Desktop &amp; Fennec</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-oauth-webchannel-protocol">WebChannels in Fenix &amp; WebExtensions</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-content-server-ab-testing">Experiments &amp; A/B testing</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-tests-circleci">Tests in CircleCI</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/functional-testing">Functional/Selenium Tests</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-content-server-architecture">Content-server architecture</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-session-tokens">Session Tokens</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/process/interruptive-surveys">Running Surveys in FxA</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-github">GitHub Strategies</a></li></ul></div><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-adr">Architectural Decision Records</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-additional-docs">Additional Docs</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 id="__docusaurus" class="postHeaderTitle">Functional/Selenium Tests</h1></header><article><div><span><p>Current as of <code>March 11th, 2021</code></p>
<p>End to end testing of the entire FxA ecosystem is provided by a <a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-content-server/tests/functional">comprehensive suite of Selenium tests</a> in the fxa-content-server package. Tests can be run by going to the content-server package directory and typing:</p>
<pre><code class="hljs css language-bash">$ npm run <span class="hljs-built_in">test</span>-functional
</code></pre>
<p>The full set of functional tests is run on <a href="./fxa-tests-circleci">CircleCI</a> on every checkin and every time a pull request is merged to main.
This full set consist of a smoke test suite(<a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-content-server/tests/functional_smoke">https://github.com/mozilla/fxa/tree/main/packages/fxa-content-server/tests/functional_smoke</a>) which runs the high priority test cases first and upon success the full suite of regression tests(<a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-content-server/tests/functional_regression">https://github.com/mozilla/fxa/tree/main/packages/fxa-content-server/tests/functional_regression</a>) are run. If there is a failure in the smoke test suite, the regression suite won't be run until the failures have been fixed.
There is also a notification system in place for when these failures occur to alert the FxA team via Slack messaging.</p>
<p><a href="https://theintern.io/">The Intern</a> library is used to run the tests, which itself is a wrapper around the <a href="https://theintern.io/docs.html#Leadfoot/2/api/Command">Leadfoot</a> WebDriver library.</p>
<p>The functional tests can seem impenetrable, don't worry, they'll become second nature after a while. They continually save our bacon, and every new feature should have corresponding functional tests.</p>
<h2><a class="anchor" aria-hidden="true" id="why-are-there-so-many-test-suites-that-seem-to-do-the-same-thing"></a><a href="#why-are-there-so-many-test-suites-that-seem-to-do-the-same-thing" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Why are there so many test suites that seem to do the same thing?</h2>
<p>A close look at the tests makes it look like there are a lot of tests that do
the same thing, and you are right. Sometimes this is intentional, sometimes it's not.</p>
<p>Many tests are intentionally duplicated across each of the different integration types
to ensure the end to end flow for that integration works as expected. For example,
there are &quot;sign in&quot; tests for each of:</p>
<ul>
<li>fx_desktop_v3 (Firefox Desktop Sync)</li>
<li>fx_fennec_v1 (Firefox for Android Sync)</li>
<li>fx_ios_v1 (Firefox for iOS Sync)</li>
<li>oauth (OAuth RPs)</li>
</ul>
<p>In each of these, the behaviors and screen to screen transitions can be subtly different. For example, Sync based integrations should show a &quot;connect another device&quot; screen when
the user finishes signing in, but most OAuth integrations redirect back to the RP.</p>
<p>If two tests are obviously testing the same thing or one is a subset of another,
it's OK (and encouraged) to remove duplicates.</p>
<h2><a class="anchor" aria-hidden="true" id="how-do-i"></a><a href="#how-do-i" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>How do I?</h2>
<h3><a class="anchor" aria-hidden="true" id="run-a-single-test"></a><a href="#run-a-single-test" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Run a single test</h3>
<p>A single test can be run using intern's <code>grep</code> flag. You'll need to find the name of the test you want to run.</p>
<pre><code class="hljs css language-bash">$ npm run <span class="hljs-built_in">test</span>-functional -- --grep=<span class="hljs-string">"&lt;name of test here&gt;"</span>
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="add-a-new-test-file"></a><a href="#add-a-new-test-file" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Add a new test file</h3>
<h4><a class="anchor" aria-hidden="true" id="create-the-test-file"></a><a href="#create-the-test-file" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Create the test file</h4>
<pre><code class="hljs css language-bash">$ touch tests/functional/&lt;name_of_file&gt;.js
</code></pre>
<h4><a class="anchor" aria-hidden="true" id="add-the-file-to-the-list"></a><a href="#add-the-file-to-the-list" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Add the file to the list</h4>
<p>Edit <a href="https://github.com/mozilla/fxa/blob/main/packages/fxa-content-server/tests/functional.js">tests/functional.js</a> and add the name of the file
to the list.</p>
<h4><a class="anchor" aria-hidden="true" id="fill-in-the-test-file"></a><a href="#fill-in-the-test-file" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Fill in the test file</h4>
<p>See <a href="#example-test-suite">Example test suite</a>.</p>
<h3><a class="anchor" aria-hidden="true" id="make-use-of-common-selectors"></a><a href="#make-use-of-common-selectors" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Make use of common selectors</h3>
<p>As seen in <a href="#example-test-suite">Example test suite</a> Selenium tests interact with the
DOM and require element selectors to be able to perform actions like typing or testing
whether an element exists. Instead of embedding selectors within the tests, use selectors
from the <a href="https://github.com/mozilla/fxa/blob/main/packages/fxa-content-server/tests/functional/lib/selectors.js">selectors.js</a> file. Selectors are namespaced
by their screen name. If a selector or screen namespace is not available, feel free to add it.</p>
<p>Adding selectors to selectors.js makes it much easier to update tests if an element's selector changes. Instead of search/replace on the selector everywhere, update it in selectors.js and leave the tests be.</p>
<h3><a class="anchor" aria-hidden="true" id="example-test-suite"></a><a href="#example-test-suite" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Example test suite</h3>
<p>Below is a simplified annotated example of a test suite that checks the privacy policy.</p>
<pre><code class="hljs css language-js"><span class="hljs-comment">// intern is a global variable and does not need to be imported</span>
<span class="hljs-keyword">const</span> { registerSuite } = intern.getInterface(<span class="hljs-string">'object'</span>);
<span class="hljs-keyword">const</span> FunctionalHelpers = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./lib/helpers'</span>);
<span class="hljs-keyword">const</span> selectors = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./lib/selectors'</span>);

<span class="hljs-keyword">const</span> ENTER_EMAIL_URL = intern._config.fxaContentRoot;
<span class="hljs-keyword">const</span> PP_URL = intern._config.fxaContentRoot + <span class="hljs-string">'legal/privacy'</span>;

<span class="hljs-keyword">const</span> {
  <span class="hljs-comment">// name of helpers to import. There are helpers</span>
  clearBrowserState,
  createEmail,
  openPage,
  type,
} = FunctionalHelpers;

registerSuite(<span class="hljs-string">'privacy policy'</span>, {
  <span class="hljs-attr">beforeEach</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-comment">// this.remote provides a reference to the remote browser</span>
    <span class="hljs-comment">// `clearBrowserState` avoids cross test contamination</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.remote.then(clearBrowserState({ <span class="hljs-attr">force</span>: <span class="hljs-literal">true</span> }));
  },

  <span class="hljs-attr">tests</span>: {
    <span class="hljs-string">'test the privacy policy works'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.remote

        <span class="hljs-comment">// open the ENTER_EMAIL_URL page and wait for the</span>
        <span class="hljs-comment">// element defined by the ENTER_EMAIL.HEADER selector</span>
        .then(
          openPage(ENTER_EMAIL_URL, selectors.ENTER_EMAIL.HEADER)
        )

        <span class="hljs-comment">// type the email created by `createEmail` into the</span>
        <span class="hljs-comment">// element defined by the ENTER_EMAIL.EMAIL selector</span>
        .then(type(selectors.ENTER_EMAIL.EMAIL, createEmail()))

        <span class="hljs-comment">// click on the ENTER_EMAIL.SUBMIT element, wait for the</span>
        <span class="hljs-comment">// SIGNUP_PASSWORD.HEADER element.</span>
        .then(
          click(
            selectors.ENTER_EMAIL.SUBMIT,
            selectors.SIGNUP_PASSWORD.HEADER
          )
        )

        .then(
          <span class="hljs-comment">// click on the SIGNUP_PASSWORD.PRIVACY_POLICY element,</span>
          <span class="hljs-comment">// wait for the PRIVACY_POLICY.HEADER element.</span>
          click(
            selectors.SIGNUP_PASSWORD.PRIVACY_POLICY,
            selectors.PRIVACY_POLICY.HEADER
          )
        )
        .then(
          <span class="hljs-comment">// click on the back link (PRIVACY_POLICY.LINK_BACK),</span>
          <span class="hljs-comment">// ensure we go back to SIGNUP_PASSWORD.HEADER</span>
          click(
            selectors.PRIVACY_POLICY.LINK_BACK,
            selectors.SIGNUP_PASSWORD.HEADER
          )
        );
    },
  },
});
</code></pre>
<p>Very few low level <a href="https://theintern.io/docs.html#Leadfoot/2/api/Command">Leadfood commands</a> are used directly, instead we prefer to use <a href="https://github.com/mozilla/fxa/blob/main/packages/fxa-content-server/tests/functional/lib/helpers.js">higher level helpers</a>. Leadfoot commands are often <em>too</em> low level and end up requiring a lot
of code to do simple actions. Our high level helpers usually require less code and
often provide extra functionality, e.g., ensuring an element is visible before attempting
to type into it.</p>
<h3><a class="anchor" aria-hidden="true" id="check-if-an-element-exists"></a><a href="#check-if-an-element-exists" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Check if an element exists</h3>
<p>Use the <a href="https://github.com/mozilla/fxa/blob/abfb9822760f9edf5175bdded0efa8e074b8ed84/packages/fxa-content-server/tests/functional/lib/helpers.js#L194:L202">testElementExists</a> helper:</p>
<pre><code class="hljs css language-js">.then(testElementExists(selectors.SETTINGS.HEADER))
</code></pre>
<p>Note, this only tests that an element exists, however, the element <em>may be hidden</em>. For visibility, see <a href="#check-if-an-element-is-visible">Check if an element is visible</a>.</p>
<h3><a class="anchor" aria-hidden="true" id="check-if-an-element-is-visible"></a><a href="#check-if-an-element-is-visible" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Check if an element is visible</h3>
<p>Use the <a href="https://github.com/mozilla/fxa/blob/abfb9822760f9edf5175bdded0efa8e074b8ed84/packages/fxa-content-server/tests/functional/lib/helpers.js#L125-L192">visibleByQSA</a> helper.</p>
<pre><code class="hljs css language-js">.then(visibleByQSA(selectors.SETTINGS.HEADER))
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="type-into-an-element"></a><a href="#type-into-an-element" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Type into an element</h3>
<p>Use the <a href="https://github.com/mozilla/fxa/blob/abfb9822760f9edf5175bdded0efa8e074b8ed84/packages/fxa-content-server/tests/functional/lib/helpers.js#L301-L356">type</a> helper method.</p>
<pre><code class="hljs css language-js">.then(type(selectors.ENTER_EMAIL.EMAIL, <span class="hljs-string">'testuser@testuser.com'</span>))
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="check-an-elements-value"></a><a href="#check-an-elements-value" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Check an element's value</h3>
<p>Use the <a href="https://github.com/mozilla/fxa/blob/abfb9822760f9edf5175bdded0efa8e074b8ed84/packages/fxa-content-server/tests/functional/lib/helpers.js#L2107:L2122">testElementValueEquals</a> helper method.</p>
<pre><code class="hljs css language-js">.then(
  testElementValueEquals(
    selectors.ENTER_EMAIL.EMAIL, <span class="hljs-string">'testuser@testuser.com'</span>
  )
)
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="click-on-an-element"></a><a href="#click-on-an-element" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Click on an element</h3>
<p>Use the <a href="https://github.com/mozilla/fxa/blob/abfb9822760f9edf5175bdded0efa8e074b8ed84/packages/fxa-content-server/tests/functional/lib/helpers.js#L204-L276">click</a> helper method.</p>
<pre><code class="hljs css language-js">.then(
  click(
    <span class="hljs-comment">// click on this element</span>
    selectors.ENTER_EMAIL.SUBMIT,
    <span class="hljs-comment">// wait for this element</span>
    selectors.SIGN_IN_PASSWORD.HEADER
  )
)
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="create-a-unique-email"></a><a href="#create-a-unique-email" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Create a unique email</h3>
<p>Use the <a href="https://github.com/mozilla/fxa/blob/abfb9822760f9edf5175bdded0efa8e074b8ed84/packages/fxa-content-server/tests/lib/helpers.js#L24:L29">createEmail</a> helper method.</p>
<pre><code class="hljs css language-js"><span class="hljs-keyword">const</span> email = createEmail();
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="create-a-user"></a><a href="#create-a-user" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Create a user</h3>
<p>First, see <a href="#create-a-unique-email">create a unique email</a> to create a unique email. Emails should be unique across all tests and test runs to avoid any cross test contamination.
Then use the <a href="https://github.com/mozilla/fxa/blob/abfb9822760f9edf5175bdded0efa8e074b8ed84/packages/fxa-content-server/tests/functional/lib/helpers.js#L2180:L2200">createUser</a> helper method.</p>
<pre><code class="hljs css language-js"><span class="hljs-keyword">const</span> email = createEmail();
...
<span class="hljs-comment">// creates a pre-verified user with email `email` and password `PASSWORD123123123`</span>
<span class="hljs-comment">// Users are by default unverified.</span>
.then(createUser(email, <span class="hljs-string">'PASSWORD123123123'</span>, { <span class="hljs-attr">preVerified</span>: <span class="hljs-literal">true</span> }))
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="submit-a-form"></a><a href="#submit-a-form" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Submit a form</h3>
<p>See <a href="#click-on-an-element">Click on an element</a>.</p>
<h3><a class="anchor" aria-hidden="true" id="test-ab-tests"></a><a href="#test-ab-tests" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Test A/B tests</h3>
<p>To avoid test failures due to random selections, by default all A/B tests are disabled within functional tests.
So that A/B tests can be tested, it is possible to force a single experiment and experiment group using URL query
parameters.</p>
<p>When opening your page, specify the <code>forceExperiment</code> and <code>forceExperimentGroup</code> query parameters:</p>
<pre><code class="hljs css language-js">...
.then(openPage(ENTER_EMAIL_URL, selectors.ENTER_EMAIL.HEADER, {
  <span class="hljs-attr">query</span>: {
    <span class="hljs-attr">forceExperiment</span>: <span class="hljs-string">'my-new-experiment-name'</span>,
    <span class="hljs-attr">forceExperimentGroup</span>: <span class="hljs-string">'treatment'</span>
  }
}))
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="simulate-interaction-with-the-browser-eg-webchannels"></a><a href="#simulate-interaction-with-the-browser-eg-webchannels" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Simulate interaction with the browser, e.g., WebChannels</h3>
<p>Browser based integrations all require FxA to communicate with the browser. See <a href="./fxa-webchannel-protocol">WebChannels in Desktop and Fennec</a> and <a href="./fxa-oauth-webchannel-protocol">WebChannels in Fenix</a> for background information.</p>
<p>For example, every time Firefox Desktop loads, FxA asks Firefox for info
on the user currently signed into Firefox as well as a list of &quot;capabilities&quot;
the browser supports. This is done via the <a href="./fxa-webchannel-protocol#fxaccounts-fxa_status">fxaccounts:fxa_status</a> WebChannel message.</p>
<p>Within functional tests, we do not want to actually drive the browser, nor depend on potentially unknown states. Instead we intercept messages sent to the browser and
stub out responses. To ease development, default responses are hooked up for
<code>fxaccounts:fxa_status</code> and <code>fxaccounts:can_link_account</code>.</p>
<p>Responses to these can both be overridden by providing a <code>webChannelResponses</code> object
in the <code>options</code> parameter of <code>openPage</code>. An example from <a href="https://github.com/mozilla/fxa/blob/abfb9822760f9edf5175bdded0efa8e074b8ed84/packages/fxa-content-server/tests/functional/sync_v3_sign_in.js#L55-L62">sync_v3_sign_in.js</a>:</p>
<pre><code class="hljs css language-js">...
.then(
  openPage(ENTER_EMAIL_URL, selectors.ENTER_EMAIL.HEADER, {
    query,
    <span class="hljs-attr">webChannelResponses</span>: {
      <span class="hljs-comment">// simulate the user declining whether two Sync accounts</span>
      <span class="hljs-comment">// can be joined.</span>
      <span class="hljs-string">'fxaccounts:can_link_account'</span>: { <span class="hljs-attr">ok</span>: <span class="hljs-literal">false</span> },
    },
  })
)
...
</code></pre>
<p>Your test can check whether the expected data was sent in a WebChannel
message to the browser using the <a href="https://github.com/mozilla/fxa/blob/abfb9822760f9edf5175bdded0efa8e074b8ed84/packages/fxa-content-server/tests/functional/lib/helpers.js#L1150-L1189">storeWebChannelMessageData</a> and <a href="https://github.com/mozilla/fxa/blob/abfb9822760f9edf5175bdded0efa8e074b8ed84/packages/fxa-content-server/tests/functional/lib/helpers.js#L1191-L1208">getWebChannelMessageData</a> helper functions.</p>
<pre><code class="hljs css language-js">...
.then(storeWebChannelMessageData(<span class="hljs-string">'fxaccounts:login'</span>))
.then(
  fillOutEmailFirstSignIn(<span class="hljs-string">'testuser@testuser.com'</span>, <span class="hljs-string">'PASSWORDCXVZ'</span>)
)
.then(getWebChannelMessageData(<span class="hljs-string">'fxaccounts:login'</span>))
.then(<span class="hljs-function"><span class="hljs-params">messageData</span> =&gt;</span> {
  assert.equal(messageData.email, <span class="hljs-string">'testuser@testuser.com'</span>);
})
...
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="emulate-a-specific-user-agent"></a><a href="#emulate-a-specific-user-agent" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Emulate a specific user-agent</h3>
<p>By default, all functional tests run with the <a href="https://github.com/mozilla/fxa/blob/a86e324a6a2d72684bcd7a632e22d5ab5aa005cd/packages/fxa-content-server/tests/tools/firefox_profile_creator.js#L6">user-agent string</a></p>
<blockquote>
<p>Mozilla/5.0 (Macintosh; Intel Mac OS X 10.10; rv:40.0) Gecko/20100101 Firefox/40.0 FxATester/1.0</p>
</blockquote>
<p>That's right, Firefox 40 - Firefox 40 was the first version that supported WebChannels.</p>
<p>If your code relies on parsing the user agent string for a particular version number, use the <code>forceUA</code> query parameter
of <code>openPage</code> to specify a UA string override.</p>
<p>A list of pre-defined user-agent strings is found in <a href="https://github.com/mozilla/fxa/blob/a86e324a6a2d72684bcd7a632e22d5ab5aa005cd/packages/fxa-content-server/tests/functional/lib/ua-strings.js">ua-strings.js</a>.</p>
<pre><code class="hljs css language-js"><span class="hljs-keyword">const</span> uaStrings = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./lib/ua-strings'</span>);

...
  openPage(ENTER_EMAIL_URL, selectors.ENTER_EMAIL.HEADER, {
    <span class="hljs-attr">query</span>: {
      <span class="hljs-attr">forceUA</span>: uaStrings[<span class="hljs-string">'desktop_firefox_71'</span>]
    },
...
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="add-a-new-helper"></a><a href="#add-a-new-helper" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Add a new helper</h3>
<p>It's easy! When adding new forms that must be completed in multiple tests,
using helper function makes life so much easier and code much more maintainable.
Add your helper method to <a href="https://github.com/mozilla/fxa/blob/abfb9822760f9edf5175bdded0efa8e074b8ed84/packages/fxa-content-server/tests/functional/lib/helpers.js">helpers.js</a>.
Expose it <a href="https://github.com/mozilla/fxa/blob/abfb9822760f9edf5175bdded0efa8e074b8ed84/packages/fxa-content-server/tests/functional/lib/helpers.js#L2504">in the interface</a>.</p>
<p>There are so many helper functions for DOM manipulation that you'll likely be able
to make use of those to avoid <a href="https://theintern.io/docs.html#Leadfoot/2/api/Command">low level Leadfoot commands</a>.</p>
<h2><a class="anchor" aria-hidden="true" id="why-do-my-tests-fail"></a><a href="#why-do-my-tests-fail" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Why do my tests fail?</h2>
<h3><a class="anchor" aria-hidden="true" id="assuming-an-action-has-completed-aka-timing-issues"></a><a href="#assuming-an-action-has-completed-aka-timing-issues" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Assuming an action has completed, a.k.a., timing issues</h3>
<p>This is far and away the number one reason why functional tests fail. Always remember
that Selenium will run tests as fast as they possibly can, it's not like a real user
sitting in front of a computer where it takes time to type or move the mouse. Also keep
in mind that testing locally does not incur network latency. Finally, tests run on
CircleCI are run in virtual machines, backend requests and even the
test runner are often an order of magnitude slower than local machines.</p>
<p>One of the most common problems is clicking on a submit button and then immediately
checking text, an input element value, or an attribute value, of an element on a
subsequent screen without actually ensuring the screen is visible. The high level
helper functions <em>try</em> to take this into account, but sometimes fail. The simplest
approach to this is to <strong>wait for some expected DOM mutation to occur</strong>
before any further assertions.</p>
<p>An example of a problematic test:</p>
<pre><code class="hljs css language-js">...
.then(click(selectors.ENTER_EMAIL.SUBMIT))
<span class="hljs-comment">// We have not ensured the submission was successful by</span>
<span class="hljs-comment">// checking for the SIGNUP_PASSWORD's header.</span>
.then(
  testElementValueEquals(selectors.SIGNUP_PASSWORD.EMAIL, email)
)
</code></pre>
<p>A more robust solution is:</p>
<pre><code class="hljs css language-js">...
<span class="hljs-comment">// The 2nd parameter ensures SIGNUP_PASSWORD.HEADER is</span>
<span class="hljs-comment">// visible before continuing.</span>
.then(
  click(
    selectors.ENTER_EMAIL.SUBMIT, selectors.SIGNUP_PASSWORD.HEADER
  )
)
.then(
  testElementValueEquals(selectors.SIGNUP_PASSWORD.EMAIL, email)
)
</code></pre>
<p>An alternative way to wait is to use the <a href="#check-if-an-element-exists">testElementExists</a> helper:</p>
<pre><code class="hljs css language-js">...
.then(click(selectors.ENTER_EMAIL.SUBMIT))
.then(testElementExists(selectors.SIGNUP_PASSWORD.HEADER))
.then(
  testElementValueEquals(selectors.SIGNUP_PASSWORD.EMAIL, email)
)
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="cross-test-contamination"></a><a href="#cross-test-contamination" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Cross test contamination</h3>
<p>Sometimes tests pass when run in isolation, but fail as soon
as the whole suite is run. This is usually caused by cross
test state contamination. Often times in the test preceding
the failing test, a user is signed in and the failing test
assumes no user is signed in.</p>
<p>In the <code>beforeEach</code> method of your suite, always be sure to call <a href="https://github.com/mozilla/fxa/blob/abfb9822760f9edf5175bdded0efa8e074b8ed84/packages/fxa-content-server/tests/functional/lib/helpers.js#L465">clearBrowserState</a>. By default, <code>clearBrowserState</code> tries clearing localStorage, but this does not always work if actions from the previous test have not completed. Passing the <code>force: true</code> option will ensure browser state is cleared because it redirects away from the page the previous test was on.</p>
<pre><code class="hljs css language-js">...
  beforeEach: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.remote.then(clearBrowserState({ <span class="hljs-attr">force</span>: <span class="hljs-literal">true</span> }));
  },
...
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="an-element-is-not-visible-or-is-fading-in"></a><a href="#an-element-is-not-visible-or-is-fading-in" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>An element is not visible or is fading in</h3>
<p>One common problem is that Selenium <em>sometimes</em> refuses to read attribute values
on DOM elements unless they are 100% visible, meaning elements that are in the process
of being faded in or out sometimes cause errors. This is particularly problematic
on tooltips and status messages that use animations.</p>
<p>If this occurs, use the <a href="#check-if-an-element-is-visible">visibleByQSA</a> helper to ensure
the element is fully visible.</p>
<pre><code class="hljs css language-js">...
.then(visibleByQSA(selectors.ENTER_EMAIL.ERROR))
.then(testElementTextEquals(selectors.ENTER_EMAIL.ERROR, <span class="hljs-string">'account no longer exists'</span>))
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="an-element-is-obviously-there-and-visible-but-selenium-says-it-cannot-be-found"></a><a href="#an-element-is-obviously-there-and-visible-but-selenium-says-it-cannot-be-found" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>An element is obviously there and visible but Selenium says it cannot be found</h3>
<p>See <a href="#an-element-is-obviously-there-and-visible-but-selenium-says-it-cannot-be-found">An element is not visible or is fading in</a>.</p>
<h3><a class="anchor" aria-hidden="true" id="staleelementreference"></a><a href="#staleelementreference" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>staleElementReference</h3>
<p>This can occur if your selector is not specific enough and an element with the same
selector is used on two screens.</p>
<p>For example, there is an email input field on the <code>/</code> and <code>/signin</code> or <code>/signup</code>
screens. If the email field is referenced on the <code>/</code> screen, and then the same selector
is used to reference the email element in <code>/signin</code>, unless
<a href="#assuming-an-action-has-completed-aka-timing-issues">guards are put in place to avoid timing issues</a>,
it's possible for the runner to grab a reference to the email field from the <code>/</code> screen because it thinks it's already at the <code>/signin</code> screen. There are two possible mitigations:</p>
<ol>
<li>Ensure the screen transition has actually occurred by testing
for the header of the expected screen before operating on any of it's DOM elements.</li>
<li>Use a more specific selector.</li>
</ol>
<p>See also <a href="#assuming-an-action-has-completed-aka-timing-issues">Assuming an action has completed, a.k.a., timing issues</a>.</p>
<h3><a class="anchor" aria-hidden="true" id="timeout"></a><a href="#timeout" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>timeout</h3>
<p>Tests by default have 30 seconds to run. Sometimes a test needs longer. At the top of your test, you can change the timeout:</p>
<pre><code class="hljs css language-js"><span class="hljs-string">'long running test'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-comment">// allow for a full minute</span>
  <span class="hljs-keyword">this</span>.timeout = <span class="hljs-number">60</span>*<span class="hljs-number">1000</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.remote.then
    ...
},
...
</code></pre>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/ecosystem-platform/docs/fxa-engineering/fxa-tests-circleci"><span class="arrow-prev">← </span><span class="function-name-prevnext">Tests in CircleCI</span></a><a class="docs-next button" href="/ecosystem-platform/docs/fxa-engineering/fxa-content-server-architecture"><span>Content-server architecture</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#why-are-there-so-many-test-suites-that-seem-to-do-the-same-thing">Why are there so many test suites that seem to do the same thing?</a></li><li><a href="#how-do-i">How do I?</a><ul class="toc-headings"><li><a href="#run-a-single-test">Run a single test</a></li><li><a href="#add-a-new-test-file">Add a new test file</a></li><li><a href="#make-use-of-common-selectors">Make use of common selectors</a></li><li><a href="#example-test-suite">Example test suite</a></li><li><a href="#check-if-an-element-exists">Check if an element exists</a></li><li><a href="#check-if-an-element-is-visible">Check if an element is visible</a></li><li><a href="#type-into-an-element">Type into an element</a></li><li><a href="#check-an-elements-value">Check an element's value</a></li><li><a href="#click-on-an-element">Click on an element</a></li><li><a href="#create-a-unique-email">Create a unique email</a></li><li><a href="#create-a-user">Create a user</a></li><li><a href="#submit-a-form">Submit a form</a></li><li><a href="#test-ab-tests">Test A/B tests</a></li><li><a href="#simulate-interaction-with-the-browser-eg-webchannels">Simulate interaction with the browser, e.g., WebChannels</a></li><li><a href="#emulate-a-specific-user-agent">Emulate a specific user-agent</a></li><li><a href="#add-a-new-helper">Add a new helper</a></li></ul></li><li><a href="#why-do-my-tests-fail">Why do my tests fail?</a><ul class="toc-headings"><li><a href="#assuming-an-action-has-completed-aka-timing-issues">Assuming an action has completed, a.k.a., timing issues</a></li><li><a href="#cross-test-contamination">Cross test contamination</a></li><li><a href="#an-element-is-not-visible-or-is-fading-in">An element is not visible or is fading in</a></li><li><a href="#an-element-is-obviously-there-and-visible-but-selenium-says-it-cannot-be-found">An element is obviously there and visible but Selenium says it cannot be found</a></li><li><a href="#staleelementreference">staleElementReference</a></li><li><a href="#timeout">timeout</a></li></ul></li></ul></nav></div><footer><img src="/ecosystem-platform/img/mozilla-logo.png" height="24"/><script src="https://unpkg.com/mermaid@8.9.0/dist/mermaid.min.js" type="application/javascript"></script><script>
        mermaid.initialize({
            startOnReady: true,
            theme: 'forest',
            themeCSS: '.noteText { font-family: monospace; }'
          });
        // remarkable converts the mermaid diagrams to HTML and injects a bunch
        // of HTML tags the mermaid parser cannot handle. Remove the HTML and
        // run the parser on the original text.
        const mermaidDiagramEls = document.querySelectorAll('.language-mermaid');
        mermaidDiagramEls.forEach(function(diagramEl, index) {
          // strip out any HTML
          diagramEl.innerHTML = diagramEl.innerText;
          diagramEl.addEventListener('click', (evt) => {
            evt.currentTarget.classList.toggle('highlight');
            document.body.classList.toggle('highlight-service');
          }, false);
        });
        mermaid.init(undefined, mermaidDiagramEls);
        </script></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: 'bf6d9655ef3d5789d97465aff250ee76',
                indexName: 'mozilla_ecosystem-platform',
                inputSelector: '#search_input_react'
              });
            </script></body></html>