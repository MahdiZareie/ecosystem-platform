<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Firefox Accounts Subscription Platform · Firefox Ecosystem Platform</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="## Getting Started"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Firefox Accounts Subscription Platform · Firefox Ecosystem Platform"/><meta property="og:type" content="website"/><meta property="og:url" content="https://mozilla.github.io/ecosystem-platform/"/><meta property="og:description" content="## Getting Started"/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/ecosystem-platform/img/fx-master-brand.png"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script src="/ecosystem-platform/js/scrollSpy.js"></script><link rel="stylesheet" href="/ecosystem-platform/css/main.css"/><script src="/ecosystem-platform/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/ecosystem-platform/"><img class="logo" src="/ecosystem-platform/img/fx-master-brand.png" alt="Firefox Ecosystem Platform"/><h2 class="headerTitleWithLogo">Firefox Ecosystem Platform</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/ecosystem-platform/docs/welcome" target="_self">Docs</a></li><li class=""><a href="https://github.com/mozilla/ecosystem-platform" target="_self">GitHub</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>For FxA Engineers</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Introduction</h3><ul class=""><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/welcome">Welcome</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Platform</h3><ul class=""><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Firefox Accounts</h4><ul><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/firefox-accounts/fxa-overview">Overview</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/process/integration-with-fxa">Integration with FxA</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/relying-parties/end-to-end-encryption">End-to-end Encryption</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/relying-parties/metrics-for-relying-parties">Metrics</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/firefox-accounts/pairing">Pairing authentication</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Subscription Platform</h4><ul><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/sub-plat/sub-plat-overview">Overview</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/sub-plat/sub-plat-features">Subscription Features</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/process/integration-with-subscription-platform">Integration with Subscription Platform</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Firefox Push</h4><ul><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/firefox-push/push-feature">Overview</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/firefox-push/push-design">Design, API&#x27;s, Error Codes</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/firefox-push/push-development">Development Process</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/firefox-push/push-history">History</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Firefox Sync</h4><ul><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/firefox-sync/storage-feature">Storage</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/firefox-sync/account-management-feature">Account Management</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/process/sync-testing">Sync Testing</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/process/using-the-staging-environment">Using the Staging Environment</a></li></ul></div></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">For FxA Engineers</h3><ul class=""><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-dev-process">Development Process</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-work-breakdown-process">Work Breakdown Process</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/release-process">Release Process</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-incident-response">Incident Response</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-api">Internal API Documentation</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-system-diagrams">FxA System Diagrams</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-logging">Application Logging</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/automation-test-plan">Automation Test Plan</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/vscode-development">Using VS Code with FxA</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-sub-platform">Subscription Platform</a></li><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Topic Deep Dives</h4><ul><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-email">Processing Email</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-metrics">Metrics</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-localization">Localization</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-jwt-access-tokens">JWT Access Tokens</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-scoped-keys">Scoped Keys</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-onepw-protocol">onepw Protocol</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-webchannel-protocol">WebChannels in Desktop &amp; Fennec</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-oauth-webchannel-protocol">WebChannels in Fenix &amp; WebExtensions</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-content-server-ab-testing">Experiments &amp; A/B testing</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-tests-circleci">Tests in CircleCI</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/functional-testing">Functional/Selenium Tests</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-content-server-architecture">Content-server architecture</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-session-tokens">Session Tokens</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/process/interruptive-surveys">Running Surveys in FxA</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-github">GitHub Strategies</a></li></ul></div><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-adr">Architectural Decision Records</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-scheduled-maintenance">Scheduled Maintenance</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-additional-docs">Additional Docs</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 id="__docusaurus" class="postHeaderTitle">Firefox Accounts Subscription Platform</h1></header><article><div><span><h2><a class="anchor" aria-hidden="true" id="getting-started"></a><a href="#getting-started" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Getting Started</h2>
<p>Current as of <code>May 13, 2021</code>.</p>
<h3><a class="anchor" aria-hidden="true" id="pre-development"></a><a href="#pre-development" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Pre-Development</h3>
<p>To begin working on the subscription platform in the FxA codebase, you will need access to a Stripe account for private and public API developer keys.</p>
<p>If you're a Mozilla employee, you can request access to the Stripe dev (and/or stage) account, created for the FxA Subscription Platform team to easily connect with fake products and plans. Otherwise, you can create your own Stripe account to use for testing that is not linked to any bank account information with your own products and plans. These keys should be taken from Stripe's test environment which you can verify by checking that the key includes the word <code>test</code>.</p>
<p>The <code>fxa-payments-server</code> needs the Stripe public key (<code>pk</code>) and communicates with the <code>fxa-auth-server</code> that requires a Stripe private or secret key (<code>sk</code>).¹ These can be found in the Stripe Dashboard, and configuration details can be found below.</p>
<p>¹ We have, in the past, given out restricted keys for use (<code>rk</code>). We may choose to do this again in the future or even use them in our dev environment.</p>
<h3><a class="anchor" aria-hidden="true" id="configuration"></a><a href="#configuration" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Configuration</h3>
<p>You will need to create the file <code>fxa/packages/fxa-auth-server/config/secrets.json</code> and specify <code>subscriptions.stripeApiKey</code> with the value of your private Stripe API key. Ensure the key begins with <code>sk_test</code> to guarantee you are using the secret key and testing in the correct environment.</p>
<p>Ex:</p>
<pre><code class="hljs">{
  <span class="hljs-attr">"subscriptions"</span>: {
    <span class="hljs-attr">"stripeApiKey"</span>: <span class="hljs-string">"sk_test_####"</span>
  }
}
</code></pre>
<p>Additionally create the file <code>fxa/packages/fxa-payments-server/server/config/secrets.json</code> and specify <code>stripe.apiKey</code> to override the default Mozilla Stripe public API key with your own public key:</p>
<pre><code class="hljs">{
  <span class="hljs-attr">"stripe"</span>: {
    <span class="hljs-attr">"apiKey"</span>: <span class="hljs-string">"pk_test_####"</span>
  }
}
</code></pre>
<p>Note that neither <code>secrets.json</code> files are tracked in Git, and they take precedence over each server's default configurations, should you need to make any additional local-only modifications.</p>
<h4><a class="anchor" aria-hidden="true" id="stripe-productplans"></a><a href="#stripe-productplans" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Stripe Product/Plans</h4>
<p>To see the available products or create a new one in the Stripe dashboard, navigate to Billing &gt; Products and click into one of the products to see information including the product name, product ID, plan name, plan ID, metadata, logs, and events.</p>
<p>If you are using a new Stripe account, you will need to setup a product and its plan. The product should have additional metadata configured as needed.</p>
<p><strong>Please note:</strong> Product Names are the canonical displayed name shown in Sub Plat UI. In some cases these may be paired with a plan's billing interval. Plan names are not displayed to users.</p>
<h5><a class="anchor" aria-hidden="true" id="product-metadata"></a><a href="#product-metadata" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Product Metadata</h5>
<table>
<thead>
<tr><th>Key</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td>downloadURL</td><td>Required. The download or subscription success action URL for the product.</td></tr>
<tr><td>product:privacyNoticeURL</td><td>Required. The URL for the webpage containing the Privacy Notice for the product offering.</td></tr>
<tr><td>product:termsOfServiceURL</td><td>Required. The URL for the webpage containing the Terms of Service for the product offering.</td></tr>
<tr><td>product:termsOfServiceDownloadURL</td><td>Required. The URL for a downloadable version of the Terms of Service for the product offering, used in emails. This must be a URL to the FxA CDN at <a href="https://accounts-static.cdn.mozilla.net">https://accounts-static.cdn.mozilla.net</a>. It can be either a) full, direct URL to a PDF (e.g. <a href="https://accounts-static.cdn.mozilla.net/legal/Mozilla_VPN_ToS/en-US.pdf">https://accounts-static.cdn.mozilla.net/legal/Mozilla_VPN_ToS/en-US.pdf</a>), or, b) a URL without the language and file extension (e.g. <a href="https://accounts-static.cdn.mozilla.net/legal/mozilla_vpn_tos">https://accounts-static.cdn.mozilla.net/legal/mozilla_vpn_tos</a>). See the &quot;Legal Document Download URL Metadata&quot; section below for more information.</td></tr>
<tr><td>webIconURL</td><td>Required. Image URL for product icon in web content. This must be a URL to the FxA CDN at <a href="https://accounts-static.cdn.mozilla.net">https://accounts-static.cdn.mozilla.net</a>.</td></tr>
<tr><td>capabilities</td><td>Required if <code>capabilities:{clientID}</code> is not provided. Comma-separated list of capabilities enabled by this product for all Relying Parties.</td></tr>
<tr><td>capabilities:{clientID}</td><td>Required if <code>capabilities</code> is not provided. Comma-separated list of capabilities enabled by this product for the Relying Party identified by {clientID}.</td></tr>
<tr><td>emailIconURL</td><td>Optional. Image URL for product icon in email content. This must be a URL to the FxA CDN at <a href="https://accounts-static.cdn.mozilla.net">https://accounts-static.cdn.mozilla.net</a>.</td></tr>
<tr><td>appStoreLink</td><td>Optional. The App store download URL for the product.</td></tr>
<tr><td>playStoreLink</td><td>Optional. The google play store download URL for the product.</td></tr>
<tr><td>productSet</td><td>Optional. An arbitrary string used to group products in a set of upgrades &amp; downgrades.</td></tr>
<tr><td>productOrder</td><td>Optional. A number used for sorting products in a set.</td></tr>
<tr><td>product:details:{n}</td><td>Optional. Bullet-point feature details for the product, where {n} is a number or ordering the points.</td></tr>
<tr><td>product:details:{n}:{locale}</td><td>Optional. Localized string override for product:details:{n}, where {locale} is the locale (e.g. fr-FR, zh-CN, de, etc).</td></tr>
<tr><td>product:privacyNoticeURL:{locale}</td><td>Optional. Localized override URL for the webpage containing the Privacy Notice for the product offering.</td></tr>
<tr><td>product:privacyNoticeDownloadURL</td><td>Optional. The URL for a downloadable version of the Privacy Notice for the product offering. This has the same requirements as product:termsOfServiceDownloadURL.</td></tr>
<tr><td>product:termsOfServiceURL:{locale}</td><td>Optional. Localized override URL for the webpage containing the Terms of Service for the product offering.</td></tr>
<tr><td>product:subtitle</td><td>Optional. A subtitle for the product, usually displayed beneath the name in UI.</td></tr>
<tr><td>product:subtitle:{locale}</td><td>Optional. Localized string override for product:subtitle, where {locale} is the locale (e.g. fr-FR, zh-CN, de, etc).</td></tr>
<tr><td>product:successActionButtonLabel</td><td>Optional. An alternative label for the subscription success action button. The action is specified by <code>downloadURL</code>.</td></tr>
<tr><td>product:successActionButtonLabel:{locale}</td><td>Optional. Localized override for the alternative label for the subscription success action button.</td></tr>
<tr><td>support:app:{x}</td><td>Optional. An app or service for the support form. The form options will be in the same order as the metadata. These values shouldn't be too long as they are displayed in dropdown options of limited width. The <code>{x}</code> part of the key can be any string and will not be used anywhere; the value of the metadata is submitted to Zendesk.</td></tr>
<tr><td>upgradeCTA</td><td>Optional. HTML content string describing available upgrades from this plan. By convention, should include a link back to a product lead page. That lead page links back to FxA's plan subscription pages.</td></tr>
</tbody>
</table>
<h6><a class="anchor" aria-hidden="true" id="product-metadata-defaults"></a><a href="#product-metadata-defaults" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Product Metadata defaults</h6>
<p>Some of the metadata properties listed above <a href="https://github.com/mozilla/fxa/blob/main/packages/fxa-shared/subscriptions/metadata.ts#L14">have defaults</a> that are used when they're not defined in Stripe:</p>
<pre><code class="hljs">  <span class="hljs-attribute">subtitle</span>: <span class="hljs-string">'Full-device VPN'</span>,
  <span class="hljs-attribute">details</span>: [
    <span class="hljs-string">'Device-level encryption'</span>,
    <span class="hljs-string">'Servers in 30+ countries'</span>,
    <span class="hljs-string">'Connect 5 devices with one subscription'</span>,
    <span class="hljs-string">'Available for Windows, iOS and Android'</span>,
  ],
  <span class="hljs-attribute">termsOfServiceURL</span>:
    <span class="hljs-string">'https://www.mozilla.org/about/legal/terms/firefox-private-network'</span>,
  <span class="hljs-attribute">termsOfServiceDownloadURL</span>:
    <span class="hljs-string">'https://accounts-static.cdn.mozilla.net/legal/Mozilla_VPN_ToS/en-US.pdf'</span>,
  <span class="hljs-attribute">privacyNoticeURL</span>: <span class="hljs-string">'https://www.mozilla.org/privacy/firefox-private-network'</span>,
  <span class="hljs-attribute">privacyNoticeDownloadURL</span>:
    <span class="hljs-string">'https://accounts-static.cdn.mozilla.net/legal/mozilla_vpn_privacy_notice/en-US.pdf'</span>,
</code></pre>
<h6><a class="anchor" aria-hidden="true" id="legal-document-download-url-metadata"></a><a href="#legal-document-download-url-metadata" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Legal Document Download URL Metadata</h6>
<p>For the legal document download URL metadata,
<code>product:termsOfServiceDownloadURL</code> and <code>product:privacyNoticeDownloadURL</code>,
they can be in the form of an incomplete URL, as they will be handled by a
redirect endpoint that tries to best match the user's locale to a localized
version of the document.  For example, if the value of
<code>product:termsOfServiceDownloadURL</code> is
'<a href="https://accounts-static.cdn.mozilla.net/legal/mozilla_vpn_tos'">https://accounts-static.cdn.mozilla.net/legal/mozilla_vpn_tos'</a> and the user's
locale is <code>de</code>, then the endpoint will redirect the user to
<a href="https://accounts-static.cdn.mozilla.net/legal/mozilla_vpn_tos.de.pdf">https://accounts-static.cdn.mozilla.net/legal/mozilla_vpn_tos.de.pdf</a>.</p>
<h5><a class="anchor" aria-hidden="true" id="subscription-metadata"></a><a href="#subscription-metadata" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Subscription Metadata</h5>
<table>
<thead>
<tr><th>Key</th><th>Value</th></tr>
</thead>
<tbody>
<tr><td>previous_plan_id</td><td>The value of the previous plan that the user had been subscribed to.</td></tr>
<tr><td>plan_change_date</td><td>Unix timestamp of the date the plan was changed.</td></tr>
<tr><td>cancelled_for_customer_at</td><td>Unix timestamp of the date when the subscription was cancelled for the customer through FxA UI</td></tr>
</tbody>
</table>
<h2><a class="anchor" aria-hidden="true" id="navigating-the-payment-flow"></a><a href="#navigating-the-payment-flow" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Navigating the Payment Flow</h2>
<p>Once your API keys are set, restart the affected servers (<code>auth</code> or <code>payments</code>) if needed.</p>
<p>Reference the <a href="https://github.com/mozilla/fxa#workflow">workflow</a> section of the FxA docs to sign up for and verify an account. You should now be able to access the payment flow at:</p>
<pre><code class="hljs"><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/localhost:3030/subscriptions</span><span class="hljs-regexp">/products/</span>{productId}?plan={planId}
</code></pre>
<p>The <code>productId</code> should match the ID from a product taken from the Stripe dashboard. The <code>plan</code> parameter is optional, unless you want to specify a plan.  Otherwise, if the product has multiple plans, the first one in the list as returned by Stripe is used.  If you are running the entire FxA stack and are using the keys from the Stripe FxA dev account, you can navigate to <code>123done</code> on port <code>:8080</code> to click on the link beginning with &quot;Subscribe&quot; to reach the form with a prepopulated product.</p>
<p>Enter any name, valid expiration date, CVC number, and any card number from the <a href="https://stripe.com/docs/testing#cards">Stripe test cards docs</a> to successfully create a test subscription.</p>
<p>Navigate back to <code>http://localhost:3030/subscriptions</code> to manage your subscriptions.</p>
<h2><a class="anchor" aria-hidden="true" id="understanding-subscription-status"></a><a href="#understanding-subscription-status" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Understanding Subscription Status</h2>
<p>Stripe defines the <a href="https://stripe.com/docs/api/subscriptions/object#subscription_object-status">valid states a subscription status can be in their API docs</a>.
Since <code>incomplete</code> and <code>incomplete_expired</code> are subscriptions that have never been paid, FxA ignores them except for the following condition: if a user with a subscription in an <code>incomplete</code> state successfully enters valid payment information, the <code>incomplete</code> subscription will be paid and activated.</p>
<p>FxA's Stripe account is configured to not allow subscriptions to become <code>unpaid</code> and will cancel the subscription instead.</p>
<p>The last 4 states are <code>active</code>, <code>trialing</code>, <code>past_due</code>, and <code>cancelled</code>. The first three of these are considered active for the purposes of allowing the user access to the capabilities provided by the subscription, while <code>cancelled</code> subscriptions grant none.</p>
<h3><a class="anchor" aria-hidden="true" id="stripe-radar-and-payment-blocking"></a><a href="#stripe-radar-and-payment-blocking" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Stripe Radar and Payment Blocking</h3>
<p>We use <a href="https://stripe.com/docs/radar/rules">Stripe Radar</a> to block payments from both potentially abusive sources as well as from potential subscribers in currently unsupported regions. Our production radar rules are <a href="https://mana.mozilla.org/wiki/display/FIREFOX/Stripe+Radar+Rules">documented in Mana</a>.</p>
<h2><a class="anchor" aria-hidden="true" id="interactions-with-stripe"></a><a href="#interactions-with-stripe" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Interactions with Stripe</h2>
<h3><a class="anchor" aria-hidden="true" id="payments-server"></a><a href="#payments-server" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Payments Server</h3>
<p>The payments server is an isolated service that serves all subscription related
pages that utilize the Stripe Javascript SDK. It's isolated from the primary FxA
domain to comply with constraints on 3rd party Javascript on pages handling FxA
authentication.</p>
<p>When a subscription page is loaded, the React application served by the payment
server:</p>
<ol>
<li>Loads the Stripe Javascript SDK (for tokenizing credit cards)</li>
<li>Makes direct OAuth authenticated API calls to <a href="https://github.com/mozilla/fxa/blob/main/packages/fxa-auth-server/docs/api.md#account">account</a>/<a href="https://github.com/mozilla/fxa/blob/main/packages/fxa-auth-server/docs/api.md#subscriptions">subscription endpoints</a>
on the Auth Server as needed</li>
</ol>
<p>The payments server handles the payment flow as well as serving pages for managing
a user's subscription that are linked from the Settings page.</p>
<h3><a class="anchor" aria-hidden="true" id="auth-server"></a><a href="#auth-server" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Auth Server</h3>
<p>FxA's Auth Server makes Stripe API calls for authenticated FxA users via its <a href="https://github.com/mozilla/fxa/blob/main/packages/fxa-auth-server/docs/api.md#subscriptions">subscription
endpoints</a>. Stripe updates are sent back to the Auth Server via Stripe webhooks when a
users subscription has been created/updated/deleted.</p>
<p>Some Stripe webhooks will trigger emails.  These emails are behind a feature flag.  If you wish to send emails in your environment, set the auth server configuration</p>
<pre><code class="hljs">{
  <span class="hljs-attr">"subscriptions"</span>: {
    <span class="hljs-attr">"transactionalEmails"</span>: {
      <span class="hljs-attr">"enabled"</span>: <span class="hljs-literal">true</span>
    }
  }
}
</code></pre>
<p>or the environment variable <code>SUBSCRIPTIONS_TRANSACTIONAL_EMAILS_ENABLED</code> to &quot;true&quot;.  In order to receive Stripe webhook events in your local development, you need to use the <a href="https://stripe.com/docs/stripe-cli/webhooks">Stripe CLI</a>'s event forwarding feature.  (For how to view these and other FxA emails, see <a href="https://github.com/mozilla/fxa/#running-with-maildev">the FxA README section on MailDev</a>.)</p>
<h2><a class="anchor" aria-hidden="true" id="paypal-integration"></a><a href="#paypal-integration" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>PayPal Integration</h2>
<p>PayPal can be configured as an additional payment provider in the Subscription Platform.  PayPal's <a href="https://developer.paypal.com/docs/archive/express-checkout/integration-guide/ECReferenceTxns/">Express Checkout Reference Transactions</a> is the feature that enables the Subscription Platform to use PayPal as a payment provider for recurring subscriptions.  The customer's PayPal Billing Agreement ID is saved for future subscription invoices.  See <a href="#paypal-checkout">the diagram below</a> for details on this process.</p>
<p>The PayPal paid subscriptions are still driven by Stripe's subscription and invoicing model.  The key difference is that PayPal paid subscriptions have a <a href="https://stripe.com/docs/api/subscriptions/object#subscription_object-collection_method">collection method</a> of <code>send_invoice</code>.  The <a href="#paypal-processor">PayPal processor</a> is used to pay the invoices with the customer's billing agreement ID.</p>
<h3><a class="anchor" aria-hidden="true" id="paypal-accounts"></a><a href="#paypal-accounts" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>PayPal Accounts</h3>
<p>You need three types of PayPal accounts for development.</p>
<ul>
<li>PayPal Developer Account: allows you to access the PayPal Developer Dashboard</li>
<li>Sandbox PayPal Personal Account: used for testing as the customer</li>
<li>Sandbox PayPal Business Account: used for testing</li>
</ul>
<p>To create a PayPal developer account, sign up at <a href="https://developer.paypal.com/">https://developer.paypal.com/</a>.  Note that if you are a Mozilla employee, you should contact the Mozilla PayPal admin in Finance to set up a developer account.  Additionally, you should <a href="https://www.paypal.com/businessmanage/profile/loginSecurity">enable 2FA for the developer account</a>.</p>
<p>Once you are in the PayPal developer dashboard, navigate to &quot;Accounts&quot; under the Sandbox section of the menu.  Here you can create <a href="https://developer.paypal.com/docs/api-basics/sandbox/accounts/">a pair of personal and business sandbox accounts</a>.  (To easily create multiple accounts for testing, there's a <a href="https://developer.paypal.com/docs/api-basics/sandbox/bulk-accounts/">bulk account creation feature</a>.)</p>
<p>Once you've added your account pair, navigate to the bussines account by selecting &quot;View/edit account&quot;.  Now click on the &quot;API Credentials&quot; tab.  You'll need the &quot;NVP/SOAP Sandbox API Credentials&quot; for the next section.</p>
<h3><a class="anchor" aria-hidden="true" id="configuration-1"></a><a href="#configuration-1" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Configuration</h3>
<h4><a class="anchor" aria-hidden="true" id="auth-server-1"></a><a href="#auth-server-1" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Auth Server</h4>
<p>In order to enable and use PayPal in the auth server, set the following configuration options</p>
<pre><code class="hljs">{
  <span class="hljs-attr">"subscriptions"</span>: {
    <span class="hljs-attr">"paypalNvpSigCredentials"</span>: {
      <span class="hljs-attr">"enabled"</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">"sandbox"</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">"user"</span>: <span class="hljs-string">"your PayPal NVP API User name"</span>,
      <span class="hljs-attr">"pwd"</span>: <span class="hljs-string">"your PayPal NVP API password"</span>,
      <span class="hljs-attr">"signature"</span>: <span class="hljs-string">"your PayPal NVP API signature"</span>
    }
  }
}
</code></pre>
<p>The environment variables equivalent would be</p>
<pre><code class="hljs"><span class="hljs-attr">SUBSCRIPTIONS_PAYPAL_ENABLED</span>=<span class="hljs-literal">true</span> \
<span class="hljs-attr">PAYPAL_SANDBOX</span>=<span class="hljs-literal">true</span> \
<span class="hljs-attr">PAYPAL_NVP_USER</span>=<span class="hljs-string">'your PayPal NVP API User name'</span> \
<span class="hljs-attr">PAYPAL_NVP_PWD</span>=<span class="hljs-string">'your PayPal NVP API password'</span> \
<span class="hljs-attr">PAYPAL_NVP_SIGNATURE</span>=<span class="hljs-string">'your PayPal NVP API signature'</span>
</code></pre>
<h4><a class="anchor" aria-hidden="true" id="payments-server-1"></a><a href="#payments-server-1" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Payments Server</h4>
<p>The Payments frontend also does not offer PayPal as payment provider by default.  To enable the feature, set the following configuration options</p>
<pre><code class="hljs">{
  <span class="hljs-string">"featureFlags"</span>: {
    <span class="hljs-string">"usePaypalUIByDefault"</span>: <span class="hljs-literal">true</span>,
    }
  },
  <span class="hljs-string">"paypal"</span>: {
    <span class="hljs-string">"clientId"</span>: <span class="hljs-string">"sb"</span>,
    <span class="hljs-string">"apiUrl"</span>: <span class="hljs-string">"https://www.sandbox.paypal.com"</span>,
    <span class="hljs-string">"scriptUrl"</span>: <span class="hljs-string">"https://www.paypal.com"</span>
  }
}
</code></pre>
<p>Or use the environment variables</p>
<pre><code class="hljs"><span class="hljs-attr">FEATURE_USE_SCA_PAYMENT_UI_BY_DEFAULT</span>=<span class="hljs-literal">true</span> \
<span class="hljs-attr">PAYPAL_CLIENT_ID</span>=<span class="hljs-string">'sb'</span> \
<span class="hljs-attr">PAYPAL_API_URL</span>=<span class="hljs-string">'https://www.sandbox.paypal.com'</span> \
<span class="hljs-attr">PAYPAL_SCRIPT_URL</span>=<span class="hljs-string">'https://www.paypal.com'</span>
</code></pre>
<p>The paypal<em>/PAYPAL_</em> values are the defaults in the repo.  For local development, you do not need to change them.</p>
<h3><a class="anchor" aria-hidden="true" id="the-paypal-button"></a><a href="#the-paypal-button" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The PayPal Button</h3>
<p>The Payments frontend uses the <a href="https://developer.paypal.com/docs/business/javascript-sdk/">PayPal JavaScript SDK</a> to <a href="https://developer.paypal.com/docs/business/checkout/configure-payments/single-page-app/">add a button</a> to the checkout process to <a href="https://developer.paypal.com/docs/business/javascript-sdk/javascript-sdk-configuration/#intent-options-when-integrating-with-older-apis">integrate with PayPal's NVP/SOAP API</a>.  This button is loaded and displayed in an iFrame by PayPal.</p>
<h3><a class="anchor" aria-hidden="true" id="instant-payment-notification-ipn"></a><a href="#instant-payment-notification-ipn" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Instant Payment Notification (IPN)</h3>
<p><a href="https://developer.paypal.com/docs/api-basics/notifications/ipn/">PayPal IPN</a> is PayPal's equivalent of Stripe's webhook feature.  We do rely on IPNs in the Subscription Platform.  Unlike Stripe, however, PayPal does not offer any tool that would forward the events to your local environment.  Our team use <a href="https://ngrok.com/">ngrok</a> for that purpose.</p>
<p>Once you have the services running locally, start ngrok with <code>ngrok 9000</code> and note the public URL.  Using your sandbox business account and the public URL fron ngrok, complete <a href="https://developer.paypal.com/docs/api-basics/notifications/ipn/IPNSetup/">these steps to set up IPNs</a>.</p>
<h3><a class="anchor" aria-hidden="true" id="paypal-processor"></a><a href="#paypal-processor" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>PayPal Processor</h3>
<p>After the initial payment during subscription creation, the recurring payments for future invoices are handled by the PayPal processor script.  To simulate or debug charging additional invoices paid by PayPal, you need to run this script.  It is located at <code>packages/fxa-auth-server/scripts/paypal-process.ts</code>.</p>
<p>The script will make up to a configurable number of <a href="https://developer.paypal.com/docs/archive/express-checkout/ec-set-up-reference-transactions/#capture-future-payments">attempts to pay</a> an invoice before cancelling the subscription.  This attempts count is saved to the invoice itself as metadata.  The invoice's metadata is also used to prevent sending multiple failed payment emails per invoice from the PayPal payment attempts.</p>
<h2><a class="anchor" aria-hidden="true" id="ladder-diagrams-of-payment-interactions"></a><a href="#ladder-diagrams-of-payment-interactions" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Ladder Diagrams of Payment Interactions</h2>
<h3><a class="anchor" aria-hidden="true" id="paypal-checkout"></a><a href="#paypal-checkout" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>PayPal Checkout</h3>
<p>Conditions for this flow:</p>
<ul>
<li>User has no payment source on file, or is a new customer.</li>
<li>User clicks the displayed <a href="https://developer.paypal.com/docs/checkout/integrate/#3-render-the-smart-payment-buttons">PayPal Smart Button</a> to pay with PayPal.</li>
</ul>
<p>This diagram represents the activity after the PayPal button is clicked.</p>
<pre><code class="hljs css language-mermaid">sequenceDiagram
  autonumber
  participant <span class="hljs-type">B</span> <span class="hljs-keyword">as</span> <span class="hljs-type">Browser</span>
  participant <span class="hljs-type">A</span> <span class="hljs-keyword">as</span> <span class="hljs-type">FxA</span> <span class="hljs-type">Auth</span> <span class="hljs-type">Server</span>
  participant <span class="hljs-type">P</span> <span class="hljs-keyword">as</span> <span class="hljs-type">PayPal</span>
  participant <span class="hljs-type">S</span> <span class="hljs-keyword">as</span> <span class="hljs-type">Stripe</span>

  <span class="hljs-type">Note</span> over <span class="hljs-type">B</span>: <span class="hljs-type">Code</span> run by createOrder callback <span class="hljs-keyword">to</span> provide <span class="hljs-type">Checkout</span> <span class="hljs-type">Token</span>.
  opt <span class="hljs-type">Customer</span> hasn't been created
  <span class="hljs-type">B</span>-&gt;&gt;<span class="hljs-type">A</span>: <span class="hljs-type">POST</span> /oauth/subscriptions/customer
  <span class="hljs-type">A</span>-&gt;&gt;<span class="hljs-type">S</span>: <span class="hljs-type">Create</span> <span class="hljs-type">Customer</span>
  <span class="hljs-type">S</span>-&gt;&gt;<span class="hljs-type">A</span>: <span class="hljs-type">Customer</span> <span class="hljs-type">Response</span>
  <span class="hljs-type">Note</span> over <span class="hljs-type">A</span>: <span class="hljs-type">Stripe</span> customer id linked <span class="hljs-keyword">to</span> user.
  <span class="hljs-type">A</span>-&gt;&gt;<span class="hljs-type">B</span>: <span class="hljs-type">Customer</span> <span class="hljs-type">Record</span>
  <span class="hljs-keyword">end</span>
  <span class="hljs-type">B</span>-&gt;&gt;<span class="hljs-type">A</span>: <span class="hljs-type">POST</span> /oauth/subscription/paypal-checkout
  <span class="hljs-type">A</span>-&gt;&gt;<span class="hljs-type">P</span>: <span class="hljs-type">SetExpressCheckout</span>
  <span class="hljs-type">P</span>-&gt;&gt;<span class="hljs-type">A</span>: <span class="hljs-type">Checkout</span> <span class="hljs-type">Token</span>
  <span class="hljs-type">A</span>-&gt;&gt;<span class="hljs-type">B</span>: <span class="hljs-type">Checkout</span> <span class="hljs-type">Token</span>

  <span class="hljs-type">Note</span> over <span class="hljs-type">B</span>: <span class="hljs-type">PayPal</span> <span class="hljs-type">Popup</span> <span class="hljs-keyword">for</span> <span class="hljs-type">User</span> <span class="hljs-keyword">to</span> confirm
  <span class="hljs-type">Note</span> over <span class="hljs-type">B</span>: <span class="hljs-type">User</span> confirms, code run by onApprove
  <span class="hljs-type">Note</span> over <span class="hljs-type">B</span>: <span class="hljs-type">Display</span> <span class="hljs-symbol">'Processing'</span> <span class="hljs-type">Message</span>
  <span class="hljs-type">B</span>-&gt;&gt;<span class="hljs-type">A</span>: <span class="hljs-type">POST</span> /oauth/subscription/active/<span class="hljs-keyword">new</span>
  <span class="hljs-type">A</span>-&gt;&gt;<span class="hljs-type">P</span>: <span class="hljs-type">CreateBillingAgreement</span>
  <span class="hljs-type">P</span>-&gt;&gt;<span class="hljs-type">A</span>: <span class="hljs-type">Billing</span> <span class="hljs-type">Agreement</span> <span class="hljs-type">Response</span>
  <span class="hljs-type">Note</span> over <span class="hljs-type">A</span>: <span class="hljs-type">Store</span> <span class="hljs-type">Billing</span> <span class="hljs-type">Agreement</span> <span class="hljs-type">ID</span> <span class="hljs-keyword">in</span> <span class="hljs-type">Db</span>.
  <span class="hljs-type">A</span>-&gt;&gt;<span class="hljs-type">S</span>: <span class="hljs-type">Update</span> customer metadata w/<span class="hljs-type">PayPal</span> <span class="hljs-type">Billing</span> <span class="hljs-type">Agreement</span> <span class="hljs-type">ID</span>
  <span class="hljs-type">A</span>-&gt;&gt;<span class="hljs-type">S</span>: <span class="hljs-type">Create</span> subscription
  <span class="hljs-type">Note</span> over <span class="hljs-type">S</span>: <span class="hljs-type">Invoice</span> created
  <span class="hljs-type">S</span>-&gt;&gt;<span class="hljs-type">A</span>: <span class="hljs-type">Customer</span> update response
  <span class="hljs-type">S</span>-&gt;&gt;<span class="hljs-type">A</span>: <span class="hljs-type">Subscription</span> create response
  <span class="hljs-type">A</span>-&gt;&gt;<span class="hljs-type">S</span>: <span class="hljs-type">Finalize</span> invoice w/auto_advance <span class="hljs-literal">false</span>
  <span class="hljs-type">A</span>-&gt;&gt;<span class="hljs-type">P</span>: <span class="hljs-type">DoReferenceTransaction</span>
  <span class="hljs-type">S</span>-&gt;&gt;<span class="hljs-type">A</span>: <span class="hljs-type">Invoice</span> finalize response
  <span class="hljs-type">P</span>-&gt;&gt;<span class="hljs-type">A</span>: <span class="hljs-type">Transaction</span> response
  <span class="hljs-type">A</span>-&gt;&gt;<span class="hljs-type">S</span>: <span class="hljs-type">Update</span> invoice w/<span class="hljs-type">PayPal</span> <span class="hljs-type">Transaction</span> <span class="hljs-type">ID</span>
  <span class="hljs-type">A</span>-&gt;&gt;<span class="hljs-type">S</span>: <span class="hljs-type">Pay</span> invoice out-<span class="hljs-keyword">of</span>-band
  <span class="hljs-type">S</span>-&gt;&gt;<span class="hljs-type">A</span>: <span class="hljs-type">Update</span> response
  <span class="hljs-type">S</span>-&gt;&gt;<span class="hljs-type">A</span>: <span class="hljs-type">Invoice</span> pay response
  <span class="hljs-type">A</span>-&gt;&gt;<span class="hljs-type">B</span>: <span class="hljs-type">Subscription</span> created response

  <span class="hljs-type">B</span>-&gt;&gt;<span class="hljs-type">B</span>: <span class="hljs-type">Redirect</span> <span class="hljs-keyword">to</span> <span class="hljs-type">Success</span> page

</code></pre>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/ecosystem-platform/docs/fxa-engineering/vscode-development"><span class="arrow-prev">← </span><span class="function-name-prevnext">Using VS Code with FxA</span></a><a class="docs-next button" href="/ecosystem-platform/docs/fxa-engineering/fxa-email"><span>Processing Email</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#getting-started">Getting Started</a><ul class="toc-headings"><li><a href="#pre-development">Pre-Development</a></li><li><a href="#configuration">Configuration</a></li></ul></li><li><a href="#navigating-the-payment-flow">Navigating the Payment Flow</a></li><li><a href="#understanding-subscription-status">Understanding Subscription Status</a><ul class="toc-headings"><li><a href="#stripe-radar-and-payment-blocking">Stripe Radar and Payment Blocking</a></li></ul></li><li><a href="#interactions-with-stripe">Interactions with Stripe</a><ul class="toc-headings"><li><a href="#payments-server">Payments Server</a></li><li><a href="#auth-server">Auth Server</a></li></ul></li><li><a href="#paypal-integration">PayPal Integration</a><ul class="toc-headings"><li><a href="#paypal-accounts">PayPal Accounts</a></li><li><a href="#configuration-1">Configuration</a></li><li><a href="#the-paypal-button">The PayPal Button</a></li><li><a href="#instant-payment-notification-ipn">Instant Payment Notification (IPN)</a></li><li><a href="#paypal-processor">PayPal Processor</a></li></ul></li><li><a href="#ladder-diagrams-of-payment-interactions">Ladder Diagrams of Payment Interactions</a><ul class="toc-headings"><li><a href="#paypal-checkout">PayPal Checkout</a></li></ul></li></ul></nav></div><footer><img src="/ecosystem-platform/img/mozilla-logo.png" height="24"/><script src="https://unpkg.com/mermaid@8.9.0/dist/mermaid.min.js" type="application/javascript"></script><script>
        mermaid.initialize({
            startOnReady: true,
            theme: 'forest',
            themeCSS: '.noteText { font-family: monospace; }'
          });
        // remarkable converts the mermaid diagrams to HTML and injects a bunch
        // of HTML tags the mermaid parser cannot handle. Remove the HTML and
        // run the parser on the original text.
        const mermaidDiagramEls = document.querySelectorAll('.language-mermaid');
        mermaidDiagramEls.forEach(function(diagramEl, index) {
          // strip out any HTML
          diagramEl.innerHTML = diagramEl.innerText;
          diagramEl.addEventListener('click', (evt) => {
            evt.currentTarget.classList.toggle('highlight');
            document.body.classList.toggle('highlight-service');
          }, false);
        });
        mermaid.init(undefined, mermaidDiagramEls);
        </script></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: 'bf6d9655ef3d5789d97465aff250ee76',
                indexName: 'mozilla_ecosystem-platform',
                inputSelector: '#search_input_react'
              });
            </script></body></html>