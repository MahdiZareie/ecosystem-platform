<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Content-server architecture · Firefox Ecosystem Platform</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="Current as of `Jan 20th, 2020`"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Content-server architecture · Firefox Ecosystem Platform"/><meta property="og:type" content="website"/><meta property="og:url" content="https://mozilla.github.io/ecosystem-platform/"/><meta property="og:description" content="Current as of `Jan 20th, 2020`"/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/ecosystem-platform/img/fx-master-brand.png"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script src="/ecosystem-platform/js/scrollSpy.js"></script><link rel="stylesheet" href="/ecosystem-platform/css/main.css"/><script src="/ecosystem-platform/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/ecosystem-platform/"><img class="logo" src="/ecosystem-platform/img/fx-master-brand.png" alt="Firefox Ecosystem Platform"/><h2 class="headerTitleWithLogo">Firefox Ecosystem Platform</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/ecosystem-platform/docs/welcome" target="_self">Docs</a></li><li class=""><a href="https://github.com/mozilla/ecosystem-platform" target="_self">GitHub</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Topic Deep Dives</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Introduction</h3><ul class=""><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/welcome">Welcome</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Platform</h3><ul class=""><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Firefox Accounts</h4><ul><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/firefox-accounts/fxa-overview">Overview</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/process/integration-with-fxa">Integration with FxA</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/relying-parties/end-to-end-encryption">End-to-end Encryption</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/relying-parties/metrics-for-relying-parties">Metrics</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/firefox-accounts/ecosystem-telemetry">Ecosystem Telemetry</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Subscription Platform</h4><ul><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/sub-plat/sub-plat-overview">Overview</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/sub-plat/sub-plat-features">Subscription Features</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/process/integration-with-subscription-platform">Integration with Subscription Platform</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Firefox Push</h4><ul><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/firefox-push/push-feature">Overview</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/firefox-push/push-design">Design, API&#x27;s, Error Codes</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/firefox-push/push-development">Development Process</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/firefox-push/push-history">History</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Firefox Sync</h4><ul><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/firefox-sync/sync-feature">Overview</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/firefox-sync/password-management-feature">Password Management and Syncing</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/firefox-sync/bookmarks-feature">Bookmarks</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/firefox-sync/storage-feature">Storage</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/firefox-sync/history-feature">History</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/features/firefox-sync/account-management-feature">Account Management</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/process/becoming-a-sync-client">Becoming A Sync Client</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/process/sync-testing">Sync Testing</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/process/using-the-staging-environment">Using the Staging Environment</a></li></ul></div></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">For FxA Engineers</h3><ul class=""><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-dev-process">Development Process</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/release-process">Release Process</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-api">Internal API Documentation</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-system-diagrams">FxA System Diagrams</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-logging">Application Logging</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/vscode-development">Using VS Code with FxA</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-sub-platform">Subscription Platform</a></li><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Topic Deep Dives</h4><ul><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-email">Processing Email</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-metrics">Metrics</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-localization">Localization</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-jwt-access-tokens">JWT Access Tokens</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-webchannel-protocol">WebChannels in Desktop &amp; Fennec</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-oauth-webchannel-protocol">WebChannels in Fenix &amp; WebExtensions</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-content-server-ab-testing">Experiments &amp; A/B testing</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-tests-circleci">Tests in CircleCI</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/functional-testing">Functional/Selenium Tests</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-content-server-architecture">Content-server architecture</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/process/interruptive-surveys">Running Surveys in FxA</a></li></ul></div><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-adr">Architectural Decision Records</a></li><li class="navListItem"><a class="navItem" href="/ecosystem-platform/docs/fxa-engineering/fxa-additional-docs">Additional Docs</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 id="__docusaurus" class="postHeaderTitle">Content-server architecture</h1></header><article><div><span><p>Current as of <code>Jan 20th, 2020</code></p>
<h2><a class="anchor" aria-hidden="true" id="document-purpose"></a><a href="#document-purpose" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Document purpose</h2>
<p>This is a starting point for developers and contributors of the Firefox Accounts Content Server. The content-server
is responsible for displaying the authentication/authorization and account settings related UI to the user.</p>
<h2><a class="anchor" aria-hidden="true" id="helpful-to-know-before-starting"></a><a href="#helpful-to-know-before-starting" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Helpful to know before starting</h2>
<p>At a high level, FxA is an <a href="https://stackoverflow.com/questions/6556522/authentication-versus-authorization">authentication (authn) and authorization (authz) system</a>. This means a Relying Party (RP) such as Firefox Sync or Send delegates
the responsibility for authenticating and authorizing users to Firefox Accounts. Once the user proves their
identity to FxA, we return one or more tokens the RP can use to access a &quot;protected resource&quot;.
The <a href="https://tools.ietf.org/html/rfc6749">OAuth 2.0 spec</a> does a good job of explaining these concepts.</p>
<pre><code class="hljs css language-mermaid">sequenceDiagram
  participant rp as Relying Party
  participant fxaback as FxA content<span class="hljs-built_in"> server </span>backend
  participant fxaweb as FxA content<span class="hljs-built_in"> server </span>UI
  participant fxaother as Other FxA backend services

  rp--&gt;&gt;fxaback: Authn/Authz request
  fxaback--&gt;&gt;fxaweb: send UI
  fxaweb-&gt;&gt;fxaweb:<span class="hljs-built_in"> user </span>authenticates/authorizes
  fxaweb--&gt;&gt;fxaother: forward<span class="hljs-built_in"> user </span>generated credentials
  fxaother--&gt;&gt;fxaother: check<span class="hljs-built_in"> user </span>generated credentials, generate RP credentials
  fxaother--&gt;&gt;fxaweb: return RP credentials
  fxaweb--&gt;&gt;fxaback: send metrics
  fxaweb--&gt;&gt;rp: send RP credentials
</code></pre>
<p>While FxA is an <a href="https://tools.ietf.org/html/rfc6749#section-1.1">OAuth 2.0 authorization server</a>, OAuth is
only one of several <a href="#relying-party-integrations">integration types</a> supported by FxA.
For more information about how FxA came to support so many non-standard integrations, see the <a href="https://docs.google.com/document/d/1jixykayGuyIGU8ecThHvvUpTeC4yq84KRalGr0Jh0xg/">App Services and FxA Unofficial History</a>.</p>
<p>Detailed <a href="./fxa-system-diagrams">Maps of the FxA Universe</a> outline how the various Firefox Accounts micro-services
fit together. The <a href="./fxa-system-diagrams#fxa-content-server">content-server centric view</a> will give an understanding
of which services communicate with FxA.</p>
<h3><a class="anchor" aria-hidden="true" id="relying-party-integrations"></a><a href="#relying-party-integrations" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Relying Party Integrations</h3>
<p>The content server architecture was heavily influenced by the number of ways Relying Parties (RPs)
integrate with FxA. If portions of the architecture seem byzantine and complex, chances are this is why.</p>
<ul>
<li>4 browser environments for Firefox Sync:
<ul>
<li>Firefox Desktop</li>
<li>Firefox for Android (Fennec)</li>
<li>Firefox for Android (Fenix)</li>
<li>Firefox for iOS</li>
</ul></li>
<li>WebExtensions such as Notes and the <a href="https://fpn.firefox.com/browser">Firefox Private Network &quot;secure proxy&quot; (FPN)</a></li>
<li>OAuth 2.0 such as <a href="https://monitor.firefox.com/">Monitor</a> and <a href="https://send.firefox.com/">Send</a></li>
<li>Native applications such as the <a href="https://fpn.firefox.com/vpn">Firefox Private Network VPN</a></li>
<li>&quot;Direct access&quot;, i.e., users browsing directly to <a href="https://accounts.firefox.com">https://accounts.firefox.com</a></li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="content-server-architecture-basics"></a><a href="#content-server-architecture-basics" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Content server architecture basics</h2>
<p>The content server is comprised of a server and client side components.</p>
<p>The server side is responsible for serving static content and ingesting metrics and error
reports.</p>
<p>The client side is a <a href="https://backbonejs.org/">Backbone</a> based Single Page Application (SPA) and responsible for screen rendering,
handling user input, communicating with various FxA backend services, and communicating with RPs or browsers.
The client app runs in modern Web capable systems, see <a href="fxa-dev-process#browser-support">supported browsers</a> for up to date tier 1 support.</p>
<p><strong>NOTE</strong> Yes, FxA uses Backbone. React wasn't a thing when FxA started, and converting FxA to use React
will be a journey of tears. <a href="#converting-to-react">Only attempt such a task piece by piece</a>.</p>
<p><strong>NOTE 2</strong> Our use of Backbone isn't strictly Model-View-Controller (MVC), ours is more like MVVM. We use Models and Views and have models for the Views.</p>
<h2><a class="anchor" aria-hidden="true" id="high-level-web-client-components"></a><a href="#high-level-web-client-components" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>High Level Web Client Components</h2>
<h3><a class="anchor" aria-hidden="true" id="auth-brokers"></a><a href="#auth-brokers" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Auth-Brokers</h3>
<p><a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-content-server/app/scripts/models/auth_brokers">Auth-Brokers</a> have two primary responsibilities:</p>
<ol>
<li>Mediate communication between Firefox Accounts and the RP</li>
<li>Screen-&gt;screen state machine</li>
</ol>
<p>To minimize the complexity, each integration type has its own broker so that
customizations can be made without interfering with other brokers.</p>
<p>Brokers are made up of a list of capabilities, methods, and behaviors. Brokers can extend exisiting brokers and overwrite
any of these properites to meet the specification of that integration.</p>
<ul>
<li><a href="https://github.com/mozilla/fxa/blob/5c527d8007c416b2f6122d8081f7756f8bc6733b/packages/fxa-content-server/app/scripts/models/auth_brokers/base.js#L539:L602">capabilities</a> can be thought of as feature flags, e.g., <a href="https://github.com/mozilla/fxa/blob/5c527d8007c416b2f6122d8081f7756f8bc6733b/packages/fxa-content-server/app/scripts/models/auth_brokers/base.js#L539:L602">&quot;does this integration support signup?&quot;</a>  (some versions of Firefox for iOS do not)</li>
<li>methods are invoked by views before and after certain events happen, e.g., <a href="https://github.com/mozilla/fxa/blob/5c527d8007c416b2f6122d8081f7756f8bc6733b/packages/fxa-content-server/app/scripts/models/auth_brokers/base.js#L270:L279"><code>afterSignIn</code></a> is called after a user signs in and can be used to notify the RP. Methods usually return a &quot;behavior&quot;, i.e., &quot;what to do next&quot;.</li>
<li>behaviors define &quot;what to do next&quot; after a method has completed. For example, <code>afterSignIn</code> by default <a href="https://github.com/mozilla/fxa/blob/5c527d8007c416b2f6122d8081f7756f8bc6733b/packages/fxa-content-server/app/scripts/models/auth_brokers/base.js#L106">sends the user to the /signin_confirmed screen</a>.</li>
</ul>
<p>Brokers communicate with RPs via the URL or a <a href="#channels">Channel</a>.</p>
<p><strong>NOTE️</strong> While placing screen-&gt;screen transition logic in auth_brokers might seem like an odd choice, this resulted
in a huge simplification over when complex transition logic was embedded in views. Some screen-&gt;screen transitions
depend on the integration type, and embedding this logic within the Views resulted in an unmaintainable
mess. The work to completely remove transition logic from views was never completed, and we have since
made many transitions more universal and it may be that we could move some of this logic back into views.
It may also be that distinct state machines outside of brokers would have been a better choice.</p>
<h4><a class="anchor" aria-hidden="true" id="auth-broker-implementations"></a><a href="#auth-broker-implementations" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Auth Broker implementations</h4>
<table>
<thead>
<tr><th>Broker</th><th style="text-align:center">Description</th></tr>
</thead>
<tbody>
<tr><td><a href="https://github.com/mozilla/fxa/blob/88f6119cc75ae75bd26f87cf5e42dc71e95411d4/packages/fxa-content-server/app/scripts/models/auth_brokers/base.js#L6">base</a></td><td style="text-align:center">Base broker that other brokers inhiert from.</td></tr>
<tr><td><a href="https://github.com/mozilla/fxa/blob/9a26577ee493fca55c4fe752fa940bac0286d066/packages/fxa-content-server/app/scripts/models/auth_brokers/fx-desktop-v3.js#L6">fx-desktop-v3</a></td><td style="text-align:center">v3 of the Fx Desktop authentication broker, it allows the uid of a user to change if the user's account has been deleted.</td></tr>
<tr><td><a href="https://github.com/mozilla/fxa/blob/2d5efe1264157e72ccd1ddbfc60d4bb6361a4d7b/packages/fxa-content-server/app/scripts/models/auth_brokers/fx-fennec-v1.js#L15">fx-fennec-v1</a></td><td style="text-align:center">Interfaces with Firefox for Android when authenticating for Sync, it communicates with the browser using WebChannels.</td></tr>
<tr><td><a href="https://github.com/mozilla/fxa/blob/a4f406cddc24478683ef6b8335dfe5423e21a62b/packages/fxa-content-server/app/scripts/models/auth_brokers/fx-ios-v1.js#L7">fx-ios-v1</a></td><td style="text-align:center">Interfaces with Sync on Fx for iOS. Uses the same custom protocol as fx-desktop-v1.</td></tr>
<tr><td><a href="https://github.com/mozilla/fxa/blob/16e58737d95214abe27337bd7ad3bbe07b4da8d2/packages/fxa-content-server/app/scripts/models/auth_brokers/fx-sync.js#L6">fx-sync</a></td><td style="text-align:center">Generic broker used to integrate into Sync. This is used as a base class.</td></tr>
<tr><td><a href="https://github.com/mozilla/fxa/blob/2d5efe1264157e72ccd1ddbfc60d4bb6361a4d7b/packages/fxa-content-server/app/scripts/models/auth_brokers/fx-sync-channel.js#L6">fx-sync-channel</a></td><td style="text-align:center">Base broker that communicates with the Firefox browser.</td></tr>
<tr><td><a href="https://github.com/mozilla/fxa/blob/25f33db4437b980f479911eea36ace35728c00df/packages/fxa-content-server/app/scripts/models/auth_brokers/fx-sync-web-channel.js#L6">fx-sync-web-channel</a></td><td style="text-align:center">Variant of Sync broker that communicates via webchannels.</td></tr>
<tr><td><a href="https://github.com/mozilla/fxa/blob/14543fdcd73d300946b7155c275391072d96e247/packages/fxa-content-server/app/scripts/models/auth_brokers/oauth-redirect.js#L5">oauth-redirect</a></td><td style="text-align:center">Oauth broker that finishes oauth flow by redirecting the current window.</td></tr>
<tr><td><a href="https://github.com/mozilla/fxa/blob/8701348cdd79dbdc9879b2b4a55a23a135a32bc1/packages/fxa-content-server/app/scripts/models/auth_brokers/oauth-redirect-chrome-android.js#L12">oauth-redirect-chrome-android</a></td><td style="text-align:center">Created because Chrome for Android will not allow the page to redirect unless its the result of a user action such as a click.</td></tr>
<tr><td><a href="https://github.com/mozilla/fxa/blob/a4f406cddc24478683ef6b8335dfe5423e21a62b/packages/fxa-content-server/app/scripts/models/auth_brokers/oauth-webchannel-v1.js#L6">oauth-webchannel-v1</a></td><td style="text-align:center">WebChannel OAuth broker that speaks 'v1' of the protocol.</td></tr>
<tr><td><a href="https://github.com/mozilla/fxa/blob/3173773c00c9d777b9c82d76be10f120e79af7b2/packages/fxa-content-server/app/scripts/models/auth_brokers/web.js#L6">web</a></td><td style="text-align:center">Auth broker to handle users who browse directly to the site.</td></tr>
<tr><td><a href="https://github.com/mozilla/fxa/blob/8701348cdd79dbdc9879b2b4a55a23a135a32bc1/packages/fxa-content-server/app/scripts/models/auth_brokers/pairing/authority.js#L5">pairing/authority</a></td><td style="text-align:center">Manages the OAuth flow by WebChannel messages to the browser to help with a pairing-based flow.</td></tr>
<tr><td><a href="https://github.com/mozilla/fxa/blob/fa545b9bc089c15cba6549a3277df45254fc7527/packages/fxa-content-server/app/scripts/models/auth_brokers/pairing/supplicant.js#L11">pairing/supplicant</a></td><td style="text-align:center">SupplicantBroker extends OAuthRedirectBroker to provide a redirect behaviour as an OAuth flow.</td></tr>
<tr><td><a href="https://github.com/mozilla/fxa/blob/25f33db4437b980f479911eea36ace35728c00df/packages/fxa-content-server/app/scripts/models/auth_brokers/pairing/supplicant-webchannel.js#L10">pairing/supplicant-webchannel</a></td><td style="text-align:center">SupplicantWebChannelBroker extends OAuthWebChannelBroker to provide a WebChannel flow.</td></tr>
</tbody>
</table>
<h3><a class="anchor" aria-hidden="true" id="channels"></a><a href="#channels" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Channels</h3>
<p>A <a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-content-server/app/scripts/lib/channels">channel</a> is a two way communication mechanism between a RP and Firefox Accounts. The method of communication is channel specific.</p>
<p>There are channels to:</p>
<ul>
<li>Communicate between FxA and the browser</li>
<li>Communicate between FxA and a WebExtension</li>
<li>Communicate between 2 or more FxA tabs</li>
</ul>
<h3><a class="anchor" aria-hidden="true" id="reliers"></a><a href="#reliers" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Reliers</h3>
<p>A <a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-content-server/app/scripts/models/reliers">Relier</a> fetches and holds data about the current RP. A Relier is created on startup and is
a central place to ensure data coming into and out of FxA is safe and well-formed.</p>
<p>Three primary types of Relier models exist:</p>
<ol>
<li>browser (for Sync integrations)</li>
<li>oauth</li>
<li>web (called relier)</li>
</ol>
<p><strong>NOTE</strong>: Any long lived data (e.g., email address, uid, client_id), coming from an RP or on the URL
<strong>MUST BE</strong> validated and transformed within Reliers. While it seems natural to ingest and sanitize
data in the Views, we are unable to control what users and malicious actors do. Assuming users always
enter at <code>/</code>, or at <code>/complete_sign_up</code>, etc, <em>does not hold</em>. To prevent XSS, we would have to validate
and sanitize long lived data <em>on every screen it is used</em>, and we saw many cases in the past where we
forgot to do this. Ingesting and validating the data on startup in the Relier model ensures the data
is checked once and is ensured to be safe afterwards.</p>
<p><strong>NOTE 2</strong>: The front end could probably be significantly simplified if all query parameter validation
logic was moved to the server.</p>
<h3><a class="anchor" aria-hidden="true" id="user"></a><a href="#user" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>User</h3>
<p>A <a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-content-server/app/scripts/models/user.js">User</a> holds and persists data about one or more Accounts as well as keeping track of the currently signed in user.</p>
<p><strong>NOTE</strong>: The user model was a premature solution to allow us to have an &quot;account chooser&quot; where a user visiting
a new RP would be able to choose from any of their signed in Accounts. We never implemented this, and the User
model has been a bit of a pain. The model does handle other things, though we could probably move most of its
responsibilities elsewhere and simplify the overall architecture.</p>
<h3><a class="anchor" aria-hidden="true" id="account"></a><a href="#account" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Account</h3>
<p>An <a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-content-server/app/scripts/models/account.js">Account</a> holds data about a given account and provides an API for making updates to the account. The account
model uses the fxa-js-client, fxa-oauth-client, and fxa-profile-client to operate on the account in any way.</p>
<h3><a class="anchor" aria-hidden="true" id="router"></a><a href="#router" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Router</h3>
<p>The <a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-content-server/app/scripts/router.js">Router</a> is responsible for reacting to URL changes and displaying the Views.</p>
<h3><a class="anchor" aria-hidden="true" id="views"></a><a href="#views" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Views</h3>
<p><a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-content-server/app/scripts/views">Views</a> represent either an entire screen or a portion of a screen. Views react to user input, and often call
<a href="#brokers">Broker</a> methods to determine where the user should be sent after a successful form submission. Screen
level views are rendered by the <a href="https://github.com/mozilla/fxa/blob/main/packages/fxa-content-server/app/scripts/views/app.js">AppView</a>. See <a href="#view-deepdive">View Deepdive</a> for more info.</p>
<h3><a class="anchor" aria-hidden="true" id="templates"></a><a href="#templates" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Templates</h3>
<p>A <a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-content-server/app/scripts/templates">template</a> is a serialized HTML representation of a View. A view renders a template using data available to it and writes the rendered template to the DOM. Templates use the <a href="http://mustache.github.io/">mustache</a> template library.</p>
<h3><a class="anchor" aria-hidden="true" id="clients"></a><a href="#clients" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Clients</h3>
<p>Communication with external servers are done via client libraries.</p>
<h4><a class="anchor" aria-hidden="true" id="fxa-js-client"></a><a href="#fxa-js-client" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>fxa-js-client</h4>
<p>The <a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-js-client">fxa-js-client</a> communicates with the Firefox Accounts <a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-auth-server/">Auth Server</a>. The fxa-js-client is used for all aspects of authenticating a user - sign up, sign in, password reset, etc.</p>
<h4><a class="anchor" aria-hidden="true" id="oauth-client"></a><a href="#oauth-client" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>oauth-client</h4>
<p>The <a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-content-server/app/scripts/lib/oauth-client.js">oauth-client</a> used to communicate with the Firefox Accounts OAuth Server and now communicates with the OAuth endpoints on the Auth server. The OAuth client is used to fetch OAuth codes and tokens to send to the RP.</p>
<h4><a class="anchor" aria-hidden="true" id="profile-clienthttpsgithubcommozillafxatreemainpackagesfxa-content-serverappscriptslibprofile-clientjs"></a><a href="#profile-clienthttpsgithubcommozillafxatreemainpackagesfxa-content-serverappscriptslibprofile-clientjs" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-content-server/app/scripts/lib/profile-client.js">profile-client</a></h4>
<p>The profile-client communicates with the Firefox Accounts <a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-profile-server/">Profile Server</a>. This client allows a user to interact with their profile data.</p>
<h2><a class="anchor" aria-hidden="true" id="application-lifecycle"></a><a href="#application-lifecycle" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Application lifecycle</h2>
<p>When the application starts, <a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-content-server/app/scripts/lib/app-start.js">app-start.js</a> takes care of setting up system-wide dependencies. app-start immediately determines the integration type and creates the appropriate <a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-content-server/blob/8561ec3c1d06763f454f4ac7cb8ef142eb0c01b0/app/scripts/lib/app-start.js#L234">Broker</a> and <a href="https://github.com/mozilla/fxa/tree/main/packages/fxa-content-server/blob/8561ec3c1d06763f454f4ac7cb8ef142eb0c01b0/app/scripts/lib/app-start.js#L199">Relier</a>. The broker is queried to check support of the current integration. If the integration is supported, other models and the <a href="https://github.com/mozilla/qfxa/tree/main/packages/fxa-content-server/blob/8561ec3c1d06763f454f4ac7cb8ef142eb0c01b0/app/scripts/lib/app-start.js#L315">router</a> are created. The router takes over and determines the initial View to display based on the browser's URL. The router creates the View, which in turn writes a template to the DOM. The user interacts with the View, either by filling out a form or clicking on links and buttons. A view can communicate with external servers using clients or via an Account model. Views usually invoke broker methods to determine next steps, which could be to redirect to another view, display a status message, or stop. Upon successful authentication with Firefox Accounts, the broker is notified, which in turn notifies a RP. The RP is responsible for the final fate of the Firefox Accounts tab. In the case of OAuth redirect, FxA redirects to the RP. In the case of Sync or a WebExtension, the tab may be closed automatically, or the user may have to close the tab themselves.</p>
<h2><a class="anchor" aria-hidden="true" id="view-deepdive"></a><a href="#view-deepdive" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>View Deepdive</h2>
<p>View take care of all things UI. Each view has access to several models and libraries, the most commonly used are:</p>
<ul>
<li><a href="#brokers">Broker</a> (this.broker)</li>
<li><a href="#reliers">Relier</a> (this.relier)</li>
<li><a href="#user">User</a> (this.user)</li>
</ul>
<p>Even though React wasn't a thing, FxA views have their own lifecylce methods
for <a href="#render-lifecycle-metohds">rendering</a> and <a href="#submit-lifecycle-methods">form submission</a>.</p>
<h3><a class="anchor" aria-hidden="true" id="baseview"></a><a href="#baseview" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>BaseView</h3>
<p><a href="https://github.com/mozilla/fxa/blob/main/packages/fxa-content-server/app/scripts/views/base.js">BaseView</a> is the parent of all Views. BaseView is responsible for rendering deciding whether to render a view, and if so, for rendering. BaseView also takes care of status messages, hooking up DOM events, <a href="#l10n">l10n</a>, and logging. BaseView does <em>not</em> take care of any form handling, for that, see <a href="#formview">FormView</a>.</p>
<h3><a class="anchor" aria-hidden="true" id="rendering-templates"></a><a href="#rendering-templates" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Rendering templates</h3>
<h4><a class="anchor" aria-hidden="true" id="setinitialcontext"></a><a href="#setinitialcontext" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>setInitialContext</h4>
<p><code>setInitialContext</code> is used to pass data to the Mustache template and is often overridden:</p>
<pre><code class="hljs css language-js">...
setInitialContext(context) {
  context.set({
    <span class="hljs-attr">email</span>: <span class="hljs-keyword">this</span>.getAccount().get(<span class="hljs-string">'email'</span>)
  });
},
...
</code></pre>
<h4><a class="anchor" aria-hidden="true" id="render-lifecycle-methods"></a><a href="#render-lifecycle-methods" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Render lifecycle methods</h4>
<table>
<thead>
<tr><th>method name</th><th>purpose</th></tr>
</thead>
<tbody>
<tr><td>beforeRender</td><td>Called before <code>renderTemplate</code>, can return a promise. If resolves to <code>false</code>, rendering is aborted, can be used to redirect a user to a different screen if pre-conditions are not met.</td></tr>
<tr><td>renderTemplate</td><td>Renders the template with <a href="#setinitialcontext">context</a>. Rarely overridden.</td></tr>
<tr><td>afterRender</td><td>Called after <code>renderTemplate</code>, can return a promise. If resolves to <code>false</code>, view is not displayed, can be used to redirect a user to a different screen if pre-conditions are not met. Often used by mixins to initialize based on elements in view.$el before being added to the DOM.</td></tr>
<tr><td>afterVisible</td><td>Called after a screen has been added to the DOM.</td></tr>
</tbody>
</table>
<h3><a class="anchor" aria-hidden="true" id="formview"></a><a href="#formview" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>FormView</h3>
<p>Extend from <a href="https://github.com/mozilla/fxa/blob/5c527d8007c416b2f6122d8081f7756f8bc6733b/packages/fxa-content-server/app/scripts/views/form.js#L1">FormView</a> for any Views that contain a form that can be submit.
FormView takes care of several aspects of form submission:</p>
<ul>
<li>Ensure only one form submission can be in flight at a time</li>
<li>Form validation</li>
<li>Print submit error messages</li>
</ul>
<h4><a class="anchor" aria-hidden="true" id="submit-lifecycle-methods"></a><a href="#submit-lifecycle-methods" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Submit lifecycle methods</h4>
<table>
<thead>
<tr><th>method name</th><th>purpose</th></tr>
</thead>
<tbody>
<tr><td>isValidStart</td><td>Perform validation before individual input elements are validated. Return <code>false</code> to indicate form is invalid.</td></tr>
<tr><td>isValidEnd</td><td>Perform validation after individual input elements are validated. Return <code>false</code> to indicate form is invalid.</td></tr>
<tr><td>showValidationErrorsStart</td><td>Show validation errors before individual invalid input elements add their tooltips. If a truthy value is returned, no other validation errors are displayed.</td></tr>
<tr><td>showValidationErrorsEnd</td><td>Show validation errors after individual invalid input elements add their tooltips.</td></tr>
<tr><td>beforeSubmit</td><td>Called if form is valid, before <code>submit</code>. Can return a promise. Resolve to <code>false</code> to prevent <code>submit</code> from being called.</td></tr>
<tr><td>submit</td><td><strong>MUST BE OVERRIDDEN</strong> Do the form submission. Can return a promise. If promise rejects, the error will be displayed as an error message.</td></tr>
<tr><td>afterSubmit</td><td>Called after the <code>submit</code>. Can be used for cleanup housekeeping.</td></tr>
</tbody>
</table>
<h4><a class="anchor" aria-hidden="true" id="showing-validation-errors"></a><a href="#showing-validation-errors" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Showing validation errors</h4>
<p>The <a href="https://github.com/mozilla/fxa/blob/5c527d8007c416b2f6122d8081f7756f8bc6733b/packages/fxa-content-server/app/scripts/views/form.js#L379">showValidationError</a> method is used to show validation errors on an individual input element, this is most commonly done in <code>showValidationErrorsStart</code> or <code>showValidationErrorsEnd</code>.</p>
<h3><a class="anchor" aria-hidden="true" id="mixins"></a><a href="#mixins" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Mixins</h3>
<p>The content server front-end relies heavily on <a href="https://github.com/onsi/cocktail">Cocktail based mixins</a>. Mixins enable code extraction into standalone modules that are &quot;mixed into&quot; other modules. Mixins have several purposes within FxA:</p>
<ol>
<li>Share functionality across modules without relying on inheritance.</li>
<li>Isolate experiment code. If the experiment is deemed a failure,
removing the experiment means removing the mixin rather than updating core View logic.</li>
<li>Isolate related tasks to simplify reasoning.</li>
</ol>
<p>Method name collision between a mixin and a mixed-in View is allowed and frequently used, understanding <a href="https://github.com/onsi/cocktail#but-what-about-collisions">Cocktail's collision handling</a> is important to avoid any surprises, especially
relating to return values.</p>
<h3><a class="anchor" aria-hidden="true" id="screen-screen-navigation"></a><a href="#screen-screen-navigation" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>screen-&gt;screen navigation</h3>
<pre><code class="hljs css language-js"><span class="hljs-keyword">this</span>.navigate(<span class="hljs-string">'confirm_signin'</span>, {
  <span class="hljs-comment">// fields here are passed to the next view</span>
  <span class="hljs-attr">account</span>: <span class="hljs-keyword">this</span>.getAccount(),
});
</code></pre>
<p>The <code>confirm_signin</code> view can access the data passed from the previous view:</p>
<pre><code class="hljs css language-js"><span class="hljs-keyword">const</span> account = <span class="hljs-keyword">this</span>.model.get(<span class="hljs-string">'account'</span>);
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="more-useful-info"></a><a href="#more-useful-info" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>More useful info</h2>
<h3><a class="anchor" aria-hidden="true" id="adding-a-new-route"></a><a href="#adding-a-new-route" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Adding a new route</h3>
<ol>
<li>Create a new View module if needed</li>
<li>Add a <a href="https://github.com/mozilla/fxa/blob/5c527d8007c416b2f6122d8081f7756f8bc6733b/packages/fxa-content-server/app/scripts/lib/router.js#L98">route entry to the frontend</a></li>
<li>Add a <a href="https://github.com/mozilla/fxa/blob/5c527d8007c416b2f6122d8081f7756f8bc6733b/packages/fxa-content-server/server/lib/routes/get-frontend.js#L8">route entry to the backend</a></li>
<li>Add a <a href="https://github.com/mozilla/fxa/blob/5c527d8007c416b2f6122d8081f7756f8bc6733b/packages/fxa-content-server/tests/server/routes.js#L28">test to ensure the new route responds with a 200</a></li>
<li>Add some functional tests</li>
</ol>
<h3><a class="anchor" aria-hidden="true" id="server-errors-and-error-messages"></a><a href="#server-errors-and-error-messages" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Server errors and error messages</h3>
<p>Any time a new error is added <a href="https://github.com/mozilla/fxa/blob/82553801812397f6fdbbbb748580ee8319a0a542/packages/fxa-auth-server/lib/error.js#L12">to the auth-server</a>, a corresponding entry needs to be added <a href="https://github.com/mozilla/fxa/blob/82553801812397f6fdbbbb748580ee8319a0a542/packages/fxa-content-server/app/scripts/lib/auth-errors.js#L28">to the content server</a> to ensure the error text
is translated.</p>
<p>Error messages can be customized depending if it makes sense for a particular context by setting the
<code>forceMessage</code> property on an error before display. See <a href="https://github.com/mozilla/fxa/blob/82553801812397f6fdbbbb748580ee8319a0a542/packages/fxa-content-server/app/scripts/views/mixins/signin-mixin.js#L135:L141">this example</a>.</p>
<h3><a class="anchor" aria-hidden="true" id="closing-fxa-and-metrics-aka---missing-metrics"></a><a href="#closing-fxa-and-metrics-aka---missing-metrics" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Closing FxA and metrics (aka - missing metrics)</h3>
<p>When redirecting to an external site, e.g., an OAuth RP, the content server makes its best attempt
at flushing metrics in an <a href="https://github.com/mozilla/fxa/blob/82553801812397f6fdbbbb748580ee8319a0a542/packages/fxa-content-server/app/scripts/lib/metrics.js#L192"><code>unload</code> handler</a>. The problem with depending on <code>unload</code> handlers
is this only works <em>some of the time</em>. The <code>unload</code> handler is ignored on iOS, so we have to
ensure metrics are flushed before a redirect happens.</p>
<p>A common problem is setting <code>navigator.location.href = url</code> from within view code without first
flushing metrics. Instead of setting <code>location.href</code>, call <code>this.navigateAway</code> which will ensure
A common problem is setting <code>navigator.location.href = url</code> from within view code.
metrics are flushed. <code>href</code>s from anchor elements are automatically handled by the
<a href="https://github.com/mozilla/fxa/blob/main/packages/fxa-content-server/app/scripts/views/mixins/external-links-mixin.js">ExternalLinksMixin</a>.</p>
<h3><a class="anchor" aria-hidden="true" id="user-data-stored-on-device"></a><a href="#user-data-stored-on-device" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>User data stored on device</h3>
<p>Some user data is stored in localStorage to smooth out repeated auth requests and ensure consistent
experiment choices across users.</p>
<p>All FxA related information is keyed with a <code>__fxa_storage.</code> prefix.</p>
<p>Account data of all users is located under <code>__fxa_storage.accounts</code>. The entry
is an object where the keys are account UIDs and the values are serialized account
data.</p>
<p>In environments that support the <code>fxaccounts:fxa_status</code> WebChannel message,
account data stored in localStorage is merged with the <code>signedInUser</code> field
of the <code>fxaccounts:fxa_status</code> response.</p>
<h3><a class="anchor" aria-hidden="true" id="keeping-tabs-synchronized"></a><a href="#keeping-tabs-synchronized" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Keeping tabs synchronized</h3>
<p>If multiple FxA tabs are open, we try to keep tab signin state synchronized as much
as possible. Whenever the user signs in or out, <a href="https://developer.mozilla.org/docs/Web/API/BroadcastChannel">BroadcastChannel</a>
messages are sent to all other FxA tabs. Whenever another tab receives a message, it responds
appropriately.</p>
<h3><a class="anchor" aria-hidden="true" id="l10n"></a><a href="#l10n" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>l10n</h3>
<p>See <a href="./fxa-localization">L10n in the content and auth servers</a>.</p>
<h2><a class="anchor" aria-hidden="true" id="settings"></a><a href="#settings" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Settings</h2>
<p>Settings is a mess. Run away. <a href="#converting-to-react">Rewrite this in React</a>.</p>
<h2><a class="anchor" aria-hidden="true" id="converting-to-react"></a><a href="#converting-to-react" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Converting to react</h2>
<p>There have been rumblings of &quot;let's rewrite the whole thing in React!&quot;, from me included (Shane). Stepping back,
a <em>lot</em> of blood, sweat, and tears went into creating the content server, and a <em>lot</em> of non-obvious gotchas were
solved. I'm not against a big rewrite, but doing so needs to be done with eyes wide open. It's going to be hard and
require multiple man-quarters to complete.</p>
<p>Conversion to React would primarily clean up the Views, however, Views are only one aspect of the the content-server's
duties. Much more challenging than the Views are screen-&gt;screen transitions depending on the integration type, and
handling the myriad <a href="#relying-party-integrations">integration types</a>.</p>
<p>I think a phased approach is possible:</p>
<ul>
<li>Start with settings, split it off as a standalone app. Even this will be a challenge because settings
has many distinct sub-panels and challenging behaviors. However, settings will allow us to learn how to do:
<ul>
<li>query param validation</li>
<li>session handling</li>
<li>account management</li>
<li>form submission and input validation</li>
<li>communication with the browser</li>
<li>l10n</li>
</ul></li>
<li>Maybe the password reset flow next since it is fairly self contained.</li>
<li>Then maybe the signin/signup flows.</li>
</ul>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/ecosystem-platform/docs/fxa-engineering/functional-testing"><span class="arrow-prev">← </span><span>Functional/Selenium Tests</span></a><a class="docs-next button" href="/ecosystem-platform/docs/process/interruptive-surveys"><span class="function-name-prevnext">Running Surveys in FxA</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#document-purpose">Document purpose</a></li><li><a href="#helpful-to-know-before-starting">Helpful to know before starting</a><ul class="toc-headings"><li><a href="#relying-party-integrations">Relying Party Integrations</a></li></ul></li><li><a href="#content-server-architecture-basics">Content server architecture basics</a></li><li><a href="#high-level-web-client-components">High Level Web Client Components</a><ul class="toc-headings"><li><a href="#auth-brokers">Auth-Brokers</a></li><li><a href="#channels">Channels</a></li><li><a href="#reliers">Reliers</a></li><li><a href="#user">User</a></li><li><a href="#account">Account</a></li><li><a href="#router">Router</a></li><li><a href="#views">Views</a></li><li><a href="#templates">Templates</a></li><li><a href="#clients">Clients</a></li></ul></li><li><a href="#application-lifecycle">Application lifecycle</a></li><li><a href="#view-deepdive">View Deepdive</a><ul class="toc-headings"><li><a href="#baseview">BaseView</a></li><li><a href="#rendering-templates">Rendering templates</a></li><li><a href="#formview">FormView</a></li><li><a href="#mixins">Mixins</a></li><li><a href="#screen-screen-navigation">screen-&gt;screen navigation</a></li></ul></li><li><a href="#more-useful-info">More useful info</a><ul class="toc-headings"><li><a href="#adding-a-new-route">Adding a new route</a></li><li><a href="#server-errors-and-error-messages">Server errors and error messages</a></li><li><a href="#closing-fxa-and-metrics-aka---missing-metrics">Closing FxA and metrics (aka - missing metrics)</a></li><li><a href="#user-data-stored-on-device">User data stored on device</a></li><li><a href="#keeping-tabs-synchronized">Keeping tabs synchronized</a></li><li><a href="#l10n">l10n</a></li></ul></li><li><a href="#settings">Settings</a></li><li><a href="#converting-to-react">Converting to react</a></li></ul></nav></div><footer><img src="/ecosystem-platform/img/mozilla-logo.png" height="24"/><script src="https://unpkg.com/mermaid@8.4.2/dist/mermaid.min.js" type="application/javascript"></script><script>
        mermaid.initialize({
            startOnReady: true,
            theme: 'forest',
            themeCSS: '.noteText { font-family: monospace; }'
          });
        // remarkable converts the mermaid diagrams to HTML and injects a bunch
        // of HTML tags the mermaid parser cannot handle. Remove the HTML and
        // run the parser on the original text.
        const mermaidDiagramEls = document.querySelectorAll('.language-mermaid');
        mermaidDiagramEls.forEach(function(diagramEl, index) {
          // strip out any HTML
          diagramEl.innerHTML = diagramEl.innerText;
          diagramEl.addEventListener('click', (evt) => {
            evt.currentTarget.classList.toggle('highlight');
            document.body.classList.toggle('highlight-service');
          }, false);
        });
        mermaid.init(undefined, mermaidDiagramEls);
        </script></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: 'bf6d9655ef3d5789d97465aff250ee76',
                indexName: 'mozilla_ecosystem-platform',
                inputSelector: '#search_input_react'
              });
            </script></body></html>