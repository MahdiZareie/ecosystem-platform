<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<link rel="search" type="application/opensearchdescription+xml" title="Firefox Ecosystem Platform" href="/ecosystem-platform/opensearch.xml"><title data-react-helmet="true">How does FxA process email? | Firefox Ecosystem Platform</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://mozilla.github.io/ecosystem-platform/reference/how-does-fxa-process-email"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="How does FxA process email? | Firefox Ecosystem Platform"><meta data-react-helmet="true" name="description" content="Current as of October 7th, 2019"><meta data-react-helmet="true" property="og:description" content="Current as of October 7th, 2019"><link data-react-helmet="true" rel="icon" href="/ecosystem-platform/img/firefox-logo.png"><link data-react-helmet="true" rel="canonical" href="https://mozilla.github.io/ecosystem-platform/reference/how-does-fxa-process-email"><link data-react-helmet="true" rel="alternate" href="https://mozilla.github.io/ecosystem-platform/reference/how-does-fxa-process-email" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://mozilla.github.io/ecosystem-platform/reference/how-does-fxa-process-email" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://RFM5H13DFK-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/ecosystem-platform/assets/css/styles.9f158ee2.css">
<link rel="preload" href="/ecosystem-platform/assets/js/runtime~main.fad28cb3.js" as="script">
<link rel="preload" href="/ecosystem-platform/assets/js/main.ea289097.js" as="script">
</head>
<body>
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/ecosystem-platform/"><div class="navbar__logo"><img src="/ecosystem-platform/img/firefox-logo.png" alt="Ecosystem Platform Logo" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/ecosystem-platform/img/firefox-logo.png" alt="Ecosystem Platform Logo" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">Firefox Ecosystem Platform</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/mozilla/ecosystem-platform" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="searchBox_Utm0"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/ecosystem-platform/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menuLinkText_OKON">For Relying Parties</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" tabindex="0" href="/ecosystem-platform/relying-parties/tutorials/integration-with-fxa">Tutorials</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" tabindex="0" href="/ecosystem-platform/relying-parties/how-twos/end-to-end-encryption">How-to Guides</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" tabindex="0" href="/ecosystem-platform/relying-parties/reference/metrics-for-relying-parties">Reference</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active menuLinkText_OKON">For FxA Engineers</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" tabindex="0" href="/ecosystem-platform/tutorials/development-setup">Tutorials</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" tabindex="0" href="/ecosystem-platform/how-tos/creating-an-account-locally">How-to Guides</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_TwRn" tabindex="0" href="/ecosystem-platform/reference/team-processes/development-process">Reference</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" tabindex="0" href="/ecosystem-platform/reference/team-processes/development-process">Team Processes</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/browser-support">Browser Support</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/incident-response">Incident Response</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/ecosystem-platform/reference/how-does-fxa-process-email">How does FxA process email?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/localization">Localization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/metrics">Metrics</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/token-types">Types of Auth Tokens</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/jwt-access-tokens">JWT Access Tokens</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/storybook-deploys-with-circleci">Storybook Deploys with CircleCI</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/webchannels-in-firefox-desktop-fennec">WebChannels in Firefox Desktop &amp; Fennec</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/webchannels-in-fenix-webextensions">WebChannels in Fenix &amp; WebExtensions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/tests-in-circleci">Tests in CircleCI</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/functional-testing">Functional Tests</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/automation-testplan">Automation Test Plan</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/internal-api-documentation">Internal API Documentation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/experiments-ab-testing">Experiments &amp; A/B Testing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/interruptive-surveys">Interruptive Surveys</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/system-diagrams">System Diagrams</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/application-logging">Application Logging</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/scheduled-maintenance">Scheduled Maintenance</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/mobile-specifics">Mobile Specifics</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/architectural-decision-records">Architectural Decision Records</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/reference/github-strategies">GitHub Strategies</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a href="https://docs.telemetry.mozilla.org/datasets/fxa.html" target="_blank" rel="noopener noreferrer" class="menu__link" tabindex="0"><span>Telemetry Data Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" tabindex="0" href="/ecosystem-platform/explanation/onepw-protocol">Explanation</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/additional-docs">Additional Docs</a></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_eoK2"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_e+kA"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>How does FxA process email?</h1></header><p>Current as of <code>October 7th, 2019</code></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="fxa-auth-server">fxa-auth-server<a class="hash-link" href="#fxa-auth-server" title="Direct link to heading">​</a></h2><p>All of the code for sending email lives in the auth server.</p><p>Emails are sent by calling methods on the mailer object that is passed around the codebase. The methods are defined by a reducer in <code>lib/senders/index.js</code> and have names like <code>sendVerifyEmail</code>, <code>sendNewDeviceLoginEmail</code> and <code>sendPasswordResetEmail</code>, but those are really just thin wrappers that do a little bit of argument marshalling before handing off to other methods that actually do the work. Those are defined in <code>lib/senders/email.js</code> and don’t have send in the name, so <code>verifyEmail</code>, <code>newDeviceLoginEmail</code> and <code>passwordResetEmail</code> would be counterparts to the above. Ultimately each of these methods calls <code>send</code>, which in turn calls the nuts-and-bolts methods <code>localize</code>, <code>render</code>, <code>selectEmailServices</code> and <code>sendMail</code>.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="templates">Templates<a class="hash-link" href="#templates" title="Direct link to heading">​</a></h2><p>The templates are written using handlebars syntax and live under <code>lib/senders/templates</code>. Directly in that directory you’ll see templates with names corresponding to the mail-sending methods mentioned above, in HTML and plain text versions. There is also code for rendering the templates in <code>index.js</code>, template versions for metrics in <code>_versions.json</code> and any pending strings for L10n in <code>_pending.txt</code>.</p><p>There are also two subdirectories, layouts and partials:</p><ul><li>The templates in <code>layouts</code> contain outer scaffolding that’s common across emails. For the HTML emails that includes stuff like metadata, header logo and smallprint in the footer. For the plain text emails it’s just the standard footer text. Layout names are specified in the call to <code>render</code>.</li><li>The templates in <code>partials</code> contain reusable components that are common to many emails. They’re included inline using the handlebars <code>{{&gt; partialName}}</code> syntax.</li></ul><h2 class="anchor anchorWithStickyNavbar_y2LR" id="localization-l10n">Localization (L10n)<a class="hash-link" href="#localization-l10n" title="Direct link to heading">​</a></h2><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>See also <a href="/ecosystem-platform/reference/localization">this deep dive on Localization</a>.</p></div></div><p>There is more detailed documentation about localization elsewhere. For the scope of this document though if will suffice to say that there is a grunt task called <code>l10n-extract</code> which is run as part of our L10n automation. It extracts strings from templates by looking for the <code>{{t &quot;this string needs translating&quot;}}</code> syntax and from JS code by looking for the <code>gettext(&#x27;this string needs translating&#x27;)</code> syntax.  Stuff like the email subject and variable data for partials will be in the JS code.</p><p>Bear in mind that occasionally we need to bump the parser version that’s used for the JS code, e.g. when we start using some super-duper newfangled JS features. That’s done in <code>grunttasks/l10n-extract.js</code>.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="bounces-and-complaints">Bounces and complaints<a class="hash-link" href="#bounces-and-complaints" title="Direct link to heading">​</a></h2><p><a href="https://docs.aws.amazon.com/ses/latest/dg/notification-contents.html" target="_blank" rel="noopener noreferrer">SES delivery, bounce and complaint notifications</a> are published to SQS queues. As well as emitting metrics (see below), we also store bounce records in the auth db whenever a bounce or complaint occurs. The email service then checks those records against thresholds defined in the config and if any thresholds are violated, sending will fail.</p><p>The bounce and complaint handling code is in <code>lib/email/bounces.js</code> but long-term we want to migrate to the email service’s implementation instead, which was written some time ago but has not been deployed yet. The motivation for moving is partly semantic, because bounce records don’t really belong in the auth db, but also security, because the email service should not need access to the auth db.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="metrics">Metrics<a class="hash-link" href="#metrics" title="Direct link to heading">​</a></h2><p>We emit metrics when emails are sent, delivered and when they bounce or complaints are received. A regrettable decision was made to treat complaints as a type of bounce when the metrics were first implemented, which means some of the numbers are unintuitive. Specifically, you might expect that <code>count sent = count delivered + count bounced</code>. That’s not true. Instead, <code>count sent = count delivered + count bounced - count complained</code>.</p><p>The metrics code is slightly confusing because, as mentioned in the previous section, we haven’t finished migrating to the email service yet. That means there’s metrics code we’re using right now and other stuff we’re not using yet, which is waiting for the email service deployment.</p><p>The stuff we’re using right now is in <code>lib/email/delivery.js</code> and <code>lib/email/bounces.js</code>. These modules receive events directly from SES and should be pretty straightforward to understand.</p><p>The stuff we’re not using yet is in <code>lib/email/notifications.js</code>, which receives events from the email service (using the same format as SES for consistency). That queue won’t receive any events until the above-linked PR is deployed. The story behind it is we want to keep the metrics code in the auth server, even though bounce and complaint handling is moving away.</p><p>The two handlers are designed to co-exist, so it’s fine for them both to be in operation when the email service stuff gets deployed, they’ll just compete for events without duplicating any metrics or whatever. When we’re happy that the email service is behaving correctly, we should remove the old SQS handlers from the auth server.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="tests">Tests<a class="hash-link" href="#tests" title="Direct link to heading">​</a></h2><p>Historically the email tests have been a burden to maintain because there’s so many of them, and it’s easy for such a large volume of tests to obscure the presence of bugs.</p><p>The main test cases are in <code>test/local/senders/email.js</code>, declared as data in maps called <code>TESTS</code> and <code>COMMON_TESTS</code>. Taking a declarative approach like this made it easier to get a feel for the test coverage and spot gaps in it. It also ensured we had common test cases that are applied to every email, e.g. we can make sure there are no HTML character entities in the plain text emails and that required headers are always set.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="bulk-mailer">Bulk mailer<a class="hash-link" href="#bulk-mailer" title="Direct link to heading">​</a></h2><p>There have been unfortunate occasions in the past where it became necessary to manually send email out to large subsets of our user base. Shane wrote a script that does this, <code>scripts/bulk-mailer.js</code>. Run <code>node scripts/bulk-mailer --help</code> to see usage information.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="how-do-i">How do I…<a class="hash-link" href="#how-do-i" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="change-an-existing-template">...change an existing template?<a class="hash-link" href="#change-an-existing-template" title="Direct link to heading">​</a></h3><ol start="0"><li>Find the template you want to change in <code>lib/senders/templates</code>.</li><li>Make sure you update both the HTML and plain text forms of your template.</li><li>If you need to make changes in <code>layouts</code> or <code>partials</code>, ensure you don’t break other templates.</li><li>Change or add test data in <code>TESTS</code> in <code>test/local/senders/email.js</code>.</li><li>Bump the template version(s) in <code>lib/senders/templates/_versions.json</code>, so that metrics can attribute any changes to the template change.</li><li>If you’re changing strings, make sure you’ve made the cut for L10n. If you want to avoid missing the cut, land strings ahead of time in <code>lib/senders/templates/_pending.txt</code>.</li></ol><h3 class="anchor anchorWithStickyNavbar_y2LR" id="add-a-new-template">...add a new template?<a class="hash-link" href="#add-a-new-template" title="Direct link to heading">​</a></h3><ol start="0"><li>Add HTML and plain text copies in <code>lib/senders/templates</code>.</li><li>Add a version property to <code>lib/senders/templates/_versions.json</code>. Set it to 1.</li><li>Add a corresponding method to <code>lib/senders/email.js</code>. Make sure that method calls send with the subject and any template data you need.</li><li>Invoke your method from the code as <code>mailer.send...Email</code>.</li><li>Add new test data to <code>TESTS</code> in <code>test/local/senders/email.js</code>.</li></ol><h3 class="anchor anchorWithStickyNavbar_y2LR" id="change-an-email-subject">...change an email subject?<a class="hash-link" href="#change-an-email-subject" title="Direct link to heading">​</a></h3><ol start="0"><li>Make the change in the relevant method in <code>lib/senders/email.js</code>.</li><li>Make sure the string is wrapped inside a call to gettext, so that the L10n automation can translate it.</li><li>Update the test data in <code>TESTS</code> in <code>test/local/senders/email.js</code>.</li></ol><h3 class="anchor anchorWithStickyNavbar_y2LR" id="view-rendered-templates-locally">...view rendered templates locally?<a class="hash-link" href="#view-rendered-templates-locally" title="Direct link to heading">​</a></h3><ol start="0"><li>Run <code>node scripts/write-emails-to-disk</code> all then open the <code>.mail_output</code> directory in your browser. A rendered copy of every template will be there.</li><li>Note this is not a substitute for testing changes in a real mail client. Email rendering is famously unreliable.</li></ol></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/mozilla/ecosystem-platform/edit/master/docs/reference/how-does-fxa-process-email.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_mt2f"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/ecosystem-platform/reference/incident-response"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Incident Response</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/ecosystem-platform/reference/localization"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Localization</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#fxa-auth-server" class="table-of-contents__link toc-highlight">fxa-auth-server</a></li><li><a href="#templates" class="table-of-contents__link toc-highlight">Templates</a></li><li><a href="#localization-l10n" class="table-of-contents__link toc-highlight">Localization (L10n)</a></li><li><a href="#bounces-and-complaints" class="table-of-contents__link toc-highlight">Bounces and complaints</a></li><li><a href="#metrics" class="table-of-contents__link toc-highlight">Metrics</a></li><li><a href="#tests" class="table-of-contents__link toc-highlight">Tests</a></li><li><a href="#bulk-mailer" class="table-of-contents__link toc-highlight">Bulk mailer</a></li><li><a href="#how-do-i" class="table-of-contents__link toc-highlight">How do I…</a><ul><li><a href="#change-an-existing-template" class="table-of-contents__link toc-highlight">...change an existing template?</a></li><li><a href="#add-a-new-template" class="table-of-contents__link toc-highlight">...add a new template?</a></li><li><a href="#change-an-email-subject" class="table-of-contents__link toc-highlight">...change an email subject?</a></li><li><a href="#view-rendered-templates-locally" class="table-of-contents__link toc-highlight">...view rendered templates locally?</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Mozilla Corporation.</div></div></div></footer></div>
<script src="/ecosystem-platform/assets/js/runtime~main.fad28cb3.js"></script>
<script src="/ecosystem-platform/assets/js/main.ea289097.js"></script>
</body>
</html>