<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="search" type="application/opensearchdescription+xml" title="Firefox Ecosystem Platform" href="/ecosystem-platform/opensearch.xml"><title data-react-helmet="true">Session Tokens | Firefox Ecosystem Platform</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://mozilla.github.io/ecosystem-platform/explanation/session-tokens"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Session Tokens | Firefox Ecosystem Platform"><meta data-react-helmet="true" name="description" content="This is a bit of a braindump, but here we are."><meta data-react-helmet="true" property="og:description" content="This is a bit of a braindump, but here we are."><link data-react-helmet="true" rel="shortcut icon" href="/ecosystem-platform/img/firefox-logo.png"><link data-react-helmet="true" rel="canonical" href="https://mozilla.github.io/ecosystem-platform/explanation/session-tokens"><link data-react-helmet="true" rel="alternate" href="https://mozilla.github.io/ecosystem-platform/explanation/session-tokens" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://mozilla.github.io/ecosystem-platform/explanation/session-tokens" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/ecosystem-platform/assets/css/styles.738c8573.css">
<link rel="preload" href="/ecosystem-platform/assets/js/runtime~main.88c4a573.js" as="script">
<link rel="preload" href="/ecosystem-platform/assets/js/main.bf9070c4.js" as="script">
</head>
<body>
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/ecosystem-platform/"><img src="/ecosystem-platform/img/firefox-logo.png" alt="Ecosystem Platform Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/ecosystem-platform/img/firefox-logo.png" alt="Ecosystem Platform Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"><b class="navbar__title">Firefox Ecosystem Platform</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/mozilla/ecosystem-platform" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="searchBox_Bc3W"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button class="clean-btn backToTopButton_i9tI" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh menuWithAnnouncementBar_+O1J"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/ecosystem-platform/">Introduction</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menuLinkText_OKON">For Relying Parties</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Firefox Accounts</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Subscription Platform</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menuLinkText_OKON">For FxA Engineers</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Tutorials</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">How-to Guides</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Reference</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">Explanation</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/explanation/onepw-protocol">onepw Protocol</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/explanation/scoped-keys">Scoped Keys</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/explanation/content-server-architecture">Content-server architecture</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/ecosystem-platform/explanation/session-tokens">Session Tokens</a></li></ul></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/ecosystem-platform/additional-docs">Additional Docs</a></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_eoK2"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_e+kA"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="theme-doc-markdown markdown"><header><h1>FxA Session Tokens</h1></header><p><em>This is a bit of a braindump, but here we are.</em></p><p>Initially, session tokens were just stored in MySQL with everything else. As part of some work to enable the device manager, we added columns for parsed user-agent info and last-access time, along with a new stored procedure to update a token:</p><ul><li><a href="https://github.com/mozilla/fxa-auth-db-mysql/pull/65" target="_blank" rel="noopener noreferrer">https://github.com/mozilla/fxa-auth-db-mysql/pull/65</a></li><li><a href="https://github.com/mozilla/fxa-auth-server/pull/997" target="_blank" rel="noopener noreferrer">https://github.com/mozilla/fxa-auth-server/pull/997</a></li></ul><p>However, when we turned it on in prod it caused a significant increase in write IOPS and it had to be backed out:</p><ul><li><a href="https://github.com/mozilla/fxa-auth-server/pull/1169" target="_blank" rel="noopener noreferrer">https://github.com/mozilla/fxa-auth-server/pull/1169</a></li><li><a href="https://github.com/mozilla/fxa-auth-server/pull/1171" target="_blank" rel="noopener noreferrer">https://github.com/mozilla/fxa-auth-server/pull/1171</a></li></ul><p>So, the decision was taken to move just the new properties into Redis and then aggregate tokens from the two data stores when reading them out:</p><ul><li><a href="https://github.com/mozilla/fxa-auth-server/pull/1968" target="_blank" rel="noopener noreferrer">https://github.com/mozilla/fxa-auth-server/pull/1968</a></li></ul><p>Later, the size of our Redis instance became a growing concern and we did some work to reduce it by removing property keys and by pruning old tokens:</p><ul><li><a href="https://github.com/mozilla/fxa-auth-server/pull/2254" target="_blank" rel="noopener noreferrer">https://github.com/mozilla/fxa-auth-server/pull/2254</a></li><li><a href="https://github.com/mozilla/fxa-auth-server/pull/2257" target="_blank" rel="noopener noreferrer">https://github.com/mozilla/fxa-auth-server/pull/2257</a></li></ul><p>The latter of those two changes mirrored work that we previously did to prune old session tokens from MySQL:</p><ul><li><a href="https://github.com/mozilla/fxa-auth-server/pull/1996" target="_blank" rel="noopener noreferrer">https://github.com/mozilla/fxa-auth-server/pull/1996</a></li><li><a href="https://github.com/mozilla/fxa-auth-db-mysql/pull/282" target="_blank" rel="noopener noreferrer">https://github.com/mozilla/fxa-auth-db-mysql/pull/282</a></li></ul><p>Session tokens in MySQL can be associated with a device record. “Device” is a misleading name here because it really means “Firefox instance”. A true device record would require some kind of reliable fingerprinting mechanism so we could recognise common devices between instances of the browser. When we started tracking metrics for how many devices a user connected, we tried to make accommodations for this by taking into account the operating system details. But in most places in the code, bear in mind that device === browser.</p><p>A session token that has a device record will never be pruned, because that would break Sync. So we only prune tokens if there’s no corresponding device in the db. And we only prune them if they’re more than 4 weeks old.</p><p>Pruning from MySQL happens in one of our regular versioned stored procedures, at the time of writing it’s called <code>prune_7</code>:</p><ul><li>packages/fxa-auth-db-mysql/lib/db/schema/patch-068-069.sql</li></ul><p>There are properties in config that control this called enablePruning, pruneEvery and pruneTokensMaxAge. The code that uses them is near the top of <code>lib/db/mysql.js</code> in the <code>fxa-auth-db-mysql</code> package.</p><p>Pruning from Redis happens opportunistically whenever session tokens are read by calling <code>db.pruneSessionTokens</code>. This method is called automatically on every endpoint that is authenticated by session token, via code inside <code>makeCredentialFn</code> in <code>lib/server.js</code> in the <code>fxa-auth-server</code> package. I just noticed it’s also explicitly called by <code>db.sessions</code> in <code>lib/db.js</code>, which seems unnecessary. Perhaps that is an artifact of some older arrangement, I can’t remember now. We may be able to get rid of it.</p><p>There are also explicit calls to <code>db.deleteSessionTokenFromRedis</code> in all of the places it makes sense to do so. That includes <code>db.createSessionToken</code>, to handle any occurrences where a session token id gets reused and the old session token still had data in Redis.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/mozilla/ecosystem-platform/edit/main/website/docs/explanation/session-tokens.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_mt2f"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/ecosystem-platform/explanation/content-server-architecture"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Content-server architecture</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/ecosystem-platform/additional-docs"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Additional Docs »</div></a></div></nav></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Mozilla Corporation.</div></div></div></footer></div>
<script src="/ecosystem-platform/assets/js/runtime~main.88c4a573.js"></script>
<script src="/ecosystem-platform/assets/js/main.bf9070c4.js"></script>
</body>
</html>